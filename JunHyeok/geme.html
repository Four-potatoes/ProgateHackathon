<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K-Culture Memory Master</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom CSS for Card Flip Effect */
        .perspective {
            perspective: 1000px;
        }
        .transform-style-preserve-3d {
            transform-style: preserve-3d;
        }
        .backface-hidden {
            backface-visibility: hidden;
        }
        .rotate-y-180 {
            transform: rotateY(180deg);
        }
        .card-inner {
            transition: transform 0.5s;
        }
        @keyframes pop-in {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-pop-in {
            animation: pop-in 0.3s ease-out forwards;
        }
    </style>
    <!-- Lucide Icons (Used for the UI/UX experience) -->
    <script type="module">
        // FIX: Import 'icons' and pass it to createIcons for it to work with all available icons.
        import { createIcons, icons } from 'https://cdn.jsdelivr.net/npm/lucide@latest/dist/esm/lucide.js';
        window.addEventListener('load', () => {
            // Pass the icons object as required by the library to initialize all icons on the page.
            createIcons({ icons });
        });
    </script>
</head>
<body class="min-h-screen font-sans bg-gray-50" id="body-container">

    <div id="app" class="min-h-screen">
        <!-- Content will be rendered here by JavaScript -->
        <div class="flex justify-center items-center h-screen bg-pink-50">
            <svg data-lucide="loader-2" class="animate-spin text-indigo-500 w-12 h-12"></svg>
            <p class="ml-4 text-xl text-gray-700">ë¡œë¯¸ ê³µì£¼ê°€ ë§ˆë²•ì„ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤...</p>
        </div>
    </div>

    <!-- Firebase and Application Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, orderBy, limit, onSnapshot, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Initialization and Global Variables ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-kculture-app-id';

        let app, db, auth;
        let currentUserId = null;
        let isAuthReady = false;

        // K-Culture Card Data (8 pairs for a 4x4 grid)
        const K_CULTURE_ITEMS = [
            { name: 'í•œë³µ', icon: 'ğŸ‘˜', desc: 'í•œêµ­ì˜ ì „í†µ ì˜ìƒ.' },
            { name: 'ê¹€ì¹˜', icon: 'ğŸŒ¶ï¸', desc: 'í•œêµ­ì˜ ëŒ€í‘œì ì¸ ë°œíš¨ ìŒì‹.' },
            { name: 'ë¹„ë¹”ë°¥', icon: 'ğŸš', desc: 'ë°¥ ìœ„ì— ë‚˜ë¬¼ì„ ì–¹ì–´ ë¹„ë²¼ ë¨¹ëŠ” ìŒì‹.' },
            { name: 'íƒˆì¶¤', icon: 'ğŸ­', desc: 'íƒˆì„ ì“°ê³  ì¶”ëŠ” ì „í†µ ì—°í¬.' },
            { name: 'íƒœê·¹ê¸°', icon: 'ğŸ‡°ğŸ‡·', desc: 'ëŒ€í•œë¯¼êµ­ì˜ êµ­ê¸°.' },
            { name: 'ê¶ê¶', icon: 'ğŸ¯', desc: 'ì¡°ì„  ì‹œëŒ€ ì™•ì´ ì‚´ë˜ í° ê±´ì¶•ë¬¼.' },
            { name: 'ë¶“ê¸€ì”¨', icon: 'ğŸ–‹ï¸', desc: 'ë¶“ìœ¼ë¡œ ì“°ëŠ” ì„œì˜ˆ.' },
            { name: 'ê°€ì•¼ê¸ˆ', 'icon': 'ğŸ¶', desc: 'í•œêµ­ì˜ ì „í†µ í˜„ì•…ê¸°.' },
        ];

        let CARD_PAIRS;
        let totalPairs;

        // --- Game State Management ---
        let cards = [];
        let flipped = [];
        let matched = [];
        let moves = 0;
        let isWon = false;
        let canClick = true;
        let currentPage = 'game'; // 'game', 'collection', 'ai-learning', 'leaderboard'
        
        const appContainer = document.getElementById('app');

        // --- Utility Functions ---
        const shuffleArray = (array) => {
            let currentIndex = array.length, randomIndex;
            while (currentIndex !== 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [
                    array[randomIndex], array[currentIndex]];
            }
            return array;
        };

        const goToPage = (pageName) => {
            currentPage = pageName;
            render();
            // Re-run icon rendering for newly created DOM elements
            // We use createIcons({ icons }) now, which is defined in the head script.
            // Since we cannot directly access 'icons' here, we rely on the window.onload 
            // script to handle the initial run. For subsequent renders, we just call 
            // createIcons() without arguments which re-renders existing data-lucide elements.
            // This is a common pattern when the icons object is globally available or handled
            // by the initial setup. The error was in the head script itself, which is now fixed.
            // We will remove the redundant check here since the head script handles the icon setup.
            // However, the original code had this check, so we'll keep it for robustness if the new script
            // is re-exported to window.createIcons
            if (window.createIcons) window.createIcons({ icons: window.icons });
        };

        // --- Game Logic ---

        const initializeCardData = () => {
             CARD_PAIRS = [...K_CULTURE_ITEMS, ...K_CULTURE_ITEMS].map((item, index) => ({
                ...item,
                id: index,
            }));
            totalPairs = CARD_PAIRS.length / 2;
        }

        const initializeGame = () => {
            initializeCardData();
            cards = shuffleArray([...CARD_PAIRS]);
            flipped = [];
            matched = [];
            moves = 0;
            isWon = false;
            canClick = true;
            renderGame();
        };

        const checkWinCondition = () => {
            if (matched.length > 0 && matched.length === cards.length) {
                isWon = true;
                submitScore(moves);
                renderGame(); // Re-render to show win modal
            }
        };

        const submitScore = async (finalMoves) => {
            if (!db || !currentUserId) {
                console.error("Database or User ID not ready.");
                return;
            }
            
            const rankingCollectionPath = `artifacts/${appId}/public/data/memory_game_ranking`;
            try {
                await addDoc(collection(db, rankingCollectionPath), {
                    playerUid: currentUserId,
                    moves: finalMoves,
                    timestamp: serverTimestamp(),
                });
                console.log("Score submitted successfully:", finalMoves);
            } catch (error) {
                console.error("Error submitting score:", error);
            }
        };


        const handleCardClick = (cardId) => {
            if (!canClick || flipped.length === 2 || flipped.includes(cardId) || matched.includes(cardId) || isWon) {
                return;
            }

            // Flip the card and update the state visually
            flipped.push(cardId);
            renderGame(); 
            
            if (flipped.length === 2) {
                canClick = false;
                moves++;
                renderGame(); // Update moves count
                
                const [firstId, secondId] = flipped;
                
                const item1 = cards.find(c => c.id === firstId);
                const item2 = cards.find(c => c.id === secondId);

                if (item1 && item2 && item1.name === item2.name) {
                    // Match found
                    matched.push(firstId, secondId);
                    flipped = [];
                    canClick = true;
                    checkWinCondition();
                    renderGame();
                } else {
                    // No match: flip back after delay
                    setTimeout(() => {
                        flipped = [];
                        canClick = true;
                        renderGame(); // Re-render to flip them back
                    }, 1000);
                }
            }
        };

        // --- Renderer Functions ---

        const renderNavButton = (icon, label, page) => `
            <button 
                onclick="window.goToPage('${page}')"
                class="flex items-center space-x-2 bg-purple-500 text-white font-semibold py-2 px-4 rounded-full shadow-md hover:bg-purple-600 transition duration-300 text-sm"
            >
                <svg data-lucide="${icon}" class="w-5 h-5"></svg>
                <span>${label}</span>
            </button>
        `;

        const renderCard = (card) => {
            const isFlipped = flipped.includes(card.id) || matched.includes(card.id);
            const isMatched = matched.includes(card.id);
            const cursorClass = isMatched ? 'cursor-default' : 'cursor-pointer';

            return `
                <div 
                    id="card-${card.id}"
                    class="aspect-square perspective ${cursorClass}"
                    onclick="window.handleCardClick(${card.id})"
                >
                    <div class="relative w-full h-full card-inner transform-style-preserve-3d 
                        ${isFlipped ? 'rotate-y-180' : ''}"
                    >
                        <!-- Card Back (Teenieping Theme) -->
                        <div class="absolute backface-hidden w-full h-full bg-indigo-500 rounded-lg shadow-xl border-4 border-indigo-700 flex items-center justify-center">
                            <svg data-lucide="sparkles" class="w-8 h-8 text-yellow-300 animate-pulse"></svg>
                        </div>
                        
                        <!-- Card Front (K-Culture Content) -->
                        <div class="absolute backface-hidden w-full h-full bg-white rounded-lg shadow-xl border-4 border-green-400 flex flex-col items-center justify-center p-1 md:p-2 rotate-y-180">
                            <span class="text-2xl md:text-4xl">${card.icon}</span>
                            <span class="text-xs md:text-sm font-semibold mt-1 text-gray-800 text-center">${card.name}</span>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderGame = () => {
            const cardGrid = cards.map(renderCard).join('');
            
            let winModal = '';
            if (isWon) {
                winModal = `
                    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div class="bg-white p-8 rounded-2xl shadow-2xl text-center animate-pop-in">
                            <h2 class="text-3xl font-extrabold text-green-600 mb-4">ğŸ‰ ìºì¹˜ ì„±ê³µ! ì¶•í•˜í•©ë‹ˆë‹¤! ğŸ‰</h2>
                            <p class="text-lg text-gray-700 mb-6">ë‹¹ì‹ ì€ <strong>${moves}ë²ˆ</strong> ë§Œì— ëª¨ë“  K-Culture í‹°ë‹ˆí•‘ì„ ìºì¹˜í–ˆìŠµë‹ˆë‹¤.</p>
                            <button 
                                onclick="window.goToPage('leaderboard')"
                                class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transition duration-300 text-lg"
                            >
                                <svg data-lucide="trophy" class="inline w-5 h-5 mr-2"></svg> ë­í‚¹ í™•ì¸ ë° ê¸°ë¡ ë“±ë¡
                            </button>
                        </div>
                    </div>
                `;
            }

            appContainer.innerHTML = `
                <div class="p-4 flex flex-col items-center min-h-screen bg-pink-50">
                    <h1 class="text-4xl font-extrabold text-indigo-600 my-4 tracking-tight">
                        <svg data-lucide="sparkles" class="inline w-6 h-6 mr-2 text-yellow-500"></svg>
                        K-Culture Memory Master
                    </h1>

                    <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-xl mb-6">
                        <div class="flex justify-between items-center mb-4 border-b pb-3">
                            <div class="flex flex-col items-start">
                                <span class="text-xl font-bold text-gray-700">ì‹œë„ íšŸìˆ˜: <span class="text-indigo-500">${moves}</span></span>
                                <span class="text-sm text-gray-500 mt-1">ë‚¨ì€ ìŒ: ${totalPairs - (matched.length / 2)} / ${totalPairs}</span>
                            </div>
                            <button 
                                onclick="window.initializeGame()"
                                class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-full shadow-lg transition duration-300 flex items-center"
                            >
                                <svg data-lucide="rotate-ccw" class="w-4 h-4 mr-1"></svg> ì¬ì‹œì‘
                            </button>
                        </div>

                        <div class="grid grid-cols-4 gap-3 md:gap-4">
                            ${cardGrid}
                        </div>
                    </div>
                    
                    ${winModal}

                    <!-- Navigation Buttons -->
                    <div class="mt-6 flex flex-wrap justify-center gap-3">
                        ${renderNavButton('library', 'ì¹´ë“œ ë„ê°', 'collection')}
                        ${renderNavButton('graduation-cap', 'AI í•™ìŠµ', 'ai-learning')}
                        ${renderNavButton('trophy', 'ë­í‚¹', 'leaderboard')}
                    </div>
                </div>
            `;
        };

        const renderCollection = () => {
            const cardList = K_CULTURE_ITEMS.map((item, index) => `
                <div key=${index} class="bg-white p-4 rounded-xl shadow-lg border-2 border-yellow-400">
                    <div class="text-4xl text-center mb-2">${item.icon}</div>
                    <h3 class="text-lg font-bold text-gray-800">${item.name}</h3>
                    <p class="text-sm text-gray-600">${item.desc}</p>
                </div>
            `).join('');

            appContainer.innerHTML = `
                <div class="p-6 min-h-screen bg-yellow-50">
                    <h1 class="text-3xl font-bold text-yellow-700 mb-6 border-b pb-3">ğŸ“š ìˆ˜ì§‘ ì¹´ë“œ ë„ê°</h1>
                    <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4">
                        ${cardList}
                    </div>
                    <button 
                        onclick="window.goToPage('game')"
                        class="mt-8 bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transition duration-300 flex items-center mx-auto"
                    >
                        <svg data-lucide="home" class="w-5 h-5 mr-2"></svg> ê²Œì„ìœ¼ë¡œ ëŒì•„ê°€ê¸°
                    </button>
                </div>
            `;
        };

        // --- AI Learning Logic & Renderer (Placeholder) ---
        let currentQuiz = null;
        let aiFeedback = null;
        let isProcessing = false;

        const generateQuiz = () => {
            isProcessing = true;
            aiFeedback = null;
            renderAILearning();

            setTimeout(() => {
                const item = K_CULTURE_ITEMS[Math.floor(Math.random() * K_CULTURE_ITEMS.length)];
                currentQuiz = {
                    question: `ë‹¤ìŒ ì„¤ëª…ì´ ë‚˜íƒ€ë‚´ëŠ” K-Culture í•­ëª©ì€ ë¬´ì—‡ì¼ê¹Œìš”? "${item.desc}"`,
                    correctAnswer: item.name,
                    item: item,
                };
                isProcessing = false;
                document.getElementById('ai-answer').value = '';
                renderAILearning();
            }, 1500);
        };

        const handleSubmit = () => {
            const userAnswer = document.getElementById('ai-answer').value.trim();
            if (!currentQuiz || isProcessing || userAnswer === '') return;

            isProcessing = true;
            renderAILearning();

            const isCorrect = userAnswer.toLowerCase() === currentQuiz.correctAnswer.toLowerCase();
            
            setTimeout(() => {
                if (isCorrect) {
                    aiFeedback = { type: 'correct', message: `âœ… ì •ë‹µ! ${currentQuiz.item.icon} ${currentQuiz.item.name}ì— ëŒ€í•´ ì™„ë²½í•˜ê²Œ ì´í•´í•˜ì…¨êµ°ìš”!` };
                } else {
                    aiFeedback = { type: 'incorrect', message: `âŒ ì•„ì‰½ì§€ë§Œ í‹€ë ¸ì–´ìš”. ${currentQuiz.item.name}ì— ëŒ€í•œ ì„¤ëª…ì„ ë‹¤ì‹œ ì‚´í´ë³¼ê¹Œìš”?` };
                }
                isProcessing = false;
                renderAILearning();
            }, 1000);
        };

        const renderAILearning = () => {
            // Retrieve current input value before re-rendering
            const currentAnswerValue = document.getElementById('ai-answer')?.value || '';

            const quizContent = currentQuiz ? `
                <div class="p-4 bg-gray-100 rounded-lg border-l-4 border-indigo-400">
                    <p class="text-md text-gray-700">${currentQuiz.question}</p>
                </div>
                <input
                    type="text"
                    id="ai-answer"
                    value="${currentAnswerValue}"
                    oninput="this.setAttribute('value', this.value)"
                    class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500"
                    placeholder="ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ê¹€ì¹˜)"
                />
                <button 
                    onclick="window.handleSubmit()"
                    class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-lg shadow-md transition duration-300 flex items-center justify-center ${isProcessing ? 'opacity-50 cursor-not-allowed' : ''}"
                    ${isProcessing ? 'disabled' : ''}
                >
                    <svg data-lucide="check" class="w-5 h-5 mr-2"></svg> ì •ë‹µ í™•ì¸
                </button>
            ` : '';

            const feedbackContent = aiFeedback ? `
                <div class="p-3 rounded-lg font-semibold ${aiFeedback.type === 'correct' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                    ${aiFeedback.message}
                </div>
            ` : '';


            appContainer.innerHTML = `
                <div class="p-6 min-h-screen bg-blue-50">
                    <h1 class="text-3xl font-bold text-blue-700 mb-6 border-b pb-3 flex items-center">
                        <svg data-lucide="graduation-cap" class="w-6 h-6 mr-2"></svg> AI ê¸°ë°˜ í•™ìŠµ ì„¼í„°
                    </h1>
                    
                    <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-xl mx-auto space-y-4">
                        <p class="text-lg font-semibold text-gray-800">
                            <span class="text-indigo-500 font-extrabold">í•˜ì¸„í•‘:</span> ìºì¹˜í•œ ì¹´ë“œì— ëŒ€í•œ í€´ì¦ˆë¥¼ í’€ì–´ë³¼ê¹Œìš”? (LLM ì—°ë™ ì˜ˆì •)
                        </p>

                        ${isProcessing ? 
                            `<div class="text-center text-indigo-500"><svg data-lucide="loader-2" class="animate-spin inline mr-2 w-6 h-6"></svg> í€´ì¦ˆ ìƒì„±/í‰ê°€ ì¤‘...</div>` 
                            : ''
                        }

                        ${!isProcessing ? quizContent : ''}
                        
                        ${feedbackContent}
                        
                        <button 
                            onclick="window.generateQuiz()"
                            class="w-full mt-4 bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 rounded-lg shadow-md transition duration-300 ${isProcessing ? 'opacity-50 cursor-not-allowed' : ''}"
                            ${isProcessing ? 'disabled' : ''}
                        >
                            ë‹¤ìŒ ë¬¸ì œ í’€ê¸°
                        </button>
                    </div>
                    
                    <button 
                        onclick="window.goToPage('game')"
                        class="mt-8 bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transition duration-300 flex items-center mx-auto"
                    >
                        <svg data-lucide="home" class="w-5 h-5 mr-2"></svg> ê²Œì„ìœ¼ë¡œ ëŒì•„ê°€ê¸°
                    </button>
                </div>
            `;
            // Re-run icon rendering after innerHTML update
            if (window.createIcons && window.icons) { // Check for icons globally if available
                window.createIcons({ icons: window.icons });
            }
        };

        // --- Leaderboard Logic & Renderer ---

        const renderLeaderboard = (rankings, isLoading) => {
            let rankingContent = '';
            if (isLoading) {
                rankingContent = `<div class="p-4 flex justify-center items-center"><svg data-lucide="loader-2" class="animate-spin text-blue-500 w-6 h-6"></svg></div>`;
            } else if (rankings.length === 0) {
                rankingContent = `<p class="text-center text-gray-500">ì•„ì§ ë­í‚¹ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ìŠ¹ë¦¬ìê°€ ë˜ì–´ë³´ì„¸ìš”!</p>`;
            } else {
                rankingContent = rankings.map((rank, index) => `
                    <div 
                        class="flex justify-between items-center p-3 rounded-lg ${
                            rank.playerUid === currentUserId ? 'bg-yellow-100 font-extrabold shadow-md' : 'bg-gray-50'
                        }"
                    >
                        <span class="text-xl font-bold ${index === 0 ? 'text-yellow-600' : 'text-gray-700'}">${index + 1}.</span>
                        <span class="flex-1 ml-4 truncate text-sm">
                            ${rank.playerUid === currentUserId ? 'ë‚˜ (You)' : `ID: ${rank.playerUid.substring(0, 8)}...`}
                        </span>
                        <span class="text-lg font-mono text-indigo-600">${rank.moves} Moves</span>
                    </div>
                `).join('');
            }

            appContainer.innerHTML = `
                <div class="p-6 min-h-screen bg-purple-50">
                    <h1 class="text-3xl font-bold text-purple-700 mb-6 border-b pb-3 flex items-center justify-center">
                        <svg data-lucide="trophy" class="w-6 h-6 mr-2"></svg> ëª…ì˜ˆì˜ ì „ë‹¹
                    </h1>
                    
                    <div class="p-4 bg-white rounded-xl shadow-lg w-full max-w-lg mx-auto">
                        <h2 class="text-2xl font-bold mb-4 text-center text-indigo-700 border-b pb-2">ğŸ† ëª…ì˜ˆì˜ ì „ë‹¹ (ìµœì†Œ ì‹œë„)</h2>
                        <div class="space-y-2">
                            ${rankingContent}
                        </div>
                        <div class="mt-4 text-xs text-gray-400 truncate">
                            ë‹¹ì‹ ì˜ ìœ ì € ID: ${currentUserId || 'ë¡œë”© ì¤‘...'} (ìµœê³  ê¸°ë¡ì„ í™•ì¸í•˜ì„¸ìš”!)
                        </div>
                    </div>
                    
                    <button 
                        onclick="window.goToPage('game')"
                        class="mt-8 bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transition duration-300 flex items-center mx-auto"
                    >
                        <svg data-lucide="home" class="w-5 h-5 mr-2"></svg> ê²Œì„ìœ¼ë¡œ ëŒì•„ê°€ê¸°
                    </button>
                </div>
            `;
            // Re-run icon rendering after innerHTML update
            if (window.createIcons && window.icons) { // Check for icons globally if available
                window.createIcons({ icons: window.icons });
            }
        };

        const setupLeaderboardListener = () => {
            if (!db) return;
            const rankingCollectionPath = `artifacts/${appId}/public/data/memory_game_ranking`;

            const q = query(
                collection(db, rankingCollectionPath),
                orderBy("moves", "asc"),
                orderBy("timestamp", "asc"),
                limit(10)
            );

            onSnapshot(q, (snapshot) => {
                const newRankings = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                if (currentPage === 'leaderboard') {
                    renderLeaderboard(newRankings, false);
                }
            }, (error) => {
                console.error("Error fetching rankings: ", error);
                if (currentPage === 'leaderboard') {
                    renderLeaderboard([], false);
                }
            });
        };

        // --- Master Render Function ---
        const render = () => {
            if (!isAuthReady) {
                // Initial loading state is already in HTML, do nothing
                return;
            }

            switch (currentPage) {
                case 'game':
                    renderGame();
                    break;
                case 'collection':
                    renderCollection();
                    break;
                case 'ai-learning':
                    renderAILearning();
                    // Initial load/re-load of quiz data if necessary
                    if (!currentQuiz && !isProcessing) {
                        generateQuiz();
                    }
                    break;
                case 'leaderboard':
                    renderLeaderboard([], true); // Render with loading state first
                    setupLeaderboardListener();
                    break;
                default:
                    appContainer.innerHTML = '<h1 class="text-red-500 text-center mt-10">í˜ì´ì§€ ì˜¤ë¥˜</h1>';
            }
        };

        // --- Initial Setup (Run on window load) ---
        async function initFirebase() {
            if (!firebaseConfig) { 
                console.warn("Firebase config missing. Running in non-persistent mode.");
                currentUserId = crypto.randomUUID();
                isAuthReady = true;
                initializeGame();
                render();
                return;
            }
            
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // 1. Set up Auth Listener
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUserId = user.uid;
                } else {
                    currentUserId = crypto.randomUUID();
                }
                isAuthReady = true;
                initializeGame();
                render();
                // Ensure icons are created after auth is ready and initial render
                if (window.createIcons && window.icons) {
                    window.createIcons({ icons: window.icons });
                }
            });

            // 2. Perform Initial Sign-In
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase Sign-In Error:", error);
            }
        }
        
        // Export functions to global scope so they can be called from HTML onclick attributes
        window.handleCardClick = handleCardClick;
        window.initializeGame = initializeGame;
        window.goToPage = goToPage;
        window.generateQuiz = generateQuiz;
        window.handleSubmit = handleSubmit;

        // Start everything
        window.onload = initFirebase;

    </script>
</body>
</html>
