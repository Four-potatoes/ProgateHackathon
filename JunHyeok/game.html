<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K-Culture Memory Master</title>
    <!-- Tailwind CSS CDNì„ ë¡œë“œí•©ë‹ˆë‹¤. ë””ìì¸ì„ ë‹´ë‹¹í•©ë‹ˆë‹¤. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ì¹´ë“œ í”Œë¦½ ì• ë‹ˆë©”ì´ì…˜ì„ ìœ„í•œ Custom CSS */
        .perspective { perspective: 1000px; }
        .transform-style-preserve-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        .card-inner { transition: transform 0.5s; }
        
        /* ìŠ¹ë¦¬ ëª¨ë‹¬ì´ íŒì—…ë˜ëŠ” ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes pop-in {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-pop-in { animation: pop-in 0.3s ease-out forwards; }
    </style>
    <!-- Lucide ì•„ì´ì½˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¡œë“œí•˜ê³  ì´ˆê¸°í™”í•©ë‹ˆë‹¤. -->
    <script type="module">
        import { createIcons, icons } from 'https://cdn.jsdelivr.net/npm/lucide@latest/dist/esm/lucide.js';
        window.addEventListener('load', () => {
            // ëª¨ë“  Lucide ì•„ì´ì½˜ì„ DOMì—ì„œ ì°¾ì•„ì„œ ë Œë”ë§í•©ë‹ˆë‹¤.
            createIcons({ icons });
        });
    </script>
</head>
<body class="min-h-screen font-sans bg-gray-50" id="body-container">

    <div id="app" class="min-h-screen">
        <!-- ì´ˆê¸° ë¡œë”© í™”ë©´: Firebase ì¸ì¦ ë° ë°ì´í„° ì¤€ë¹„ ì¤‘ì„ì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤. -->
        <div class="flex flex-col justify-center items-center h-screen bg-pink-50">
            <svg data-lucide="loader-2" class="animate-spin text-indigo-500 w-12 h-12"></svg>
            <p class="ml-4 text-xl text-gray-700 mt-4">ë°ì´í„° ë¡œë”© ë° ì¸ì¦ ì¤‘ì…ë‹ˆë‹¤...</p>
        </div>
    </div>

    <!-- Firebase SDKì™€ ë©”ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œì§ì„ ë‹´ê³  ìˆëŠ” JavaScript ëª¨ë“ˆ -->
    <script type="module">
        // Firebase í•„ìš”í•œ ëª¨ë“ˆ ì„í¬íŠ¸
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, orderBy, limit, onSnapshot, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ===============================================
        // 1. ì „ì—­ ìƒìˆ˜ ë° ì„¤ì • (Constants)
        // ===============================================

        // ìº”ë²„ìŠ¤ í™˜ê²½ì—ì„œ ì œê³µë˜ëŠ” ì „ì—­ ë³€ìˆ˜ ì„¤ì • (Firebase ë° App ID)
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-kculture-app-id';

        // K-Culture ì¹´ë“œ ë°ì´í„° (8ìŒ)
        const K_CULTURE_ITEMS = [
            { name: 'í•œë³µ', icon: 'ğŸ‘˜', desc: 'í•œêµ­ì˜ ì „í†µ ì˜ìƒ.' },
            { name: 'ê¹€ì¹˜', icon: 'ğŸŒ¶ï¸', desc: 'í•œêµ­ì˜ ëŒ€í‘œì ì¸ ë°œíš¨ ìŒì‹.' },
            { name: 'ë¹„ë¹”ë°¥', icon: 'ğŸš', desc: 'ë°¥ ìœ„ì— ë‚˜ë¬¼ì„ ì–¹ì–´ ë¹„ë²¼ ë¨¹ëŠ” ìŒì‹.' },
            { name: 'íƒˆì¶¤', icon: 'ğŸ­', desc: 'íƒˆì„ ì“°ê³  ì¶”ëŠ” ì „í†µ ì—°í¬.' },
            { name: 'íƒœê·¹ê¸°', icon: 'ğŸ‡°ğŸ‡·', desc: 'ëŒ€í•œë¯¼êµ­ì˜ êµ­ê¸°.' },
            { name: 'ê¶ê¶', icon: 'ğŸ¯', desc: 'ì¡°ì„  ì‹œëŒ€ ì™•ì´ ì‚´ë˜ í° ê±´ì¶•ë¬¼.' },
            { name: 'ë¶“ê¸€ì”¨', icon: 'ğŸ–‹ï¸', desc: 'ë¶“ìœ¼ë¡œ ì“°ëŠ” ì„œì˜ˆ.' },
            { name: 'ê°€ì•¼ê¸ˆ', icon: 'ğŸ¶', desc: 'í•œêµ­ì˜ ì „í†µ í˜„ì•…ê¸°.' },
        ];

        // ===============================================
        // 2. ìƒíƒœ ê´€ë¦¬ (State Variables)
        // ===============================================

        let app, db, auth;
        let currentUserId = null;       // í˜„ì¬ ë¡œê·¸ì¸ëœ ì‚¬ìš©ìì˜ ID
        let isAuthReady = false;        // Firebase ì¸ì¦ ë° ì´ˆê¸°í™” ì™„ë£Œ ì—¬ë¶€
        
        let CARD_PAIRS;                 // ê²Œì„ì— ì‚¬ìš©ë  ì „ì²´ ì¹´ë“œ ëª©ë¡ (16ê°œ)
        let totalPairs;                 // ì´ ì¹´ë“œ ìŒì˜ ìˆ˜
        
        let cards = [];                 // í˜„ì¬ ê²Œì„íŒì˜ ì¹´ë“œ ë°°ì—´
        let flipped = [];               // ë’¤ì§‘íŒ ì¹´ë“œ ID (ìµœëŒ€ 2ê°œ)
        let matched = [];               // ì§ì„ ë§ì¶˜ ì¹´ë“œ ID
        let moves = 0;                  // ì‹œë„ íšŸìˆ˜
        let isWon = false;              // ê²Œì„ ìŠ¹ë¦¬ ì—¬ë¶€
        let canClick = true;            // ì¹´ë“œ í´ë¦­ ê°€ëŠ¥ ì—¬ë¶€ (ë”œë ˆì´ ì¤‘ ë°©ì§€)
        let currentPage = 'game';       // í˜„ì¬ í‘œì‹œë˜ëŠ” í˜ì´ì§€

        let currentQuiz = null;         // AI í•™ìŠµ í˜ì´ì§€ì˜ í˜„ì¬ í€´ì¦ˆ
        let aiFeedback = null;          // AI í•™ìŠµ í˜ì´ì§€ì˜ í”¼ë“œë°±
        let isProcessing = false;       // AI í•™ìŠµ í€´ì¦ˆ ìƒì„±/ì œì¶œ ì²˜ë¦¬ ì¤‘ ì—¬ë¶€
        
        const appContainer = document.getElementById('app');

        // ===============================================
        // 3. ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ (Utility Functions)
        // ===============================================

        // ë°°ì—´ ì„ê¸° (Fisher-Yates ì•Œê³ ë¦¬ì¦˜)
        const shuffleArray = (array) => {
            let currentIndex = array.length, randomIndex;
            while (currentIndex !== 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
            }
            return array;
        };

        // í˜ì´ì§€ ì´ë™ í•¨ìˆ˜
        const goToPage = (pageName) => {
            currentPage = pageName;
            render();
            // í˜ì´ì§€ê°€ ë³€ê²½ë  ë•Œ Lucide ì•„ì´ì½˜ì„ ë‹¤ì‹œ ë Œë”ë§í•©ë‹ˆë‹¤.
            if (window.createIcons && window.icons) {
                window.createIcons({ icons: window.icons });
            }
        };

        // ===============================================
        // 4. ê²Œì„ í•µì‹¬ ë¡œì§ (Game Core Logic)
        // ===============================================

        // ê²Œì„ì— ì‚¬ìš©í•  ì¹´ë“œ ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤. (8ìŒì„ ë§Œë“¤ì–´ 16ê°œ ì¹´ë“œë¥¼ ì¤€ë¹„)
        const initializeCardData = () => {
             CARD_PAIRS = [...K_CULTURE_ITEMS, ...K_CULTURE_ITEMS].map((item, index) => ({
                ...item,
                // ê° ì¹´ë“œëŠ” ê³ ìœ  IDë¥¼ ê°€ì§‘ë‹ˆë‹¤. (ì§ì´ ê°™ì€ ê²½ìš°ë¼ë„ IDëŠ” ë‹¤ë¦„)
                id: index,
            }));
            totalPairs = CARD_PAIRS.length / 2;
        }

        // ìƒˆ ê²Œì„ì„ ì‹œì‘í•  ë•Œ ìƒíƒœë¥¼ ì´ˆê¸°í™”í•˜ê³  ì¹´ë“œë¥¼ ì„ìŠµë‹ˆë‹¤.
        const initializeGame = () => {
            initializeCardData();
            cards = shuffleArray([...CARD_PAIRS]);
            flipped = [];
            matched = [];
            moves = 0;
            isWon = false;
            canClick = true;
            renderGame();
        };

        // ìŠ¹ë¦¬ ì¡°ê±´ì„ í™•ì¸í•˜ê³ , ì¶©ì¡±ë˜ë©´ ì ìˆ˜ë¥¼ ì œì¶œí•©ë‹ˆë‹¤.
        const checkWinCondition = () => {
            if (matched.length > 0 && matched.length === cards.length) {
                isWon = true;
                submitScore(moves);
                renderGame(); // ìŠ¹ë¦¬ ëª¨ë‹¬ í‘œì‹œë¥¼ ìœ„í•´ ì¬ë Œë”ë§
            }
        };

        // ì¹´ë“œ í´ë¦­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
        const handleCardClick = (cardId) => {
            // í´ë¦­ ë¶ˆê°€ëŠ¥ ì¡°ê±´: í´ë¦­ ì¤‘ì´ê±°ë‚˜, ì´ë¯¸ 2ì¥ì´ ë’¤ì§‘í˜”ê±°ë‚˜, ì´ë¯¸ ë§ì¶˜ ì¹´ë“œê±°ë‚˜, ê²Œì„ì´ ëë‚¬ì„ ë•Œ
            if (!canClick || flipped.length === 2 || flipped.includes(cardId) || matched.includes(cardId) || isWon) {
                return;
            }

            // ì¹´ë“œ ë’¤ì§‘ê¸°
            flipped.push(cardId);
            renderGame(); 
            
            if (flipped.length === 2) {
                canClick = false; // í´ë¦­ ì ê¸ˆ
                moves++;
                renderGame(); // ì‹œë„ íšŸìˆ˜ ì—…ë°ì´íŠ¸

                const [firstId, secondId] = flipped;
                const item1 = cards.find(c => c.id === firstId);
                const item2 = cards.find(c => c.id === secondId);

                // ì§ ë§ì¶”ê¸° ì„±ê³µ (nameì´ ê°™ìœ¼ë©´ ì„±ê³µ)
                if (item1 && item2 && item1.name === item2.name) {
                    matched.push(firstId, secondId);
                    flipped = [];
                    canClick = true; // í´ë¦­ ì ê¸ˆ í•´ì œ
                    checkWinCondition();
                    renderGame();
                } else {
                    // ì§ ë§ì¶”ê¸° ì‹¤íŒ¨: 1ì´ˆ í›„ ì¹´ë“œë¥¼ ë‹¤ì‹œ ë’¤ì§‘ìŠµë‹ˆë‹¤.
                    setTimeout(() => {
                        flipped = [];
                        canClick = true; // í´ë¦­ ì ê¸ˆ í•´ì œ
                        renderGame(); // ì¹´ë“œë¥¼ ë‹¤ì‹œ ë’¤ì§‘ì€ ìƒíƒœë¡œ ì¬ë Œë”ë§
                    }, 1000);
                }
            }
        };

        // ===============================================
        // 5. Firebase ë° ë°ì´í„°ë² ì´ìŠ¤ ë¡œì§
        // ===============================================

        // ê²Œì„ ìŠ¹ë¦¬ ì‹œ ë­í‚¹ ë°ì´í„°ë¥¼ Firestoreì— ì œì¶œí•©ë‹ˆë‹¤.
        const submitScore = async (finalMoves) => {
            if (!db || !currentUserId) {
                console.error("Database or User ID not ready. Score not submitted.");
                return;
            }
            
            // ë­í‚¹ì€ ëª¨ë“  ì‚¬ìš©ìê°€ ë³¼ ìˆ˜ ìˆëŠ” 'public' ì»¬ë ‰ì…˜ì— ì €ì¥í•©ë‹ˆë‹¤.
            const rankingCollectionPath = `artifacts/${appId}/public/data/memory_game_ranking`;
            try {
                await addDoc(collection(db, rankingCollectionPath), {
                    playerUid: currentUserId,
                    moves: finalMoves,
                    timestamp: serverTimestamp(), // ì„œë²„ ì‹œê°„ ê¸°ë¡
                });
                console.log("Score submitted successfully:", finalMoves);
            } catch (error) {
                console.error("Error submitting score:", error);
            }
        };

        // ë­í‚¹ ë¦¬ìŠ¤ë„ˆ ì„¤ì •: ì‹¤ì‹œê°„ìœ¼ë¡œ ë­í‚¹ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
        const setupLeaderboardListener = () => {
            if (!db) return;
            const rankingCollectionPath = `artifacts/${appId}/public/data/memory_game_ranking`;

            // ì¿¼ë¦¬: ì‹œë„ íšŸìˆ˜(moves)ê°€ ì ì€ ìˆœì„œëŒ€ë¡œ, ì‹œë„ íšŸìˆ˜ê°€ ê°™ìœ¼ë©´ íƒ€ì„ìŠ¤íƒ¬í”„(timestamp)ê°€ ë¹ ë¥¸ ìˆœì„œëŒ€ë¡œ ì •ë ¬í•˜ì—¬ 10ê°œë§Œ ê°€ì ¸ì˜µë‹ˆë‹¤.
            const q = query(
                collection(db, rankingCollectionPath),
                orderBy("moves", "asc"),
                orderBy("timestamp", "asc"),
                limit(10)
            );

            onSnapshot(q, (snapshot) => {
                const newRankings = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                // í˜„ì¬ í˜ì´ì§€ê°€ ë­í‚¹ ë³´ë“œì¼ ê²½ìš°ì—ë§Œ í™”ë©´ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
                if (currentPage === 'leaderboard') {
                    renderLeaderboard(newRankings, false);
                }
            }, (error) => {
                console.error("Error fetching rankings: ", error);
                if (currentPage === 'leaderboard') {
                    renderLeaderboard([], false); // ì˜¤ë¥˜ ë°œìƒ ì‹œ ë¹ˆ ë¦¬ìŠ¤íŠ¸ í‘œì‹œ
                }
            });
        };

        // ===============================================
        // 6. AI í•™ìŠµ ë¡œì§ (í˜„ì¬ëŠ” ë”ë¯¸ ë°ì´í„°/ë¡œì§)
        // ===============================================

        // ë¬´ì‘ìœ„ í€´ì¦ˆë¥¼ ìƒì„±í•©ë‹ˆë‹¤. (LLM ì—°ë™ì„ ìœ„í•œ êµ¬ì¡°)
        const generateQuiz = () => {
            isProcessing = true;
            aiFeedback = null;
            renderAILearning();

            // 1.5ì´ˆ ë”œë ˆì´ í›„ í€´ì¦ˆ ìƒì„± (ì‹¤ì œ LLM í˜¸ì¶œ ì‹œì—ëŠ” ì´ ë¶€ë¶„ì— fetch API ë¡œì§ì´ ë“¤ì–´ê°‘ë‹ˆë‹¤.)
            setTimeout(() => {
                const item = K_CULTURE_ITEMS[Math.floor(Math.random() * K_CULTURE_ITEMS.length)];
                currentQuiz = {
                    question: `ë‹¤ìŒ ì„¤ëª…ì´ ë‚˜íƒ€ë‚´ëŠ” K-Culture í•­ëª©ì€ ë¬´ì—‡ì¼ê¹Œìš”? "${item.desc}"`,
                    correctAnswer: item.name,
                    item: item,
                };
                isProcessing = false;
                // ì´ì „ ì…ë ¥ ê°’ ì´ˆê¸°í™”
                const answerInput = document.getElementById('ai-answer');
                if (answerInput) answerInput.value = ''; 
                renderAILearning();
            }, 1500);
        };

        // í€´ì¦ˆ ì •ë‹µì„ ì œì¶œí•˜ê³  í”¼ë“œë°±ì„ ë°›ìŠµë‹ˆë‹¤. (LLM ì—°ë™ì„ ìœ„í•œ êµ¬ì¡°)
        const handleSubmit = () => {
            const userAnswer = document.getElementById('ai-answer').value.trim();
            if (!currentQuiz || isProcessing || userAnswer === '') return;

            isProcessing = true;
            renderAILearning();

            const isCorrect = userAnswer.toLowerCase() === currentQuiz.correctAnswer.toLowerCase();
            
            // 1ì´ˆ ë”œë ˆì´ í›„ ê²°ê³¼ ì²˜ë¦¬
            setTimeout(() => {
                if (isCorrect) {
                    aiFeedback = { type: 'correct', message: `âœ… ì •ë‹µ! ${currentQuiz.item.icon} ${currentQuiz.item.name}ì— ëŒ€í•´ ì™„ë²½í•˜ê²Œ ì´í•´í•˜ì…¨êµ°ìš”!` };
                } else {
                    aiFeedback = { type: 'incorrect', message: `âŒ ì•„ì‰½ì§€ë§Œ í‹€ë ¸ì–´ìš”. ì •ë‹µì€ '${currentQuiz.correctAnswer}'ì…ë‹ˆë‹¤. ì„¤ëª…ì„ ë‹¤ì‹œ ì‚´í´ë³¼ê¹Œìš”?` };
                }
                isProcessing = false;
                renderAILearning();
            }, 1000);
        };

        // ===============================================
        // 7. ë Œë”ë§ (View Rendering)
        // ===============================================

        // ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ë Œë”ë§ìš© í—¬í¼ í•¨ìˆ˜
        const renderNavButton = (icon, label, page) => `
            <button 
                onclick="window.goToPage('${page}')"
                class="flex items-center space-x-2 bg-purple-500 text-white font-semibold py-2 px-4 rounded-full shadow-md hover:bg-purple-600 transition duration-300 text-sm"
            >
                <svg data-lucide="${icon}" class="w-5 h-5"></svg>
                <span>${label}</span>
            </button>
        `;

        // ì¹´ë“œ í•œ ì¥ì„ ë Œë”ë§í•©ë‹ˆë‹¤.
        const renderCard = (card) => {
            const isFlipped = flipped.includes(card.id) || matched.includes(card.id);
            const isMatched = matched.includes(card.id);
            const cursorClass = isMatched ? 'cursor-default' : 'cursor-pointer';

            return `
                <div 
                    id="card-${card.id}"
                    class="aspect-square perspective ${cursorClass}"
                    onclick="window.handleCardClick(${card.id})"
                >
                    <div class="relative w-full h-full card-inner transform-style-preserve-3d 
                        ${isFlipped ? 'rotate-y-180' : ''}"
                    >
                        <!-- ì¹´ë“œ ë’·ë©´ (K-Culture í…Œë§ˆ) -->
                        <div class="absolute backface-hidden w-full h-full bg-indigo-500 rounded-lg shadow-xl border-4 border-indigo-700 flex flex-col items-center justify-center">
                             <svg data-lucide="sparkles" class="w-8 h-8 text-yellow-300 animate-pulse"></svg>
                             <span class="text-white font-bold mt-2">K-Culture</span>
                        </div>
                        
                        <!-- ì¹´ë“œ ì•ë©´ (K-Culture Content) -->
                        <div class="absolute backface-hidden w-full h-full bg-white rounded-lg shadow-xl border-4 border-green-400 flex flex-col items-center justify-center p-1 md:p-2 rotate-y-180">
                            <span class="text-2xl md:text-4xl">${card.icon}</span>
                            <span class="text-xs md:text-sm font-semibold mt-1 text-gray-800 text-center">${card.name}</span>
                        </div>
                    </div>
                </div>
            `;
        };

        // ë©”ì¸ ê²Œì„ í˜ì´ì§€ë¥¼ ë Œë”ë§í•©ë‹ˆë‹¤.
        const renderGame = () => {
            const cardGrid = cards.map(renderCard).join('');
            
            let winModal = '';
            if (isWon) {
                winModal = `
                    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div class="bg-white p-8 rounded-2xl shadow-2xl text-center animate-pop-in">
                            <h2 class="text-3xl font-extrabold text-green-600 mb-4">ğŸ‰ ìºì¹˜ ì„±ê³µ! ì¶•í•˜í•©ë‹ˆë‹¤! ğŸ‰</h2>
                            <p class="text-lg text-gray-700 mb-6">ë‹¹ì‹ ì€ <strong>${moves}ë²ˆ</strong> ë§Œì— ëª¨ë“  K-Culture ì¹´ë“œë¥¼ ìºì¹˜í–ˆìŠµë‹ˆë‹¤.</p>
                            <button 
                                onclick="window.goToPage('leaderboard')"
                                class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transition duration-300 text-lg"
                            >
                                <svg data-lucide="trophy" class="inline w-5 h-5 mr-2"></svg> ë­í‚¹ í™•ì¸ ë° ê¸°ë¡ ë“±ë¡
                            </button>
                        </div>
                    </div>
                `;
            }

            appContainer.innerHTML = `
                <div class="p-4 flex flex-col items-center min-h-screen bg-pink-50">
                    <h1 class="text-4xl font-extrabold text-indigo-600 my-4 tracking-tight">
                        <svg data-lucide="sparkles" class="inline w-6 h-6 mr-2 text-yellow-500"></svg>
                        K-Culture Memory Master
                    </h1>

                    <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-xl mb-6">
                        <div class="flex justify-between items-center mb-4 border-b pb-3">
                            <div class="flex flex-col items-start">
                                <span class="text-xl font-bold text-gray-700">ì‹œë„ íšŸìˆ˜: <span class="text-indigo-500">${moves}</span></span>
                                <span class="text-sm text-gray-500 mt-1">ë‚¨ì€ ìŒ: ${totalPairs - (matched.length / 2)} / ${totalPairs}</span>
                            </div>
                            <button 
                                onclick="window.initializeGame()"
                                class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-full shadow-lg transition duration-300 flex items-center"
                            >
                                <svg data-lucide="rotate-ccw" class="w-4 h-4 mr-1"></svg> ì¬ì‹œì‘
                            </button>
                        </div>

                        <!-- ì¹´ë“œ ê·¸ë¦¬ë“œ (4x4) -->
                        <div class="grid grid-cols-4 gap-3 md:gap-4">
                            ${cardGrid}
                        </div>
                    </div>
                    
                    ${winModal}

                    <!-- í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ -->
                    <div class="mt-6 flex flex-wrap justify-center gap-3">
                        ${renderNavButton('library', 'ì¹´ë“œ ë„ê°', 'collection')}
                        ${renderNavButton('graduation-cap', 'AI í•™ìŠµ', 'ai-learning')}
                        ${renderNavButton('trophy', 'ë­í‚¹', 'leaderboard')}
                    </div>
                </div>
            `;
        };

        // ì¹´ë“œ ë„ê° í˜ì´ì§€ë¥¼ ë Œë”ë§í•©ë‹ˆë‹¤.
        const renderCollection = () => {
            const cardList = K_CULTURE_ITEMS.map((item, index) => `
                <div key=${index} class="bg-white p-4 rounded-xl shadow-lg border-2 border-yellow-400 hover:shadow-xl transition duration-300">
                    <div class="text-4xl text-center mb-2">${item.icon}</div>
                    <h3 class="text-lg font-bold text-gray-800">${item.name}</h3>
                    <p class="text-sm text-gray-600">${item.desc}</p>
                </div>
            `).join('');

            appContainer.innerHTML = `
                <div class="p-6 min-h-screen bg-yellow-50">
                    <h1 class="text-3xl font-bold text-yellow-700 mb-6 border-b pb-3 flex items-center justify-center">
                         <svg data-lucide="library" class="w-6 h-6 mr-2"></svg> ìˆ˜ì§‘ ì¹´ë“œ ë„ê°
                    </h1>
                    <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4 max-w-4xl mx-auto">
                        ${cardList}
                    </div>
                    <button 
                        onclick="window.goToPage('game')"
                        class="mt-8 bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transition duration-300 flex items-center mx-auto"
                    >
                        <svg data-lucide="home" class="w-5 h-5 mr-2"></svg> ê²Œì„ìœ¼ë¡œ ëŒì•„ê°€ê¸°
                    </button>
                </div>
            `;
        };

        // AI í•™ìŠµ í˜ì´ì§€ë¥¼ ë Œë”ë§í•©ë‹ˆë‹¤.
        const renderAILearning = () => {
            // ì¬ë Œë”ë§ ì‹œ Input ê°’ì„ ìœ ì§€í•˜ê¸° ìœ„í•´ í˜„ì¬ ê°’ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
            const currentAnswerValue = document.getElementById('ai-answer')?.value || '';

            const quizContent = currentQuiz ? `
                <div class="p-4 bg-gray-100 rounded-lg border-l-4 border-indigo-400">
                    <p class="text-md text-gray-700">${currentQuiz.question}</p>
                </div>
                <input
                    type="text"
                    id="ai-answer"
                    value="${currentAnswerValue}"
                    oninput="this.setAttribute('value', this.value)"
                    class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500"
                    placeholder="ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ê¹€ì¹˜)"
                />
                <button 
                    onclick="window.handleSubmit()"
                    class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-lg shadow-md transition duration-300 flex items-center justify-center ${isProcessing ? 'opacity-50 cursor-not-allowed' : ''}"
                    ${isProcessing ? 'disabled' : ''}
                >
                    <svg data-lucide="check" class="w-5 h-5 mr-2"></svg> ì •ë‹µ í™•ì¸
                </button>
            ` : '';

            const feedbackContent = aiFeedback ? `
                <div class="p-3 rounded-lg font-semibold ${aiFeedback.type === 'correct' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                    ${aiFeedback.message}
                </div>
            ` : '';

            appContainer.innerHTML = `
                <div class="p-6 min-h-screen bg-blue-50">
                    <h1 class="text-3xl font-bold text-blue-700 mb-6 border-b pb-3 flex items-center justify-center">
                        <svg data-lucide="graduation-cap" class="w-6 h-6 mr-2"></svg> AI ê¸°ë°˜ í•™ìŠµ ì„¼í„°
                    </h1>
                    
                    <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-xl mx-auto space-y-4">
                        <p class="text-lg font-semibold text-gray-800">
                            <span class="text-indigo-500 font-extrabold">í•˜ì¸„í•‘:</span> ìºì¹˜í•œ ì¹´ë“œì— ëŒ€í•œ í€´ì¦ˆë¥¼ í’€ì–´ë³¼ê¹Œìš”?
                        </p>

                        ${isProcessing ? 
                            `<div class="text-center text-indigo-500 p-4"><svg data-lucide="loader-2" class="animate-spin inline mr-2 w-6 h-6"></svg> í€´ì¦ˆ ìƒì„±/í‰ê°€ ì¤‘...</div>` 
                            : ''
                        }

                        ${!isProcessing ? quizContent : ''}
                        
                        ${feedbackContent}
                        
                        <button 
                            onclick="window.generateQuiz()"
                            class="w-full mt-4 bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 rounded-lg shadow-md transition duration-300 ${isProcessing ? 'opacity-50 cursor-not-allowed' : ''}"
                            ${isProcessing ? 'disabled' : ''}
                        >
                            ë‹¤ìŒ ë¬¸ì œ í’€ê¸°
                        </button>
                    </div>
                    
                    <button 
                        onclick="window.goToPage('game')"
                        class="mt-8 bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transition duration-300 flex items-center mx-auto"
                    >
                        <svg data-lucide="home" class="w-5 h-5 mr-2"></svg> ê²Œì„ìœ¼ë¡œ ëŒì•„ê°€ê¸°
                    </button>
                </div>
            `;
        };

        // ë­í‚¹ í˜ì´ì§€ë¥¼ ë Œë”ë§í•©ë‹ˆë‹¤. (ë°ì´í„°ëŠ” setupLeaderboardListenerì—ì„œ ê°€ì ¸ì˜´)
        const renderLeaderboard = (rankings, isLoading) => {
            let rankingContent = '';
            if (isLoading) {
                rankingContent = `<div class="p-4 flex justify-center items-center"><svg data-lucide="loader-2" class="animate-spin text-blue-500 w-6 h-6"></svg><span class="ml-2 text-gray-600">ë­í‚¹ ë°ì´í„° ë¡œë”© ì¤‘...</span></div>`;
            } else if (rankings.length === 0) {
                rankingContent = `<p class="text-center text-gray-500 p-4">ì•„ì§ ë­í‚¹ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ìŠ¹ë¦¬ìê°€ ë˜ì–´ë³´ì„¸ìš”!</p>`;
            } else {
                rankingContent = rankings.map((rank, index) => `
                    <div 
                        class="flex justify-between items-center p-3 rounded-lg transition duration-150 ${
                            rank.playerUid === currentUserId ? 'bg-yellow-100 font-extrabold shadow-md border-2 border-yellow-400' : 'bg-gray-50'
                        }"
                    >
                        <!-- ìˆœìœ„ í‘œì‹œ -->
                        <span class="text-xl font-bold ${index === 0 ? 'text-yellow-600' : 'text-gray-700'}">${index + 1}.</span>
                        <!-- í”Œë ˆì´ì–´ ID í‘œì‹œ (ë³¸ì¸ì¼ ê²½ìš° 'ë‚˜' í‘œì‹œ) -->
                        <span class="flex-1 ml-4 truncate text-sm">
                            ${rank.playerUid === currentUserId ? 'ë‚˜ (You) - ' : `ID: `}
                            <span class="font-mono text-gray-500">${rank.playerUid}</span>
                        </span>
                        <!-- ì‹œë„ íšŸìˆ˜ í‘œì‹œ -->
                        <span class="text-lg font-mono text-indigo-600">${rank.moves} Moves</span>
                    </div>
                `).join('');
            }

            appContainer.innerHTML = `
                <div class="p-6 min-h-screen bg-purple-50">
                    <h1 class="text-3xl font-bold text-purple-700 mb-6 border-b pb-3 flex items-center justify-center">
                        <svg data-lucide="trophy" class="w-6 h-6 mr-2"></svg> ëª…ì˜ˆì˜ ì „ë‹¹ (ë¦¬ë”ë³´ë“œ)
                    </h1>
                    
                    <div class="p-4 bg-white rounded-xl shadow-lg w-full max-w-lg mx-auto">
                        <h2 class="text-2xl font-bold mb-4 text-center text-indigo-700 border-b pb-2">ğŸ† ìµœê³  ê¸°ë¡ (ìµœì†Œ ì‹œë„)</h2>
                        <div class="space-y-2">
                            ${rankingContent}
                        </div>
                        <div class="mt-4 text-xs text-gray-400 truncate pt-2 border-t">
                            ë‹¹ì‹ ì˜ ìœ ì € ID (ì „ì²´): ${currentUserId || 'ë¡œë”© ì¤‘...'}
                        </div>
                    </div>
                    
                    <button 
                        onclick="window.goToPage('game')"
                        class="mt-8 bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transition duration-300 flex items-center mx-auto"
                    >
                        <svg data-lucide="home" class="w-5 h-5 mr-2"></svg> ê²Œì„ìœ¼ë¡œ ëŒì•„ê°€ê¸°
                    </button>
                </div>
            `;
        };


        // ëª¨ë“  í˜ì´ì§€ ë Œë”ë§ì„ ì¡°ì •í•˜ëŠ” ë§ˆìŠ¤í„° í•¨ìˆ˜
        const render = () => {
            if (!isAuthReady) {
                // ì¸ì¦ ì¤€ë¹„ ì¤‘ì´ë©´ ì´ˆê¸° ë¡œë”© í™”ë©´ì„ ìœ ì§€í•©ë‹ˆë‹¤.
                return;
            }

            // í˜„ì¬ í˜ì´ì§€ ìƒíƒœì— ë”°ë¼ ì ì ˆí•œ ë Œë”ë§ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
            switch (currentPage) {
                case 'game':
                    renderGame();
                    break;
                case 'collection':
                    renderCollection();
                    break;
                case 'ai-learning':
                    renderAILearning();
                    // AI í•™ìŠµ í˜ì´ì§€ ì²« ì§„ì… ì‹œ í€´ì¦ˆë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
                    if (!currentQuiz && !isProcessing) {
                        generateQuiz();
                    }
                    break;
                case 'leaderboard':
                    renderLeaderboard([], true); // ë¡œë”© ìƒíƒœë¡œ ë Œë”ë§
                    setupLeaderboardListener();   // ì‹¤ì‹œê°„ ë­í‚¹ ë¦¬ìŠ¤ë„ˆ ì‹œì‘
                    break;
                default:
                    appContainer.innerHTML = '<h1 class="text-red-500 text-center mt-10">í˜ì´ì§€ ì˜¤ë¥˜</h1>';
            }
            // í˜ì´ì§€ ì½˜í…ì¸ ê°€ ì—…ë°ì´íŠ¸ëœ í›„ ì•„ì´ì½˜ì„ ë‹¤ì‹œ ë Œë”ë§í•©ë‹ˆë‹¤.
            if (window.createIcons && window.icons) {
                 window.createIcons({ icons: window.icons });
            }
        };

        // ===============================================
        // 8. ì´ˆê¸°í™” (Initialization)
        // ===============================================

        // Firebaseë¥¼ ì´ˆê¸°í™”í•˜ê³  ì‚¬ìš©ì ì¸ì¦ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
        async function initFirebase() {
            if (!firebaseConfig) { 
                console.warn("Firebase config missing. Running in non-persistent mode.");
                currentUserId = crypto.randomUUID(); // ê³ ìœ  ID í• ë‹¹
                isAuthReady = true;
                initializeGame();
                render();
                return;
            }
            
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // 1. Auth Listener ì„¤ì •: ì¸ì¦ ìƒíƒœê°€ ë³€ê²½ë  ë•Œë§ˆë‹¤ í˜¸ì¶œë˜ì–´ ì‚¬ìš©ì IDë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUserId = user.uid;
                } else {
                    currentUserId = crypto.randomUUID(); // ìµëª… ì‚¬ìš©ìì—ê²Œ ê³ ìœ  ID í• ë‹¹
                }
                isAuthReady = true;
                initializeGame(); // ê²Œì„ ì´ˆê¸°í™” ë° ì‹œì‘
                render(); // ì²« í™”ë©´ ë Œë”ë§
            });

            // 2. ì´ˆê¸° Sign-In: ì œê³µëœ í† í°ì´ ìˆìœ¼ë©´ ë¡œê·¸ì¸, ì—†ìœ¼ë©´ ìµëª… ë¡œê·¸ì¸ ì‹œë„
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase Sign-In Error:", error);
            }
        }
        
        // HTML 'onclick' ì†ì„±ì—ì„œ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•  ìˆ˜ ìˆë„ë¡ ì „ì—­ ìŠ¤ì½”í”„ì— ë“±ë¡í•©ë‹ˆë‹¤.
        window.handleCardClick = handleCardClick;
        window.initializeGame = initializeGame;
        window.goToPage = goToPage;
        window.generateQuiz = generateQuiz;
        window.handleSubmit = handleSubmit;

        // ìœˆë„ìš° ë¡œë“œ ì‹œ ëª¨ë“  ê²ƒì„ ì‹œì‘í•©ë‹ˆë‹¤.
        window.onload = initFirebase;

    </script>
</body>
</html>
