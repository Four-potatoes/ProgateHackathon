<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K-Culture Memory Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ì¹´ë“œ í”Œë¦½ ì• ë‹ˆë©”ì´ì…˜ */
        .perspective { perspective: 1000px; }
        .transform-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .flip { transform: rotateY(180deg); }
        .card-transition { transition: transform 0.5s; }
        
        /* ìŠ¹ë¦¬ ëª¨ë‹¬ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes pop {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .pop-in { animation: pop 0.3s ease-out forwards; }
    </style>
    <script type="module">
        import { createIcons, icons } from 'https://cdn.jsdelivr.net/npm/lucide@latest/dist/esm/lucide.js';
        window.addEventListener('load', () => createIcons({ icons }));
    </script>
</head>
<body class="min-h-screen font-sans bg-gray-50">

    <div id="app" class="min-h-screen">
        <!-- ë¡œë”© í™”ë©´ -->
        <div class="flex flex-col justify-center items-center h-screen bg-pink-50">
            <svg data-lucide="loader-2" class="animate-spin text-indigo-500 w-12 h-12"></svg>
            <p class="ml-4 text-xl text-gray-700 mt-4">ë¡œë”© ì¤‘...</p>
        </div>
    </div>
    
    <script type="module">
        // ============================================
        // Firebase ì„í¬íŠ¸
        // ============================================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, orderBy, limit, onSnapshot, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ============================================
        // ìƒìˆ˜ ë° ì„¤ì •
        // ============================================
        const config = {
            firebase: typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null,
            authToken: typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null,
            appId: typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'
        };

        // K-Culture ì¹´ë“œ ë°ì´í„° (8ìŒ = 16ì¥)
        const ITEMS = [
            { name: 'í•œë³µ', icon: 'ğŸ‘˜', desc: 'í•œêµ­ì˜ ì „í†µ ì˜ìƒ.' },
            { name: 'ê¹€ì¹˜', icon: 'ğŸŒ¶ï¸', desc: 'í•œêµ­ì˜ ëŒ€í‘œì ì¸ ë°œíš¨ ìŒì‹.' },
            { name: 'ë¹„ë¹”ë°¥', icon: 'ğŸš', desc: 'ë°¥ ìœ„ì— ë‚˜ë¬¼ì„ ì–¹ì–´ ë¹„ë²¼ ë¨¹ëŠ” ìŒì‹.' },
            { name: 'íƒˆì¶¤', icon: 'ğŸ­', desc: 'íƒˆì„ ì“°ê³  ì¶”ëŠ” ì „í†µ ì—°í¬.' },
            { name: 'íƒœê·¹ê¸°', icon: 'ğŸ‡°ğŸ‡·', desc: 'ëŒ€í•œë¯¼êµ­ì˜ êµ­ê¸°.' },
            { name: 'ê¶ê¶', icon: 'ğŸ¯', desc: 'ì¡°ì„  ì‹œëŒ€ ì™•ì´ ì‚´ë˜ í° ê±´ì¶•ë¬¼.' },
            { name: 'ë¶“ê¸€ì”¨', icon: 'ğŸ–‹ï¸', desc: 'ë¶“ìœ¼ë¡œ ì“°ëŠ” ì„œì˜ˆ.' },
            { name: 'ê°€ì•¼ê¸ˆ', icon: 'ğŸ¶', desc: 'í•œêµ­ì˜ ì „í†µ í˜„ì•…ê¸°.' },
        ];

        // ============================================
        // ì „ì—­ ìƒíƒœ
        // ============================================
        let app, db, auth;
        let userId = null;
        let isReady = false;
        
        // ê²Œì„ ìƒíƒœ
        let cards = [];
        let flipped = [];
        let matched = [];
        let moves = 0;
        let won = false;
        let clickable = true;
        let unlockedCards = new Set(); // ì ê¸ˆ í•´ì œëœ ì¹´ë“œ ì´ë¦„ë“¤
        let playerName = ''; // í”Œë ˆì´ì–´ ì´ë¦„
        let gameStarted = false; // ê²Œì„ ì‹œì‘ ì—¬ë¶€
        
        // UI ìƒíƒœ
        let page = 'game';
        let quiz = null;
        let feedback = null;
        let processing = false;
        let selectedCard = null; // ë„ê°ì—ì„œ ì„ íƒëœ ì¹´ë“œ
        let solvedQuizzes = new Set(); // í’€ë¦° í€´ì¦ˆë“¤ (í˜•ì‹: "ì¹´ë“œì´ë¦„-fill" or "ì¹´ë“œì´ë¦„-write")
        let dummyCreated = false; // ë”ë¯¸ ë°ì´í„° ìƒì„± ì—¬ë¶€
        
        const root = document.getElementById('app');

        // ============================================
        // ìœ í‹¸ë¦¬í‹°
        // ============================================
        const shuffle = (arr) => {
            const result = [...arr];
            for (let i = result.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [result[i], result[j]] = [result[j], result[i]];
            }
            return result;
        };

        const navigate = (newPage) => {
            page = newPage;
            render();
            if (window.createIcons && window.icons) {
                window.createIcons({ icons: window.icons });
            }
        };

        // ============================================
        // ê²Œì„ ë¡œì§
        // ============================================
        const startGame = () => {
            const pairs = [...ITEMS, ...ITEMS].map((item, i) => ({ ...item, id: i }));
            cards = shuffle(pairs);
            flipped = [];
            matched = [];
            moves = 0;
            won = false;
            clickable = true;
            renderGame();
        };

        const checkWin = () => {
            if (matched.length === cards.length) {
                won = true;
                saveScore(moves);
                renderGame();
            }
        };

        const clickCard = (id) => {
            if (!clickable || flipped.length === 2 || flipped.includes(id) || matched.includes(id) || won) {
                return;
            }

            flipped.push(id);
            renderGame();
            
            if (flipped.length === 2) {
                clickable = false;
                moves++;
                renderGame();

                const [first, second] = flipped;
                const card1 = cards.find(c => c.id === first);
                const card2 = cards.find(c => c.id === second);

                if (card1.name === card2.name) {
                    matched.push(first, second);
                    unlockedCards.add(card1.name); // ì¹´ë“œ ì ê¸ˆ í•´ì œ
                    flipped = [];
                    clickable = true;
                    checkWin();
                    renderGame();
                } else {
                    setTimeout(() => {
                        flipped = [];
                        clickable = true;
                        renderGame();
                    }, 1000);
                }
            }
        };

        // ============================================
        // Firebase ë°ì´í„°ë² ì´ìŠ¤
        // ============================================
        const saveScore = async (score) => {
            if (!db || !userId) return;
            
            const path = `artifacts/${config.appId}/public/data/ranking`;
            try {
                await addDoc(collection(db, path), {
                    uid: userId,
                    name: playerName || 'ìµëª…',
                    moves: score,
                    time: serverTimestamp(),
                });
            } catch (err) {
                console.error("Score save error:", err);
            }
        };

        const watchRanking = () => {
            if (!db) return;
            const path = `artifacts/${config.appId}/public/data/ranking`;
            const q = query(
                collection(db, path),
                orderBy("moves", "asc"),
                orderBy("time", "asc"),
                limit(20)
            );

            onSnapshot(q, (snapshot) => {
                const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (page === 'ranking') {
                    renderRanking(data, false);
                }
            }, (err) => {
                console.error("Ranking error:", err);
                if (page === 'ranking') {
                    renderRanking([], false);
                }
            });
        };

        // ============================================
        // AI í•™ìŠµ
        // ============================================
        const getUnsolvedQuizzes = () => {
            const unlockedItems = ITEMS.filter(item => unlockedCards.has(item.name));
            const unsolved = [];
            
            unlockedItems.forEach(item => {
                if (!solvedQuizzes.has(`${item.name}-fill`)) {
                    unsolved.push({ item, type: 'fill' });
                }
                if (!solvedQuizzes.has(`${item.name}-write`)) {
                    unsolved.push({ item, type: 'write' });
                }
            });
            
            return unsolved;
        };

        const makeQuiz = (specificItem = null) => {
            processing = true;
            feedback = null;
            renderAI();

            setTimeout(() => {
                const unsolvedQuizzes = getUnsolvedQuizzes();
                
                // ëª¨ë“  í€´ì¦ˆë¥¼ ë‹¤ í’€ì—ˆëŠ”ì§€ í™•ì¸
                if (unsolvedQuizzes.length === 0) {
                    processing = false;
                    quiz = null;
                    renderAI();
                    return;
                }
                
                // íŠ¹ì • ì¹´ë“œê°€ ì§€ì •ë˜ì—ˆìœ¼ë©´ ê·¸ ì¹´ë“œì˜ ì•ˆ í‘¼ ë¬¸ì œë¥¼ ì°¾ìŒ
                let selectedQuiz;
                if (specificItem) {
                    const itemQuizzes = unsolvedQuizzes.filter(q => q.item.name === specificItem.name);
                    selectedQuiz = itemQuizzes.length > 0 
                        ? itemQuizzes[Math.floor(Math.random() * itemQuizzes.length)]
                        : unsolvedQuizzes[Math.floor(Math.random() * unsolvedQuizzes.length)];
                } else {
                    // ëœë¤ìœ¼ë¡œ ì•ˆ í‘¼ ë¬¸ì œ ì„ íƒ
                    selectedQuiz = unsolvedQuizzes[Math.floor(Math.random() * unsolvedQuizzes.length)];
                }
                
                const { item, type } = selectedQuiz;
                
                if (type === 'fill') {
                    // ë¹ˆì¹¸ ì±„ìš°ê¸°
                    const blankedDesc = item.desc.replace(item.name, '___');
                    quiz = {
                        type: 'fill',
                        question: `ë‹¤ìŒ ë¹ˆì¹¸ì— ì•Œë§ì€ K-Culture í•­ëª©ì„ ì±„ì›Œì£¼ì„¸ìš”:\n"${blankedDesc}"`,
                        answer: item.name,
                        item: item,
                        quizId: `${item.name}-fill`
                    };
                } else {
                    // ì •ë³´ ì“°ê¸°
                    quiz = {
                        type: 'write',
                        question: `'${item.name}'${item.icon}ì— ëŒ€í•´ ì„¤ëª…í•´ì£¼ì„¸ìš”.`,
                        answer: item.desc,
                        item: item,
                        keyword: item.name,
                        quizId: `${item.name}-write`
                    };
                }
                
                processing = false;
                const input = document.getElementById('answer');
                if (input) input.value = '';
                renderAI();
            }, 1500);
        };

        const submitAnswer = () => {
            const input = document.getElementById('answer');
            const userAnswer = input?.value.trim();
            if (!quiz || processing || !userAnswer) return;

            processing = true;
            renderAI();

            setTimeout(() => {
                let isCorrect = false;
                
                if (quiz.type === 'fill') {
                    // ë¹ˆì¹¸ ì±„ìš°ê¸°: ì •í™•í•œ ë‹µ í™•ì¸
                    isCorrect = userAnswer.toLowerCase() === quiz.answer.toLowerCase();
                    feedback = isCorrect 
                        ? { type: 'correct', msg: `âœ… ì •ë‹µ! ${quiz.item.icon} ${quiz.item.name}ì— ëŒ€í•´ ì™„ë²½í•˜ê²Œ ì•Œê³  ê³„ì‹œë„¤ìš”!` }
                        : { type: 'wrong', msg: `âŒ ì•„ì‰½ì§€ë§Œ í‹€ë ¸ì–´ìš”. ì •ë‹µì€ '${quiz.answer}'ì…ë‹ˆë‹¤.\n${quiz.item.desc}` };
                } else {
                    // ì •ë³´ ì“°ê¸°: í‚¤ì›Œë“œ í¬í•¨ ì—¬ë¶€ í™•ì¸
                    isCorrect = userAnswer.length >= 5;
                    feedback = isCorrect
                        ? { type: 'correct', msg: `âœ… ì¢‹ì•„ìš”! ${quiz.item.icon} ${quiz.item.name}ì— ëŒ€í•´ ì˜ ì„¤ëª…í•´ì£¼ì…¨ì–´ìš”!\nì°¸ê³ : ${quiz.answer}` }
                        : { type: 'wrong', msg: `âŒ ì¡°ê¸ˆ ë” ìì„¸íˆ ì„¤ëª…í•´ì£¼ì„¸ìš”! (ìµœì†Œ 5ê¸€ì ì´ìƒ)\níŒíŠ¸: ${quiz.answer}` };
                }
                
                // ì •ë‹µì´ë©´ í€´ì¦ˆ ì™„ë£Œë¡œ í‘œì‹œ
                if (isCorrect) {
                    solvedQuizzes.add(quiz.quizId);
                }
                
                processing = false;
                renderAI();
            }, 1000);
        };

        // ============================================
        // ë Œë”ë§ - ì»´í¬ë„ŒíŠ¸
        // ============================================
        const renderMain = () => {
            root.innerHTML = `
                <div class="min-h-screen flex flex-col items-center justify-center bg-gradient-to-br from-pink-100 via-purple-100 to-indigo-100 p-4">
                    <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md text-center">
                        <div class="mb-6">
                            <div class="text-6xl mb-4">ğŸ®</div>
                            <h1 class="text-4xl font-extrabold text-indigo-600 mb-2">
                                K-Culture<br>Memory Master
                            </h1>
                            <p class="text-gray-600">í•œêµ­ ë¬¸í™” ì¹´ë“œ ë§ì¶”ê¸° ê²Œì„</p>
                        </div>
                        
                        <div class="mb-6">
                            <label class="block text-left text-sm font-semibold text-gray-700 mb-2">
                                ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”
                            </label>
                            <input
                                type="text"
                                id="player-name"
                                class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition"
                                placeholder="ì˜ˆ: í™ê¸¸ë™"
                                maxlength="10"
                            />
                        </div>
                        
                        <button 
                            onclick="startGameWithName()"
                            class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-4 px-6 rounded-lg shadow-lg transition transform hover:scale-105"
                        >
                            ê²Œì„ ì‹œì‘í•˜ê¸°
                        </button>
                        
                        <div class="mt-6 pt-6 border-t border-gray-200">
                            <p class="text-sm text-gray-600 mb-3">ğŸ“š ê²Œì„ ë°©ë²•</p>
                            <div class="text-xs text-gray-500 space-y-1">
                                <p>â€¢ ê°™ì€ K-Culture ì¹´ë“œë¥¼ ì°¾ì•„ ë§ì¶”ì„¸ìš”</p>
                                <p>â€¢ ëª¨ë“  ì¹´ë“œë¥¼ ë§ì¶”ë©´ ë„ê°ì— ì €ì¥ë©ë‹ˆë‹¤</p>
                                <p>â€¢ AI í•™ìŠµìœ¼ë¡œ ë” ìì„¸íˆ ê³µë¶€í•  ìˆ˜ ìˆì–´ìš”</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        const NavBtn = (label, target) => `
            <button 
                onclick="navigate('${target}')"
                class="bg-purple-500 text-white font-semibold py-2 px-4 rounded-full shadow-md hover:bg-purple-600 transition"
            >
                ${label}
            </button>
        `;

        const Card = (card) => {
            const isFlip = flipped.includes(card.id) || matched.includes(card.id);
            const isMatch = matched.includes(card.id);
            const cursor = isMatch ? 'cursor-default' : 'cursor-pointer';

            return `
                <div class="aspect-square perspective ${cursor}" onclick="clickCard(${card.id})">
                    <div class="relative w-full h-full card-transition transform-3d ${isFlip ? 'flip' : ''}">
                        <!-- ë’·ë©´ -->
                        <div class="absolute backface-hidden w-full h-full bg-indigo-500 rounded-lg shadow-xl border-4 border-indigo-700 flex flex-col items-center justify-center">
                            <svg data-lucide="sparkles" class="w-8 h-8 text-yellow-300 animate-pulse"></svg>
                        </div>
                        
                        <!-- ì•ë©´ -->
                        <div class="absolute backface-hidden w-full h-full bg-white rounded-lg shadow-xl border-4 border-green-400 flex flex-col items-center justify-center p-2 flip">
                            <span class="text-2xl md:text-4xl">${card.icon}</span>
                            <span class="text-xs md:text-sm font-semibold mt-1 text-gray-800 text-center">${card.name}</span>
                        </div>
                    </div>
                </div>
            `;
        };

        // ============================================
        // ë Œë”ë§ - í˜ì´ì§€
        // ============================================
        const renderGame = () => {
            const grid = cards.map(Card).join('');
            const modal = won ? `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white p-8 rounded-2xl shadow-2xl text-center pop-in">
                        <h2 class="text-3xl font-extrabold text-green-600 mb-4">ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤! ğŸ‰</h2>
                        <p class="text-lg text-gray-700 mb-2"><strong>${playerName || 'í”Œë ˆì´ì–´'}</strong>ë‹˜!</p>
                        <p class="text-lg text-gray-700 mb-6"><strong>${moves}ë²ˆ</strong> ë§Œì— ëª¨ë“  ì¹´ë“œë¥¼ ë§ì·„ìŠµë‹ˆë‹¤!</p>
                        <div class="flex gap-3 justify-center">
                            <button 
                                onclick="startGame()"
                                class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transition"
                            >
                                ë‹¤ì‹œí•˜ê¸°
                            </button>
                            <button 
                                onclick="navigate('ranking')"
                                class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transition"
                            >
                                ë­í‚¹ ë³´ê¸°
                            </button>
                        </div>
                    </div>
                </div>
            ` : '';

            root.innerHTML = `
                <div class="p-4 flex flex-col items-center min-h-screen bg-pink-50">
                    <div class="w-full max-w-xl flex justify-between items-center mb-4">
                        <h1 class="text-3xl font-extrabold text-indigo-600">K-Culture Memory</h1>
                        <div class="text-right">
                            <p class="text-sm text-gray-600">í”Œë ˆì´ì–´</p>
                            <p class="text-lg font-bold text-indigo-600">${playerName || 'ìµëª…'}</p>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-xl mb-6">
                        <div class="flex justify-between items-center mb-4 border-b pb-3">
                            <div>
                                <span class="text-xl font-bold text-gray-700">ì‹œë„: <span class="text-indigo-500">${moves}</span></span>
                                <span class="text-sm text-gray-500 ml-3">ë‚¨ì€ ìŒ: ${8 - matched.length / 2}</span>
                            </div>
                            <button 
                                onclick="startGame()"
                                class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-full shadow-lg transition"
                            >
                                ì¬ì‹œì‘
                            </button>
                        </div>

                        <div class="grid grid-cols-4 gap-3 md:gap-4">${grid}</div>
                    </div>
                    
                    ${modal}

                    <div class="mt-6 flex flex-wrap justify-center gap-3">
                        ${NavBtn('ì¹´ë“œ ë„ê°', 'cards')}
                        ${NavBtn('AI í•™ìŠµ', 'ai')}
                        ${NavBtn('ë­í‚¹', 'ranking')}
                    </div>
                </div>
            `;
        };

        const renderCards = () => {
            const list = ITEMS.map((item, i) => {
                const isUnlocked = unlockedCards.has(item.name);
                const isSelected = selectedCard?.name === item.name;
                
                if (!isUnlocked) {
                    return `
                        <div class="bg-gray-200 p-4 rounded-xl shadow-lg border-2 border-gray-400 relative">
                            <div class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-50 rounded-xl">
                                <svg data-lucide="lock" class="w-12 h-12 text-white"></svg>
                            </div>
                            <div class="text-4xl text-center mb-2 opacity-30">${item.icon}</div>
                            <h3 class="text-lg font-bold text-gray-400">???</h3>
                            <p class="text-sm text-gray-400">ì ê¹€</p>
                        </div>
                    `;
                }
                
                return `
                    <div 
                        onclick="selectCard(${i})"
                        class="bg-white p-4 rounded-xl shadow-lg border-2 ${isSelected ? 'border-indigo-500 ring-2 ring-indigo-300' : 'border-yellow-400'} hover:shadow-xl transition cursor-pointer"
                    >
                        <div class="text-4xl text-center mb-2">${item.icon}</div>
                        <h3 class="text-lg font-bold text-gray-800">${item.name}</h3>
                        <p class="text-sm text-gray-600">${item.desc}</p>
                    </div>
                `;
            }).join('');

            const detailView = selectedCard ? `
                <div class="bg-white p-6 rounded-xl shadow-2xl border-2 border-indigo-500 max-w-lg mx-auto mt-6">
                    <div class="text-6xl text-center mb-4">${selectedCard.icon}</div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2 text-center">${selectedCard.name}</h2>
                    <p class="text-gray-600 mb-4 text-center">${selectedCard.desc}</p>
                    <button 
                        onclick="learnCard()"
                        class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition flex items-center justify-center gap-2"
                    >
                        <svg data-lucide="graduation-cap" class="w-5 h-5"></svg>
                        AI í•™ìŠµ ì‹œì‘
                    </button>
                </div>
            ` : '';

            root.innerHTML = `
                <div class="p-6 min-h-screen bg-yellow-50">
                    <h1 class="text-3xl font-bold text-yellow-700 mb-2 text-center">ğŸ“š ì¹´ë“œ ë„ê°</h1>
                    <p class="text-center text-gray-600 mb-6">ê²Œì„ì—ì„œ ë§ì¶˜ ì¹´ë“œë§Œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ (${unlockedCards.size}/${ITEMS.length})</p>
                    
                    <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4 max-w-4xl mx-auto">
                        ${list}
                    </div>
                    
                    ${detailView}
                    
                    <button 
                        onclick="navigate('game')"
                        class="mt-8 bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transition flex items-center mx-auto"
                    >
                        ê²Œì„ìœ¼ë¡œ
                    </button>
                </div>
            `;
        };

        const renderAI = () => {
            const answerVal = document.getElementById('answer')?.value || '';
            const unsolvedQuizzes = getUnsolvedQuizzes();
            const totalQuizzes = unlockedCards.size * 2;
            const solvedCount = solvedQuizzes.size;

            // ëª¨ë“  í€´ì¦ˆë¥¼ ë‹¤ í‘¼ ê²½ìš°
            if (unsolvedQuizzes.length === 0 && unlockedCards.size > 0) {
                root.innerHTML = `
                    <div class="p-6 min-h-screen bg-blue-50">
                        <h1 class="text-3xl font-bold text-blue-700 mb-6 text-center">ğŸ“ AI í•™ìŠµ ì„¼í„°</h1>
                        
                        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-xl mx-auto text-center">
                            <div class="text-6xl mb-4">ğŸ‰</div>
                            <h2 class="text-2xl font-bold text-green-600 mb-4">ì¶•í•˜í•©ë‹ˆë‹¤!</h2>
                            <p class="text-lg text-gray-700 mb-6">
                                ëª¨ë“  ì¹´ë“œì— ëŒ€í•œ ë¬¸ì œë¥¼ ë‹¤ í’€ì—ˆìŠµë‹ˆë‹¤!<br>
                                (ì´ ${totalQuizzes}ê°œ ë¬¸ì œ ì™„ë£Œ)
                            </p>
                            <p class="text-md text-gray-600 mb-6">ë‹¤ì‹œ ê³µë¶€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
                            
                            <div class="flex gap-3 justify-center">
                                <button 
                                    onclick="resetQuizzes()"
                                    class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition"
                                >
                                    ì²˜ìŒë¶€í„° ë‹¤ì‹œ
                                </button>
                                <button 
                                    onclick="navigate('game')"
                                    class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition"
                                >
                                    ê²Œì„ìœ¼ë¡œ
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }

            // ì–¸ë½ëœ ì¹´ë“œê°€ ì—†ëŠ” ê²½ìš°
            if (unlockedCards.size === 0) {
                root.innerHTML = `
                    <div class="p-6 min-h-screen bg-blue-50">
                        <h1 class="text-3xl font-bold text-blue-700 mb-6 text-center">ğŸ“ AI í•™ìŠµ ì„¼í„°</h1>
                        
                        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-xl mx-auto text-center">
                            <div class="text-6xl mb-4">ğŸ”’</div>
                            <h2 class="text-2xl font-bold text-gray-700 mb-4">í•™ìŠµí•  ì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤</h2>
                            <p class="text-lg text-gray-600 mb-6">
                                ê²Œì„ì—ì„œ ì¹´ë“œë¥¼ ë§ì¶° ì ê¸ˆ í•´ì œí•œ í›„<br>
                                AI í•™ìŠµì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!
                            </p>
                            
                            <button 
                                onclick="navigate('game')"
                                class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition"
                            >
                                ê²Œì„ ì‹œì‘í•˜ê¸°
                            </button>
                        </div>
                    </div>
                `;
                return;
            }

            const quizBlock = quiz ? `
                <div class="p-4 bg-gray-100 rounded-lg border-l-4 border-indigo-400 mb-4">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-2xl">${quiz.item.icon}</span>
                        <span class="text-sm font-semibold text-indigo-600">
                            ${quiz.type === 'fill' ? 'ğŸ“ ë¹ˆì¹¸ ì±„ìš°ê¸°' : 'âœï¸ ì •ë³´ ì“°ê¸°'}
                        </span>
                    </div>
                    <p class="text-md text-gray-700 whitespace-pre-line">${quiz.question}</p>
                </div>
                ${quiz.type === 'fill' ? `
                    <input
                        type="text"
                        id="answer"
                        value="${answerVal}"
                        class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 mb-4"
                        placeholder="ì •ë‹µ ì…ë ¥ (ì˜ˆ: í•œë³µ)"
                    />
                ` : `
                    <textarea
                        id="answer"
                        class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 mb-4 min-h-24"
                        placeholder="ììœ ë¡­ê²Œ ì„¤ëª…í•´ì£¼ì„¸ìš” (ìµœì†Œ 5ê¸€ì)"
                    >${answerVal}</textarea>
                `}
                <button 
                    onclick="submitAnswer()"
                    class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-lg shadow-md transition ${processing ? 'opacity-50' : ''}"
                    ${processing ? 'disabled' : ''}
                >
                    ì •ë‹µ í™•ì¸
                </button>
            ` : '';

            const feedbackBlock = feedback ? `
                <div class="p-4 rounded-lg font-semibold mt-4 whitespace-pre-line ${feedback.type === 'correct' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                    ${feedback.msg}
                </div>
            ` : '';

            root.innerHTML = `
                <div class="p-6 min-h-screen bg-blue-50">
                    <h1 class="text-3xl font-bold text-blue-700 mb-6 text-center">ğŸ“ AI í•™ìŠµ ì„¼í„°</h1>
                    
                    <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-xl mx-auto">
                        <div class="flex justify-between items-center mb-4">
                            <p class="text-lg font-semibold text-gray-800">
                                <span class="text-indigo-500">í•˜ì¸„í•‘:</span> K-Culture í€´ì¦ˆë¥¼ í’€ì–´ë³¼ê¹Œìš”?
                            </p>
                            <span class="text-sm font-semibold text-indigo-600">
                                ${solvedCount}/${totalQuizzes} ì™„ë£Œ
                            </span>
                        </div>

                        ${processing && !quiz ? '<div class="text-center text-indigo-500 p-4"><svg data-lucide="loader-2" class="animate-spin inline w-6 h-6"></svg> í€´ì¦ˆ ìƒì„± ì¤‘...</div>' : ''}
                        ${!processing || quiz ? quizBlock : ''}
                        ${feedbackBlock}
                        
                        <button 
                            onclick="makeQuiz()"
                            class="w-full mt-4 bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 rounded-lg shadow-md transition ${processing ? 'opacity-50' : ''}"
                            ${processing ? 'disabled' : ''}
                        >
                            ${quiz ? 'ë‹¤ìŒ ë¬¸ì œ' : 'í€´ì¦ˆ ì‹œì‘'}
                        </button>
                    </div>
                    
                    <button 
                        onclick="navigate('game')"
                        class="mt-8 bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transition flex items-center mx-auto"
                    >
                        ê²Œì„ìœ¼ë¡œ
                    </button>
                </div>
            `;
        };

        const renderRanking = (data, loading) => {
            let content = '';
            if (loading) {
                content = '<div class="p-4 text-center text-gray-600"><svg data-lucide="loader-2" class="animate-spin inline w-6 h-6 mr-2"></svg>ë¡œë”© ì¤‘...</div>';
            } else if (data.length === 0) {
                content = '<p class="text-center text-gray-500 p-4">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤!</p>';
            } else {
                // ì‹œë„ íšŸìˆ˜ê°€ ì ì€ ìˆœìœ¼ë¡œ ì •ë ¬ (ì´ë¯¸ ì •ë ¬ë˜ì–´ ìˆì§€ë§Œ í™•ì‹¤í•˜ê²Œ)
                const sortedData = [...data].sort((a, b) => {
                    if (a.moves === b.moves) {
                        return new Date(a.time) - new Date(b.time);
                    }
                    return a.moves - b.moves;
                });

                content = sortedData.map((r, i) => {
                    const isMe = r.uid === userId;
                    const medalEmoji = i === 0 ? 'ğŸ¥‡' : i === 1 ? 'ğŸ¥ˆ' : i === 2 ? 'ğŸ¥‰' : '';
                    
                    return `
                        <div class="flex justify-between items-center p-3 rounded-lg transition ${isMe ? 'bg-yellow-100 font-bold border-2 border-yellow-400 shadow-md' : 'bg-gray-50 hover:bg-gray-100'}">
                            <span class="text-xl font-bold ${i < 3 ? 'text-yellow-600' : 'text-gray-700'} w-12">
                                ${medalEmoji || `${i + 1}.`}
                            </span>
                            <span class="flex-1 ml-2 text-sm truncate">
                                <span class="${isMe ? 'text-indigo-700' : 'text-gray-800'}">${r.name || 'ìµëª…'}</span>
                                ${isMe ? ' <span class="text-xs bg-indigo-500 text-white px-2 py-0.5 rounded-full">ë‚˜</span>' : ''}
                            </span>
                            <span class="text-lg font-mono ${isMe ? 'text-indigo-600' : 'text-gray-600'} font-bold">
                                ${r.moves}íšŒ
                            </span>
                        </div>
                    `;
                }).join('');
            }

            root.innerHTML = `
                <div class="p-6 min-h-screen bg-purple-50">
                    <h1 class="text-3xl font-bold text-purple-700 mb-2 text-center">ğŸ† ëª…ì˜ˆì˜ ì „ë‹¹</h1>
                    <p class="text-center text-gray-600 mb-6">ìµœì†Œ ì‹œë„ íšŸìˆ˜ë¡œ í´ë¦¬ì–´í•œ ë­í‚¹</p>
                    
                    <div class="p-6 bg-white rounded-xl shadow-lg w-full max-w-lg mx-auto">
                        <h2 class="text-xl font-bold mb-4 text-center text-indigo-700 border-b pb-2 flex items-center justify-center gap-2">
                            <svg data-lucide="trophy" class="w-5 h-5"></svg>
                            TOP 20
                        </h2>
                        <div class="space-y-2 max-h-96 overflow-y-auto">${content}</div>
                        
                        ${playerName ? `
                            <div class="mt-4 pt-4 border-t border-gray-200 text-center">
                                <p class="text-xs text-gray-500">í˜„ì¬ í”Œë ˆì´ì–´: <span class="font-bold text-indigo-600">${playerName}</span></p>
                            </div>
                        ` : ''}
                    </div>
                    
                    <button 
                        onclick="navigate('game')"
                        class="mt-8 bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transition flex items-center mx-auto gap-2"
                    >
                        <svg data-lucide="game-controller" class="w-5 h-5"></svg>
                        ê²Œì„ìœ¼ë¡œ
                    </button>
                </div>
            `;
        };

        const render = () => {
            if (!isReady) return;

            // ê²Œì„ ì‹œì‘ ì „ì´ë©´ ë©”ì¸ í™”ë©´ í‘œì‹œ
            if (!gameStarted) {
                renderMain();
                return;
            }

            switch (page) {
                case 'game': renderGame(); break;
                case 'cards': 
                    renderCards();
                    break;
                case 'ai': 
                    renderAI();
                    if (!quiz && !processing) makeQuiz();
                    break;
                case 'ranking': 
                    renderRanking([], true);
                    watchRanking();
                    break;
            }
            
            if (window.createIcons && window.icons) {
                window.createIcons({ icons: window.icons });
            }
        };

        // ============================================
        // ì´ˆê¸°í™”
        // ============================================
        async function init() {
            if (!config.firebase) {
                userId = crypto.randomUUID();
                isReady = true;
                startGame();
                render();
                return;
            }
            
            app = initializeApp(config.firebase);
            db = getFirestore(app);
            auth = getAuth(app);

            onAuthStateChanged(auth, (user) => {
                userId = user ? user.uid : crypto.randomUUID();
                isReady = true;
                createDummyRankings(); // ë”ë¯¸ ë­í‚¹ ë°ì´í„° ìƒì„±
                render(); // ë©”ì¸ í™”ë©´ ë Œë”ë§
            });

            try {
                if (config.authToken) {
                    await signInWithCustomToken(auth, config.authToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (err) {
                console.error("Auth error:", err);
            }
        }
        
        // ì „ì—­ í•¨ìˆ˜ ë“±ë¡
        window.clickCard = clickCard;
        window.startGame = startGame;
        window.navigate = navigate;
        window.makeQuiz = makeQuiz;
        window.submitAnswer = submitAnswer;
        window.startGameWithName = () => {
            const input = document.getElementById('player-name');
            playerName = input?.value.trim() || 'ìµëª…';
            gameStarted = true;
            startGame();
            render();
        };
        window.selectCard = (index) => {
            selectedCard = ITEMS[index];
            renderCards();
            if (window.createIcons && window.icons) {
                window.createIcons({ icons: window.icons });
            }
        };
        window.learnCard = () => {
            if (selectedCard) {
                navigate('ai');
                setTimeout(() => makeQuiz(selectedCard), 100);
            }
        };
        window.resetQuizzes = () => {
            solvedQuizzes.clear();
            quiz = null;
            feedback = null;
            renderAI();
            if (window.createIcons && window.icons) {
                window.createIcons({ icons: window.icons });
            }
        };

        window.onload = init;
    </script>
</body>
</html>