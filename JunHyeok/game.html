<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K-Culture Memory Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ì¹´ë“œ í”Œë¦½ ì• ë‹ˆë©”ì´ì…˜ */
        .perspective { perspective: 1000px; }
        .transform-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .flip { transform: rotateY(180deg); }
        .card-transition { transition: transform 0.5s; }
        
        /* ìŠ¹ë¦¬ ëª¨ë‹¬ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes pop {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .pop-in { animation: pop 0.3s ease-out forwards; }
    </style>
    <script type="module">
        import { createIcons, icons } from 'https://cdn.jsdelivr.net/npm/lucide@latest/dist/esm/lucide.js';
        window.addEventListener('load', () => createIcons({ icons }));
    </script>
</head>
<body class="min-h-screen font-sans bg-gray-50">

    <div id="app" class="min-h-screen">
        <!-- ë¡œë”© í™”ë©´ -->
        <div class="flex flex-col justify-center items-center h-screen bg-pink-50">
            <svg data-lucide="loader-2" class="animate-spin text-indigo-500 w-12 h-12"></svg>
            <p class="ml-4 text-xl text-gray-700 mt-4">ë¡œë”© ì¤‘...</p>
        </div>
    </div>
    
    <script type="module">
        // ============================================
        // Firebase ì„í¬íŠ¸
        // ============================================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, orderBy, limit, onSnapshot, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ============================================
        // ìƒìˆ˜ ë° ì„¤ì •
        // ============================================
        const config = {
            firebase: typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null,
            authToken: typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null,
            appId: typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'
        };

        // K-Culture ì¹´ë“œ ë°ì´í„° (8ìŒ = 16ì¥)
        const ITEMS = [
            { name: 'í•œë³µ', icon: 'ğŸ‘˜', desc: 'í•œêµ­ì˜ ì „í†µ ì˜ìƒ.' },
            { name: 'ê¹€ì¹˜', icon: 'ğŸŒ¶ï¸', desc: 'í•œêµ­ì˜ ëŒ€í‘œì ì¸ ë°œíš¨ ìŒì‹.' },
            { name: 'ë¹„ë¹”ë°¥', icon: 'ğŸš', desc: 'ë°¥ ìœ„ì— ë‚˜ë¬¼ì„ ì–¹ì–´ ë¹„ë²¼ ë¨¹ëŠ” ìŒì‹.' },
            { name: 'íƒˆì¶¤', icon: 'ğŸ­', desc: 'íƒˆì„ ì“°ê³  ì¶”ëŠ” ì „í†µ ì—°í¬.' },
            { name: 'íƒœê·¹ê¸°', icon: 'ğŸ‡°ğŸ‡·', desc: 'ëŒ€í•œë¯¼êµ­ì˜ êµ­ê¸°.' },
            { name: 'ê¶ê¶', icon: 'ğŸ¯', desc: 'ì¡°ì„  ì‹œëŒ€ ì™•ì´ ì‚´ë˜ í° ê±´ì¶•ë¬¼.' },
            { name: 'ë¶“ê¸€ì”¨', icon: 'ğŸ–‹ï¸', desc: 'ë¶“ìœ¼ë¡œ ì“°ëŠ” ì„œì˜ˆ.' },
            { name: 'ê°€ì•¼ê¸ˆ', icon: 'ğŸ¶', desc: 'í•œêµ­ì˜ ì „í†µ í˜„ì•…ê¸°.' },
        ];

        // ============================================
        // ì „ì—­ ìƒíƒœ
        // ============================================
        let app, db, auth;
        let userId = null;
        let isReady = false;
        
        // ê²Œì„ ìƒíƒœ
        let cards = [];
        let flipped = [];
        let matched = [];
        let moves = 0;
        let won = false;
        let clickable = true;
        
        // UI ìƒíƒœ
        let page = 'game';
        let quiz = null;
        let feedback = null;
        let processing = false;
        
        const root = document.getElementById('app');

        // ============================================
        // ìœ í‹¸ë¦¬í‹°
        // ============================================
        const shuffle = (arr) => {
            const result = [...arr];
            for (let i = result.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [result[i], result[j]] = [result[j], result[i]];
            }
            return result;
        };

        const navigate = (newPage) => {
            page = newPage;
            render();
            if (window.createIcons && window.icons) {
                window.createIcons({ icons: window.icons });
            }
        };

        // ============================================
        // ê²Œì„ ë¡œì§
        // ============================================
        const startGame = () => {
            const pairs = [...ITEMS, ...ITEMS].map((item, i) => ({ ...item, id: i }));
            cards = shuffle(pairs);
            flipped = [];
            matched = [];
            moves = 0;
            won = false;
            clickable = true;
            renderGame();
        };

        const checkWin = () => {
            if (matched.length === cards.length) {
                won = true;
                saveScore(moves);
                renderGame();
            }
        };

        const clickCard = (id) => {
            if (!clickable || flipped.length === 2 || flipped.includes(id) || matched.includes(id) || won) {
                return;
            }

            flipped.push(id);
            renderGame();
            
            if (flipped.length === 2) {
                clickable = false;
                moves++;
                renderGame();

                const [first, second] = flipped;
                const card1 = cards.find(c => c.id === first);
                const card2 = cards.find(c => c.id === second);

                if (card1.name === card2.name) {
                    matched.push(first, second);
                    flipped = [];
                    clickable = true;
                    checkWin();
                    renderGame();
                } else {
                    setTimeout(() => {
                        flipped = [];
                        clickable = true;
                        renderGame();
                    }, 1000);
                }
            }
        };

        // ============================================
        // Firebase ë°ì´í„°ë² ì´ìŠ¤
        // ============================================
        const saveScore = async (score) => {
            if (!db || !userId) return;
            
            const path = `artifacts/${config.appId}/public/data/ranking`;
            try {
                await addDoc(collection(db, path), {
                    uid: userId,
                    moves: score,
                    time: serverTimestamp(),
                });
            } catch (err) {
                console.error("Score save error:", err);
            }
        };

        const watchRanking = () => {
            if (!db) return;
            const path = `artifacts/${config.appId}/public/data/ranking`;
            const q = query(
                collection(db, path),
                orderBy("moves", "asc"),
                orderBy("time", "asc"),
                limit(10)
            );

            onSnapshot(q, (snapshot) => {
                const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (page === 'ranking') {
                    renderRanking(data, false);
                }
            }, (err) => {
                console.error("Ranking error:", err);
                if (page === 'ranking') {
                    renderRanking([], false);
                }
            });
        };

        // ============================================
        // AI í•™ìŠµ
        // ============================================
        const makeQuiz = () => {
            processing = true;
            feedback = null;
            renderAI();

            setTimeout(() => {
                const item = ITEMS[Math.floor(Math.random() * ITEMS.length)];
                quiz = {
                    question: `ë‹¤ìŒ ì„¤ëª…ì´ ë‚˜íƒ€ë‚´ëŠ” K-Culture í•­ëª©ì€? "${item.desc}"`,
                    answer: item.name,
                    item: item,
                };
                processing = false;
                const input = document.getElementById('answer');
                if (input) input.value = '';
                renderAI();
            }, 1500);
        };

        const submitAnswer = () => {
            const input = document.getElementById('answer');
            const userAnswer = input?.value.trim();
            if (!quiz || processing || !userAnswer) return;

            processing = true;
            renderAI();

            const correct = userAnswer.toLowerCase() === quiz.answer.toLowerCase();
            
            setTimeout(() => {
                feedback = correct 
                    ? { type: 'correct', msg: `âœ… ì •ë‹µ! ${quiz.item.icon} ${quiz.item.name}` }
                    : { type: 'wrong', msg: `âŒ í‹€ë ¸ì–´ìš”. ì •ë‹µì€ '${quiz.answer}'ì…ë‹ˆë‹¤.` };
                processing = false;
                renderAI();
            }, 1000);
        };

        // ============================================
        // ë Œë”ë§ - ì»´í¬ë„ŒíŠ¸
        // ============================================
        const NavBtn = (label, target) => `
            <button 
                onclick="navigate('${target}')"
                class="bg-purple-500 text-white font-semibold py-2 px-4 rounded-full shadow-md hover:bg-purple-600 transition"
            >
                ${label}
            </button>
        `;

        const Card = (card) => {
            const isFlip = flipped.includes(card.id) || matched.includes(card.id);
            const isMatch = matched.includes(card.id);
            const cursor = isMatch ? 'cursor-default' : 'cursor-pointer';

            return `
                <div class="aspect-square perspective ${cursor}" onclick="clickCard(${card.id})">
                    <div class="relative w-full h-full card-transition transform-3d ${isFlip ? 'flip' : ''}">
                        <!-- ë’·ë©´ -->
                        <div class="absolute backface-hidden w-full h-full bg-indigo-500 rounded-lg shadow-xl border-4 border-indigo-700 flex flex-col items-center justify-center">
                            <svg data-lucide="sparkles" class="w-8 h-8 text-yellow-300 animate-pulse"></svg>
                        </div>
                        
                        <!-- ì•ë©´ -->
                        <div class="absolute backface-hidden w-full h-full bg-white rounded-lg shadow-xl border-4 border-green-400 flex flex-col items-center justify-center p-2 flip">
                            <span class="text-2xl md:text-4xl">${card.icon}</span>
                            <span class="text-xs md:text-sm font-semibold mt-1 text-gray-800 text-center">${card.name}</span>
                        </div>
                    </div>
                </div>
            `;
        };

        // ============================================
        // ë Œë”ë§ - í˜ì´ì§€
        // ============================================
        const renderGame = () => {
            const grid = cards.map(Card).join('');
            const modal = won ? `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white p-8 rounded-2xl shadow-2xl text-center pop-in">
                        <h2 class="text-3xl font-extrabold text-green-600 mb-4">ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤! ğŸ‰</h2>
                        <p class="text-lg text-gray-700 mb-6"><strong>${moves}ë²ˆ</strong> ë§Œì— ëª¨ë“  ì¹´ë“œë¥¼ ë§ì·„ìŠµë‹ˆë‹¤!</p>
                        <div class="flex gap-3 justify-center">
                            <button 
                                onclick="startGame()"
                                class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transition"
                            >
                                ë‹¤ì‹œí•˜ê¸°
                            </button>
                            <button 
                                onclick="navigate('ranking')"
                                class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transition"
                            >
                                ë­í‚¹ ë³´ê¸°
                            </button>
                        </div>
                    </div>
                </div>
            ` : '';

            root.innerHTML = `
                <div class="p-4 flex flex-col items-center min-h-screen bg-pink-50">
                    <h1 class="text-4xl font-extrabold text-indigo-600 my-4">K-Culture Memory Master</h1>

                    <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-xl mb-6">
                        <div class="flex justify-between items-center mb-4 border-b pb-3">
                            <div>
                                <span class="text-xl font-bold text-gray-700">ì‹œë„: <span class="text-indigo-500">${moves}</span></span>
                                <span class="text-sm text-gray-500 ml-3">ë‚¨ì€ ìŒ: ${8 - matched.length / 2}</span>
                            </div>
                            <button 
                                onclick="startGame()"
                                class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-full shadow-lg transition"
                            >
                                ì¬ì‹œì‘
                            </button>
                        </div>

                        <div class="grid grid-cols-4 gap-3 md:gap-4">${grid}</div>
                    </div>
                    
                    ${modal}

                    <div class="mt-6 flex flex-wrap justify-center gap-3">
                        ${NavBtn('ì¹´ë“œ ë„ê°', 'cards')}
                        ${NavBtn('AI í•™ìŠµ', 'ai')}
                        ${NavBtn('ë­í‚¹', 'ranking')}
                    </div>
                </div>
            `;
        };

        const renderCards = () => {
            const list = ITEMS.map((item, i) => `
                <div class="bg-white p-4 rounded-xl shadow-lg border-2 border-yellow-400 hover:shadow-xl transition">
                    <div class="text-4xl text-center mb-2">${item.icon}</div>
                    <h3 class="text-lg font-bold text-gray-800">${item.name}</h3>
                    <p class="text-sm text-gray-600">${item.desc}</p>
                </div>
            `).join('');

            root.innerHTML = `
                <div class="p-6 min-h-screen bg-yellow-50">
                    <h1 class="text-3xl font-bold text-yellow-700 mb-6 text-center">ğŸ“š ì¹´ë“œ ë„ê°</h1>
                    <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4 max-w-4xl mx-auto">
                        ${list}
                    </div>
                    <button 
                        onclick="navigate('game')"
                        class="mt-8 bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transition flex items-center mx-auto"
                    >
                        ê²Œì„ìœ¼ë¡œ
                    </button>
                </div>
            `;
        };

        const renderAI = () => {
            const answerVal = document.getElementById('answer')?.value || '';

            const quizBlock = quiz ? `
                <div class="p-4 bg-gray-100 rounded-lg border-l-4 border-indigo-400 mb-4">
                    <p class="text-md text-gray-700">${quiz.question}</p>
                </div>
                <input
                    type="text"
                    id="answer"
                    value="${answerVal}"
                    class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 mb-4"
                    placeholder="ì •ë‹µ ì…ë ¥ (ì˜ˆ: ê¹€ì¹˜)"
                />
                <button 
                    onclick="submitAnswer()"
                    class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-lg shadow-md transition ${processing ? 'opacity-50' : ''}"
                    ${processing ? 'disabled' : ''}
                >
                    ì •ë‹µ í™•ì¸
                </button>
            ` : '';

            const feedbackBlock = feedback ? `
                <div class="p-3 rounded-lg font-semibold mt-4 ${feedback.type === 'correct' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                    ${feedback.msg}
                </div>
            ` : '';

            root.innerHTML = `
                <div class="p-6 min-h-screen bg-blue-50">
                    <h1 class="text-3xl font-bold text-blue-700 mb-6 text-center">ğŸ“ AI í•™ìŠµ ì„¼í„°</h1>
                    
                    <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-xl mx-auto">
                        <p class="text-lg font-semibold text-gray-800 mb-4">
                            <span class="text-indigo-500">í•˜ì¸„í•‘:</span> í€´ì¦ˆë¥¼ í’€ì–´ë³¼ê¹Œìš”?
                        </p>

                        ${processing ? '<div class="text-center text-indigo-500 p-4"><svg data-lucide="loader-2" class="animate-spin inline w-6 h-6"></svg> ì²˜ë¦¬ ì¤‘...</div>' : ''}
                        ${!processing ? quizBlock : ''}
                        ${feedbackBlock}
                        
                        <button 
                            onclick="makeQuiz()"
                            class="w-full mt-4 bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 rounded-lg shadow-md transition ${processing ? 'opacity-50' : ''}"
                            ${processing ? 'disabled' : ''}
                        >
                            ë‹¤ìŒ ë¬¸ì œ
                        </button>
                    </div>
                    
                    <button 
                        onclick="navigate('game')"
                        class="mt-8 bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transition flex items-center mx-auto"
                    >
                        ê²Œì„ìœ¼ë¡œ
                    </button>
                </div>
            `;
        };

        const renderRanking = (data, loading) => {
            let content = '';
            if (loading) {
                content = '<div class="p-4 text-center text-gray-600">ë¡œë”© ì¤‘...</div>';
            } else if (data.length === 0) {
                content = '<p class="text-center text-gray-500 p-4">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤!</p>';
            } else {
                content = data.map((r, i) => `
                    <div class="flex justify-between items-center p-3 rounded-lg ${r.uid === userId ? 'bg-yellow-100 font-bold border-2 border-yellow-400' : 'bg-gray-50'}">
                        <span class="text-xl font-bold ${i === 0 ? 'text-yellow-600' : 'text-gray-700'}">${i + 1}.</span>
                        <span class="flex-1 ml-4 truncate text-sm">
                            ${r.uid === userId ? 'ë‚˜ (You)' : `ID: ${r.uid.slice(0, 8)}...`}
                        </span>
                        <span class="text-lg font-mono text-indigo-600">${r.moves}</span>
                    </div>
                `).join('');
            }

            root.innerHTML = `
                <div class="p-6 min-h-screen bg-purple-50">
                    <h1 class="text-3xl font-bold text-purple-700 mb-6 text-center">ğŸ† ë­í‚¹</h1>
                    
                    <div class="p-4 bg-white rounded-xl shadow-lg w-full max-w-lg mx-auto">
                        <h2 class="text-2xl font-bold mb-4 text-center text-indigo-700 border-b pb-2">ìµœê³  ê¸°ë¡</h2>
                        <div class="space-y-2">${content}</div>
                    </div>
                    
                    <button 
                        onclick="navigate('game')"
                        class="mt-8 bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transition flex items-center mx-auto"
                    >
                        ê²Œì„ìœ¼ë¡œ
                    </button>
                </div>
            `;
        };

        const render = () => {
            if (!isReady) return;

            switch (page) {
                case 'game': renderGame(); break;
                case 'cards': renderCards(); break;
                case 'ai': 
                    renderAI();
                    if (!quiz && !processing) makeQuiz();
                    break;
                case 'ranking': 
                    renderRanking([], true);
                    watchRanking();
                    break;
            }
            
            if (window.createIcons && window.icons) {
                window.createIcons({ icons: window.icons });
            }
        };

        // ============================================
        // ì´ˆê¸°í™”
        // ============================================
        async function init() {
            if (!config.firebase) {
                userId = crypto.randomUUID();
                isReady = true;
                startGame();
                render();
                return;
            }
            
            app = initializeApp(config.firebase);
            db = getFirestore(app);
            auth = getAuth(app);

            onAuthStateChanged(auth, (user) => {
                userId = user ? user.uid : crypto.randomUUID();
                isReady = true;
                startGame();
                render();
            });

            try {
                if (config.authToken) {
                    await signInWithCustomToken(auth, config.authToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (err) {
                console.error("Auth error:", err);
            }
        }
        
        // ì „ì—­ í•¨ìˆ˜ ë“±ë¡
        window.clickCard = clickCard;
        window.startGame = startGame;
        window.navigate = navigate;
        window.makeQuiz = makeQuiz;
        window.submitAnswer = submitAnswer;

        window.onload = init;
    </script>
</body>
</html>