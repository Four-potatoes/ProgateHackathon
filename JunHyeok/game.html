<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K-Culture Memory Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 3D ì¹´ë“œ í”Œë¦½ ì• ë‹ˆë©”ì´ì…˜ */
        .perspective { perspective: 1000px; }
        .transform-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .flip { transform: rotateY(180deg); }
        .card-transition { transition: transform 0.7s cubic-bezier(0.4, 0.0, 0.2, 1); }
        
        /* ìŠ¹ë¦¬ ëª¨ë‹¬ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes pop {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); opacity: 1; }
        }
        .pop-in { animation: pop 0.5s ease-out forwards; }
        
        /* ìœ ë¦¬ íš¨ê³¼ */
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        .glass-effect-strong {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
        }
        
        /* í˜¸ë²„ íš¨ê³¼ */
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
        }
        
        /* ì§„í–‰ ë°” ì• ë‹ˆë©”ì´ì…˜ */
        .progress-bar {
            transition: width 0.3s ease-out;
        }
        
        /* í„ìŠ¤ íš¨ê³¼ */
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(168, 85, 247, 0.4); }
            50% { box-shadow: 0 0 30px rgba(168, 85, 247, 0.8); }
        }
        .pulse-glow {
            animation: pulse-glow 2s infinite;
        }
    </style>
    <script type="module">
        import { createIcons, icons } from 'https://cdn.jsdelivr.net/npm/lucide@latest/dist/esm/lucide.js';
        window.addEventListener('load', () => createIcons({ icons }));
    </script>
</head>
<body class="min-h-screen font-sans">
    <div id="app" class="min-h-screen">
        <!-- ë¡œë”© í™”ë©´ -->
        <div class="flex flex-col justify-center items-center h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900">
            <svg data-lucide="loader-2" class="animate-spin text-purple-400 w-12 h-12"></svg>
            <p class="ml-4 text-xl text-purple-200 mt-4">ë¡œë”© ì¤‘...</p>
        </div>
    </div>
    <script type="module">
        // ============================================
        // Firebase ì„í¬íŠ¸
        // ============================================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            GoogleAuthProvider,
            signInWithPopup,
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, orderBy, limit, onSnapshot, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ============================================
        // ìƒìˆ˜ ë° ì„¤ì •
        // ============================================
        const config = {
            firebase: typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null,
            authToken: typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null,
            appId: typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'
        };

        const ITEMS = [
            { name: 'í•œë³µ', icon: 'ğŸ‘˜', desc: 'í•œêµ­ì˜ ì „í†µ ì˜ìƒ.', color: 'bg-pink-600' },
            { name: 'ê¹€ì¹˜', icon: 'ğŸŒ¶ï¸', desc: 'í•œêµ­ì˜ ëŒ€í‘œì ì¸ ë°œíš¨ ìŒì‹.', color: 'bg-red-600' },
            { name: 'ë¹„ë¹”ë°¥', icon: 'ğŸš', desc: 'ë°¥ ìœ„ì— ë‚˜ë¬¼ì„ ì–¹ì–´ ë¹„ë²¼ ë¨¹ëŠ” ìŒì‹.', color: 'bg-orange-600' },
            { name: 'íƒˆì¶¤', icon: 'ğŸ­', desc: 'íƒˆì„ ì“°ê³  ì¶”ëŠ” ì „í†µ ì—°í¬.', color: 'bg-purple-600' },
            { name: 'íƒœê·¹ê¸°', icon: 'ğŸ‡°ğŸ‡·', desc: 'ëŒ€í•œë¯¼êµ­ì˜ êµ­ê¸°.', color: 'bg-blue-700' },
            { name: 'ê¶ê¶', icon: 'ğŸ¯', desc: 'ì¡°ì„  ì‹œëŒ€ ì™•ì´ ì‚´ë˜ í° ê±´ì¶•ë¬¼.', color: 'bg-amber-700' },
            { name: 'ë¶“ê¸€ì”¨', icon: 'ğŸ–‹ï¸', desc: 'ë¶“ìœ¼ë¡œ ì“°ëŠ” ì„œì˜ˆ.', color: 'bg-gray-700' },
            { name: 'ê°€ì•¼ê¸ˆ', icon: 'ğŸ¶', desc: 'í•œêµ­ì˜ ì „í†µ í˜„ì•…ê¸°.', color: 'bg-green-600' },
        ];

        const FREE_AVATARS = [
            'ğŸ˜Š', 'ğŸ˜', 'ğŸ¤—', 'ğŸ˜„', 'ğŸ¥°', 'ğŸ˜‡', 'ğŸ¤“', 'ğŸ˜‹',
            'ğŸ±', 'ğŸ¶', 'ğŸ°', 'ğŸ»', 'ğŸ¦Š', 'ğŸ¼', 'ğŸ¨', 'ğŸ¸',
            'ğŸŒŸ', 'â­', 'ğŸˆ', 'ğŸ¯', 'ğŸ¨', 'ğŸ­', 'ğŸª', 'ğŸµ'
        ];

        const PREMIUM_AVATARS = [
            'ğŸ‘‘', 'ğŸ¦„', 'ğŸ‰', 'ğŸ§™â€â™‚ï¸', 'ğŸ¦¸â€â™€ï¸', 'ğŸ¤–', 'ğŸ‘¾', 'ğŸª',
            'ğŸ’', 'ğŸ†', 'ğŸš€', 'ğŸ­', 'ğŸ»', 'ğŸ¨', 'ğŸ©', 'ğŸ•¶ï¸'
        ];

        // ============================================
        // ì „ì—­ ìƒíƒœ
        // ============================================
        let app, db, auth;
        let userId = null;
        let isReady = false;

        // ê²Œì„ ìƒíƒœ
        let cards = [];
        let flipped = [];
        let matched = [];
        let moves = 0;
        let won = false;
        let clickable = true;
        let unlockedCards = new Set();
        let playerName = '';
        let playerAvatar = 'ğŸ˜Š';
        let gameStarted = false;
        let adminCleared = false;
        let page = 'main';
        let quiz = null;
        let feedback = null;
        let processing = false;
        let selectedCard = null;
        let solvedQuizzes = new Set();
        let points = 0;
        let ownedAvatars = new Set(FREE_AVATARS);
        let quizScore = 0;
        let quizTotal = 0;
        let currentQuizIndex = 0;

        // ë”ë¯¸ ë­í‚¹
        let rankingData = [
            { uid: 'dummy_1', name: 'ê¹€ë¯¼ìˆ˜', avatar: 'ğŸ˜', moves: 18, time: new Date('2024-01-01') },
            { uid: 'dummy_2', name: 'ì´ì„œì—°', avatar: 'ğŸ¥°', moves: 22, time: new Date('2024-01-02') },
            { uid: 'dummy_3', name: 'ë°•ì§€í›ˆ', avatar: 'ğŸ¤“', moves: 25, time: new Date('2024-01-03') },
        ];

        const root = document.getElementById('app');

        // ============================================
        // ìœ í‹¸ë¦¬í‹°
        // ============================================
        const shuffle = (arr) => {
            const result = [...arr];
            for (let i = result.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [result[i], result[j]] = [result[j], result[i]];
            }
            return result;
        };

        const navigate = (newPage) => {
            page = newPage;
            render();
            if (window.createIcons && window.icons) {
                window.createIcons({ icons: window.icons });
            }
        };

        // ============================================
        // Firebase & Auth
        // ============================================
        const loginWithGoogle = async () => {
            if (!auth) return alert("ì¸ì¦ ì‹œìŠ¤í…œì´ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
            const provider = new GoogleAuthProvider();
            try {
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                userId = user.uid;
                localStorage.setItem(`points_${userId}`, '0');
                localStorage.setItem(`ownedAvatars_${userId}`, JSON.stringify([...FREE_AVATARS]));
                navigate('selectNickname');
            } catch (err) {
                console.error("Google login error:", err);
                alert("êµ¬ê¸€ ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
        };

        const loginAsGuest = () => {
            userId = crypto.randomUUID();
            localStorage.setItem(`points_${userId}`, '0');
            localStorage.setItem(`ownedAvatars_${userId}`, JSON.stringify([...FREE_AVATARS]));
            navigate('selectNickname');
        };

        const setNickname = () => {
            const input = document.getElementById('nickname-input');
            const name = input.value.trim();
            if (!name) {
                alert('ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            if (name.length > 10) {
                alert('ë‹‰ë„¤ì„ì€ 10ì ì´ë‚´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            playerName = name;
            localStorage.setItem(`playerName_${userId}`, playerName);
            navigate('selectAvatar');
        };

        // ============================================
        // ì–´ë“œë¯¼ ê¸°ëŠ¥
        // ============================================
        const showAdminLogin = () => {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="glass-effect-strong p-8 rounded-2xl shadow-2xl text-center pop-in max-w-sm w-full mx-4 border border-purple-500">
                    <h2 class="text-2xl font-bold text-white mb-4">ğŸ” ì–´ë“œë¯¼ ë©”ë‰´</h2>
                    <input type="password" id="admin-password" class="w-full p-3 bg-white/20 border-2 border-purple-400 rounded-lg focus:border-purple-300 text-white placeholder-purple-200 mb-4" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ (0000)" maxlength="4" />
                    <div class="flex flex-col gap-3">
                        <button onclick="verifyAdminPassword()" class="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition">í™•ì¸</button>
                        <button onclick="closeAdminLogin()" class="bg-white/20 hover:bg-white/30 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition">ì·¨ì†Œ</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('admin-password').focus();
            document.getElementById('admin-password').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') verifyAdminPassword();
            });
        };

        const verifyAdminPassword = () => {
            const pwd = document.getElementById('admin-password').value;
            closeAdminLogin();
            
            if (pwd === '0000') {
                showAdminSuccess();
            } else {
                showAdminFailure();
            }
        };

        const showAdminSuccess = () => {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="glass-effect-strong p-8 rounded-2xl shadow-2xl text-center pop-in max-w-sm w-full mx-4 border border-green-500">
                    <div class="text-6xl mb-4">âœ…</div>
                    <h2 class="text-2xl font-bold text-green-400 mb-2">ì¸ì¦ ì„±ê³µ!</h2>
                    <p class="text-purple-200 mb-6">ì–´ë“œë¯¼ ê¶Œí•œì´ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                    <div class="flex flex-col gap-3">
                        <button onclick="adminClearGame(); closeAdminMenus();" class="bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition">
                            ğŸ® ê²Œì„ ì¦‰ì‹œ í´ë¦¬ì–´
                        </button>
                        <button onclick="giveAdminPoints(); closeAdminMenus();" class="bg-gradient-to-r from-yellow-500 to-orange-600 hover:from-yellow-600 hover:to-orange-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition">
                            ğŸ’° í¬ì¸íŠ¸ 100 ì§€ê¸‰
                        </button>
                        <button onclick="closeAdminMenus()" class="bg-white/20 hover:bg-white/30 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition">ì·¨ì†Œ</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        };

        const showAdminFailure = () => {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="glass-effect-strong p-8 rounded-2xl shadow-2xl text-center pop-in max-w-sm w-full mx-4 border border-red-500">
                    <div class="text-6xl mb-4">âŒ</div>
                    <h2 class="text-2xl font-bold text-red-400 mb-2">ì¸ì¦ ì‹¤íŒ¨</h2>
                    <p class="text-purple-200 mb-6">ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
                    <button onclick="closeAdminMenus()" class="w-full bg-white/20 hover:bg-white/30 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition">í™•ì¸</button>
                </div>
            `;
            document.body.appendChild(modal);
        };

        const giveAdminPoints = () => {
            points += 100;
            localStorage.setItem(`points_${userId}`, points.toString());
            const successModal = document.createElement('div');
            successModal.className = 'fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50';
            successModal.innerHTML = `
                <div class="glass-effect-strong p-8 rounded-2xl shadow-2xl text-center pop-in max-w-sm w-full mx-4 border border-yellow-500">
                    <div class="text-6xl mb-4">ğŸ’°</div>
                    <h2 class="text-2xl font-bold text-yellow-400 mb-2">í¬ì¸íŠ¸ ì§€ê¸‰ ì™„ë£Œ!</h2>
                    <p class="text-purple-200 mb-6">100 í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                    <button onclick="closeAdminMenus()" class="w-full bg-gradient-to-r from-yellow-500 to-orange-600 hover:from-yellow-600 hover:to-orange-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition">í™•ì¸</button>
                </div>
            `;
            document.body.appendChild(successModal);
            if (page === 'profile') setTimeout(() => renderProfile(), 1500);
        };

        const closeAdminMenus = () => {
            const modals = document.querySelectorAll('.fixed.inset-0.bg-black');
            modals.forEach(modal => modal.remove());
        };

        const closeAdminLogin = () => {
            closeAdminMenus();
        };

        const adminClearGame = () => {
            matched = [...cards.map(c => c.id)];
            won = true;
            ITEMS.forEach(item => unlockedCards.add(item.name));
            saveScore(1);
            adminCleared = true;
            renderGame();
        };

        // ============================================
        // ê²Œì„ ë¡œì§
        // ============================================
        const startGame = () => {
            const pairs = [...ITEMS, ...ITEMS].map((item, i) => ({ ...item, id: i }));
            cards = shuffle(pairs);
            flipped = [];
            matched = [];
            moves = 0;
            won = false;
            clickable = true;
            adminCleared = false;
            renderGame();
        };

        const clickCard = (id) => {
            if (!clickable || flipped.length === 2 || flipped.includes(id) || matched.includes(id) || won) return;
            flipped.push(id);
            renderGame();
            if (flipped.length === 2) {
                clickable = false;
                moves++;
                renderGame();
                const [first, second] = flipped;
                const card1 = cards.find(c => c.id === first);
                const card2 = cards.find(c => c.id === second);
                if (card1.name === card2.name) {
                    matched.push(first, second);
                    unlockedCards.add(card1.name);
                    flipped = [];
                    clickable = true;
                    checkWin();
                    renderGame();
                } else {
                    setTimeout(() => {
                        flipped = [];
                        clickable = true;
                        renderGame();
                    }, 1000);
                }
            }
        };

        const checkWin = () => {
            if (matched.length === cards.length) {
                won = true;
                saveScore(moves);
                renderGame();
            }
        };

        // ============================================
        // Firebase & ì ìˆ˜ ì €ì¥
        // ============================================
        const saveScore = async (score) => {
            rankingData.push({
                uid: userId,
                name: playerName || 'ìµëª…',
                avatar: playerAvatar,
                moves: score,
                time: new Date(),
            });
            if (!db || !userId) return;
            const path = `artifacts/${config.appId}/public/data/ranking`;
            try {
                await addDoc(collection(db, path), {
                    uid: userId,
                    name: playerName || 'ìµëª…',
                    avatar: playerAvatar,
                    moves: score,
                    time: serverTimestamp(),
                });
            } catch (err) {
                console.error("Score save error:", err);
            }
        };

        const watchRanking = () => {
            if (!db) {
                if (page === 'ranking') renderRanking(rankingData, false);
                return;
            }
            const path = `artifacts/${config.appId}/public/data/ranking`;
            const q = query(collection(db, path), orderBy("moves", "asc"), orderBy("time", "asc"), limit(20));
            onSnapshot(q, (snapshot) => {
                const firebaseData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const combined = [...rankingData, ...firebaseData];
                if (page === 'ranking') renderRanking(combined, false);
            }, (err) => {
                console.error("Ranking error:", err);
                if (page === 'ranking') renderRanking(rankingData, false);
            });
        };

        // ============================================
        // AI í•™ìŠµ
        // ============================================
        const getUnsolvedQuizzes = () => {
            const unlockedItems = ITEMS.filter(item => unlockedCards.has(item.name));
            const unsolved = [];
            unlockedItems.forEach(item => {
                if (!solvedQuizzes.has(`${item.name}-fill`)) unsolved.push({ item, type: 'fill' });
                if (!solvedQuizzes.has(`${item.name}-write`)) unsolved.push({ item, type: 'write' });
            });
            return unsolved;
        };

        const makeQuiz = (specificItem = null) => {
            processing = true;
            feedback = null;
            renderAI();
            setTimeout(() => {
                const unsolvedQuizzes = getUnsolvedQuizzes();
                if (unsolvedQuizzes.length === 0) {
                    processing = false;
                    quiz = null;
                    renderAI();
                    return;
                }
                let selectedQuiz;
                if (specificItem) {
                    const itemQuizzes = unsolvedQuizzes.filter(q => q.item.name === specificItem.name);
                    selectedQuiz = itemQuizzes.length > 0
                        ? itemQuizzes[Math.floor(Math.random() * itemQuizzes.length)]
                        : unsolvedQuizzes[Math.floor(Math.random() * unsolvedQuizzes.length)];
                } else {
                    selectedQuiz = unsolvedQuizzes[Math.floor(Math.random() * unsolvedQuizzes.length)];
                }
                const { item, type } = selectedQuiz;
                if (type === 'fill') {
                    const blankedDesc = item.desc.replace(item.name, '___');
                    quiz = {
                        type: 'fill',
                        question: `ë‹¤ìŒ ë¹ˆì¹¸ì— ì•Œë§ì€ K-Culture í•­ëª©ì„ ì±„ì›Œì£¼ì„¸ìš”:\n"${blankedDesc}"`,
                        answer: item.name,
                        item: item,
                        quizId: `${item.name}-fill`
                    };
                } else {
                    quiz = {
                        type: 'write',
                        question: `'${item.name}'${item.icon}ì— ëŒ€í•´ ì„¤ëª…í•´ì£¼ì„¸ìš”.`,
                        answer: item.desc,
                        item: item,
                        keyword: item.name,
                        quizId: `${item.name}-write`
                    };
                }
                processing = false;
                const input = document.getElementById('answer');
                if (input) input.value = '';
                renderAI();
            }, 1500);
        };

        const submitAnswer = () => {
            const input = document.getElementById('answer');
            const userAnswer = input?.value.trim();
            if (!quiz || processing || !userAnswer) return;
            processing = true;
            renderAI();
            setTimeout(() => {
                let isCorrect = false;
                if (quiz.type === 'fill') {
                    isCorrect = userAnswer.toLowerCase() === quiz.answer.toLowerCase();
                    feedback = isCorrect
                        ? { type: 'correct', msg: `âœ… ì •ë‹µ! ${quiz.item.icon} ${quiz.item.name}ì— ëŒ€í•´ ì™„ë²½í•˜ê²Œ ì•Œê³  ê³„ì‹œë„¤ìš”!` }
                        : { type: 'wrong', msg: `âŒ ì•„ì‰½ì§€ë§Œ í‹€ë ¸ì–´ìš”. ì •ë‹µì€ '${quiz.answer}'ì…ë‹ˆë‹¤.\n${quiz.item.desc}` };
                } else {
                    isCorrect = userAnswer.length >= 5;
                    feedback = isCorrect
                        ? { type: 'correct', msg: `âœ… ì¢‹ì•„ìš”! ${quiz.item.icon} ${quiz.item.name}ì— ëŒ€í•´ ì˜ ì„¤ëª…í•´ì£¼ì…¨ì–´ìš”!\nì°¸ê³ : ${quiz.answer}` }
                        : { type: 'wrong', msg: `âŒ ì¡°ê¸ˆ ë” ìì„¸íˆ ì„¤ëª…í•´ì£¼ì„¸ìš”! (ìµœì†Œ 5ê¸€ì ì´ìƒ)\níŒíŠ¸: ${quiz.answer}` };
                }
                if (isCorrect) {
                    solvedQuizzes.add(quiz.quizId);
                    points += 10;
                    localStorage.setItem(`points_${userId}`, points.toString());
                }
                processing = false;
                renderAI();
            }, 1000);
        };

        // ============================================
        // í”„ë¡œí•„ ê´€ë ¨ í•¨ìˆ˜
        // ============================================
        const buyAvatar = (avatar, price) => {
            if (points < price) {
                alert('í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!');
                return;
            }
            points -= price;
            ownedAvatars.add(avatar);
            localStorage.setItem(`points_${userId}`, points.toString());
            localStorage.setItem(`ownedAvatars_${userId}`, JSON.stringify([...ownedAvatars]));
            playerAvatar = avatar;
            localStorage.setItem(`playerAvatar_${userId}`, playerAvatar);
            renderProfile();
        };

        const selectAvatar = (avatar) => {
            if (ownedAvatars.has(avatar)) {
                playerAvatar = avatar;
                localStorage.setItem(`playerAvatar_${userId}`, playerAvatar);
                if (page === 'selectAvatar') {
                    gameStarted = true;
                    startGame();
                } else {
                    renderProfile();
                }
            }
        };

        // ============================================
        // ë Œë”ë§
        // ============================================
        const renderMain = () => {
            root.innerHTML = `
                <div class="min-h-screen flex flex-col items-center justify-center bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 p-4">
                    <div class="glass-effect-strong p-8 rounded-2xl shadow-2xl w-full max-w-md text-center border border-purple-500">
                        <div class="mb-6">
                            <div class="text-6xl mb-4 animate-bounce">ğŸ®</div>
                            <h1 class="text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-400 mb-2">
                                K-Culture<br>Memory Master
                            </h1>
                            <p class="text-purple-200">í•œêµ­ ë¬¸í™” ì¹´ë“œ ë§ì¶”ê¸° ê²Œì„</p>
                        </div>
                        <button onclick="loginWithGoogle()" class="w-full flex items-center justify-center gap-2 bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white font-bold py-4 px-6 rounded-lg shadow-lg transition">
                            <svg class="w-5 h-5" viewBox="0 0 24 24"><path fill="#fff" d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.603-.015 2.898-.015 3.285 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg>
                            êµ¬ê¸€ ê³„ì •ìœ¼ë¡œ ì‹œì‘í•˜ê¸°
                        </button>
                        <button onclick="loginAsGuest()" class="w-full mt-3 flex items-center justify-center gap-2 bg-white/20 hover:bg-white/30 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                            </svg>
                            ê²ŒìŠ¤íŠ¸ë¡œ ì‹œì‘í•˜ê¸°
                        </button>
                        <div class="mt-6 pt-6 border-t border-purple-500/50">
                            <p class="text-sm text-purple-300 mb-3">ğŸ“š ê²Œì„ ë°©ë²•</p>
                            <div class="text-xs text-purple-200 space-y-1">
                                <p>â€¢ ê°™ì€ K-Culture ì¹´ë“œë¥¼ ì°¾ì•„ ë§ì¶”ì„¸ìš”</p>
                                <p>â€¢ AI í•™ìŠµ ì •ë‹µ ì‹œ 10í¬ì¸íŠ¸ íšë“</p>
                                <p>â€¢ í”„ë¦¬ë¯¸ì—„ ì•„ë°”íƒ€ëŠ” 50í¬ì¸íŠ¸!</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderSelectNickname = () => {
            root.innerHTML = `
                <div class="min-h-screen flex flex-col items-center justify-center bg-gradient-to-br from-slate-900 via-teal-900 to-slate-900 p-4">
                    <div class="glass-effect-strong p-8 rounded-2xl shadow-2xl w-full max-w-md text-center border border-teal-500">
                        <h2 class="text-2xl font-bold text-teal-300 mb-4">ğŸ“ ë‹‰ë„¤ì„ ì„¤ì •</h2>
                        <p class="text-purple-200 mb-6">ë‹¤ë¥¸ ì‚¬ëŒë“¤ì´ ë³¼ ì´ë¦„ì„ ì •í•´ì£¼ì„¸ìš”</p>
                        <input type="text" id="nickname-input" class="w-full p-3 bg-white/20 border-2 border-teal-400 rounded-lg focus:border-teal-300 text-white placeholder-purple-200 mb-6 text-center text-lg" placeholder="ë‹‰ë„¤ì„ ì…ë ¥ (ìµœëŒ€ 10ì)" maxlength="10" />
                        <button onclick="setNickname()" class="w-full bg-gradient-to-r from-teal-500 to-cyan-600 hover:from-teal-600 hover:to-cyan-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition">
                            í™•ì¸
                        </button>
                    </div>
                </div>
            `;
            const saved = localStorage.getItem(`playerName_${userId}`);
            if (saved) {
                document.getElementById('nickname-input').value = saved;
            }
        };

        const renderSelectAvatar = () => {
            const grid = FREE_AVATARS.map(avatar => `
                <button onclick="selectAvatar('${avatar}')" class="w-12 h-12 text-2xl rounded-full bg-white/20 hover:bg-white/30 border-2 ${playerAvatar === avatar ? 'border-purple-400 ring-4 ring-purple-500/50' : 'border-white/30'} transition-all duration-200">
                    ${avatar}
                </button>
            `).join('');
            root.innerHTML = `
                <div class="min-h-screen flex flex-col items-center justify-center bg-gradient-to-br from-slate-900 via-indigo-900 to-slate-900 p-4">
                    <div class="glass-effect-strong p-8 rounded-2xl shadow-2xl w-full max-w-md text-center border border-indigo-500">
                        <h2 class="text-2xl font-bold text-indigo-300 mb-4">ğŸ‰ ${playerName}ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤!</h2>
                        <p class="text-purple-200 mb-6">ë¬´ë£Œ ì•„ë°”íƒ€ë¥¼ í•˜ë‚˜ ì„ íƒí•˜ì„¸ìš”</p>
                        <div class="grid grid-cols-8 gap-2 mb-6 p-3 bg-white/10 rounded-lg">
                            ${grid}
                        </div>
                        <button onclick="selectAvatar('${playerAvatar}')" class="w-full bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition">
                            ì„ íƒ ì™„ë£Œ â†’ ê²Œì„ ì‹œì‘
                        </button>
                    </div>
                </div>
            `;
        };

        const renderProfile = () => {
            points = parseInt(localStorage.getItem(`points_${userId}`)) || 0;
            const owned = JSON.parse(localStorage.getItem(`ownedAvatars_${userId}`)) || [...FREE_AVATARS];
            ownedAvatars = new Set(owned);
            const allAvatars = [
                ...FREE_AVATARS.map(a => ({ icon: a, price: 0, type: 'free' })),
                ...PREMIUM_AVATARS.map(a => ({ icon: a, price: 50, type: 'premium' }))
            ];
            const avatarGrid = allAvatars.map(av => {
                const isOwned = ownedAvatars.has(av.icon);
                const isSelected = playerAvatar === av.icon;
                const btnClass = isOwned
                    ? `bg-green-500/20 border-2 border-green-400 hover:bg-green-500/30 ${isSelected ? 'ring-4 ring-purple-500/50' : ''}`
                    : `bg-white/10 border-2 border-white/30 opacity-70 hover:opacity-100`;
                const action = isOwned
                    ? `selectAvatar('${av.icon}')`
                    : points >= av.price
                        ? `buyAvatar('${av.icon}', ${av.price})`
                        : '';
                
                let displayText = '';
                if (isOwned) {
                    displayText = isSelected ? 'âœ“ ì„ íƒë¨' : 'ì„ íƒ';
                } else if (av.price === 0) {
                    displayText = 'ë¬´ë£Œ';
                } else {
                    displayText = points >= av.price ? `${av.price}P êµ¬ë§¤` : `ğŸ”’ ${av.price}P`;
                }
                
                return `
                    <div class="flex flex-col items-center p-2 rounded-lg ${isOwned ? 'bg-green-500/10' : av.price > 0 ? 'bg-purple-500/10' : 'bg-white/5'}">
                        <div class="text-3xl mb-1 ${!isOwned && points < av.price ? 'opacity-50' : ''}">${av.icon}</div>
                        ${av.price > 0 && !isOwned ? `<span class="text-xs text-purple-300 font-bold mb-1">â­ ${av.price}P</span>` : ''}
                        <button onclick="${action}" class="text-xs font-semibold px-3 py-1 rounded-full ${btnClass} transition-all duration-200 ${isOwned ? 'text-green-300' : 'text-purple-200'}" ${!isOwned && points < av.price ? 'disabled' : ''}>
                            ${displayText}
                        </button>
                    </div>
                `;
            }).join('');
            root.innerHTML = `
                <div class="p-6 min-h-screen bg-gradient-to-br from-slate-900 via-indigo-900 to-slate-900">
                    <h1 class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-400 mb-4 text-center">ğŸ‘¤ í”„ë¡œí•„ ì„¤ì •</h1>
                    <div class="glass-effect-strong p-6 rounded-2xl shadow-2xl max-w-2xl mx-auto border border-purple-500">
                        <div class="text-center mb-6">
                            <div class="text-6xl mb-2">${playerAvatar}</div>
                            <p class="font-bold text-xl text-white">${playerName}</p>
                            <p class="text-purple-300 font-semibold text-lg mt-1">ğŸ’° í¬ì¸íŠ¸: <span id="point-display" class="text-yellow-400">${points}</span>P</p>
                        </div>
                        
                        <div class="mb-6">
                            <h3 class="text-lg font-bold text-white mb-3 flex items-center gap-2">
                                <span>ğŸ¨</span> ì•„ë°”íƒ€ ì»¬ë ‰ì…˜
                            </h3>
                            <div class="bg-purple-500/20 p-3 rounded-lg mb-3 border border-purple-500/50">
                                <p class="text-sm text-purple-200 font-semibold">â­ í”„ë¦¬ë¯¸ì—„ ì•„ë°”íƒ€ëŠ” 50 í¬ì¸íŠ¸ë¡œ êµ¬ë§¤ ê°€ëŠ¥!</p>
                            </div>
                            <div class="grid grid-cols-4 sm:grid-cols-6 md:grid-cols-8 gap-3">
                                ${avatarGrid}
                            </div>
                        </div>
                        
                        <button onclick="navigate('game')" class="w-full mt-4 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition">ê²Œì„ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
                    </div>
                </div>
            `;
        };

        const NavBtn = (label, target, icon) => `
            <button onclick="navigate('${target}')" class="glass-effect-strong text-white font-semibold py-3 px-6 rounded-full shadow-lg hover:bg-white/30 transition border border-purple-500/50 flex items-center gap-2">
                ${icon} ${label}
            </button>
        `;

        const Card = (card) => {
            const isFlip = flipped.includes(card.id) || matched.includes(card.id);
            const isMatch = matched.includes(card.id);
            const cursor = isMatch ? 'cursor-default' : 'cursor-pointer';
            return `
                <div class="aspect-square perspective ${cursor} card-hover" onclick="clickCard(${card.id})">
                    <div class="relative w-full h-full card-transition transform-3d ${isFlip ? 'flip' : ''}">
                        <!-- ì•ë©´ (ë’·ë©´) -->
                        <div class="absolute backface-hidden w-full h-full glass-effect-strong rounded-2xl shadow-2xl border-2 border-purple-500 flex flex-col items-center justify-center p-4">
                            <svg data-lucide="sparkles" class="w-12 h-12 text-yellow-300 animate-pulse"></svg>
                        </div>
                        <!-- ë’·ë©´ (ì •ë‹µ) -->
                        <div class="absolute backface-hidden w-full h-full bg-gradient-to-br from-white to-purple-50 rounded-2xl shadow-2xl border-4 ${card.color} border-opacity-50 flex flex-col p-3 flip">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-lg font-bold text-gray-800">${card.name}</span>
                                <span class="text-xs px-2 py-1 ${card.color} text-white rounded-full">${card.icon}</span>
                            </div>
                            <div class="flex-1 flex items-center justify-center">
                                <span class="text-5xl">${card.icon}</span>
                            </div>
                            <div class="mt-2 p-2 bg-gradient-to-r from-blue-50 to-blue-100 rounded-lg border-l-4 border-blue-500">
                                <p class="text-xs text-gray-700">${card.desc}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderGame = () => {
            const grid = cards.map(Card).join('');
            const progress = matched.length / cards.length * 100;
            const modal = won ? `
                <div class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50">
                    <div class="glass-effect-strong p-8 rounded-2xl shadow-2xl text-center pop-in max-w-md border border-green-500">
                        <h2 class="text-4xl font-extrabold text-green-400 mb-4">ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤! ğŸ‰</h2>
                        <div class="flex items-center justify-center gap-3 mb-4">
                            <span class="text-4xl">${playerAvatar}</span>
                            <div class="text-left">
                                <p class="text-xl text-white font-bold">${playerName || 'í”Œë ˆì´ì–´'}ë‹˜!</p>
                                <p class="text-purple-200 text-sm">ê²Œì„ í´ë¦¬ì–´!</p>
                            </div>
                        </div>
                        <div class="bg-white/10 rounded-lg p-4 mb-6">
                            <p class="text-3xl font-bold text-yellow-400 mb-2">${moves}ë²ˆ</p>
                            <p class="text-purple-200">ë§Œì— ëª¨ë“  ì¹´ë“œë¥¼ ë§ì·„ìŠµë‹ˆë‹¤!</p>
                        </div>
                        ${
                            adminCleared
                            ? `<div class="mb-4 p-3 rounded-lg bg-yellow-500/20 border border-yellow-500 text-yellow-300 font-bold text-sm">
                                    âš¡ ì–´ë“œë¯¼ ê¶Œí•œìœ¼ë¡œ ì¦‰ì‹œ í´ë¦¬ì–´ë˜ì—ˆìŠµë‹ˆë‹¤!
                                </div>`
                            : ''
                        }
                        <div class="flex gap-3 justify-center">
                            <button onclick="startGame()" class="bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transition">
                                ë‹¤ì‹œí•˜ê¸°
                            </button>
                            <button onclick="navigate('ranking')" class="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transition">
                                ë­í‚¹ ë³´ê¸°
                            </button>
                        </div>
                    </div>
                </div>
            ` : '';
            root.innerHTML = `
                <div class="p-4 min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900">
                    <div class="max-w-6xl mx-auto">
                        <!-- í—¤ë” -->
                        <div class="glass-effect-strong p-4 rounded-2xl mb-4 border border-purple-500/50">
                            <div class="flex justify-between items-center">
                                <h1 class="text-2xl md:text-3xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-400">K-Culture Memory</h1>
                                <div class="flex items-center gap-3">
                                    <div class="text-right">
                                        <p class="text-xs text-purple-300">í”Œë ˆì´ì–´</p>
                                        <p class="text-sm md:text-lg font-bold text-white">${playerName || 'ìµëª…'}</p>
                                    </div>
                                    <span class="text-3xl">${playerAvatar}</span>
                                    <button onclick="navigate('profile')" class="text-xs md:text-sm bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded-full transition">í”„ë¡œí•„</button>
                                </div>
                            </div>
                        </div>

                        <!-- ê²Œì„ ì •ë³´ -->
                        <div class="glass-effect-strong p-6 rounded-2xl shadow-2xl mb-6 border border-purple-500/50">
                            <div class="flex justify-between items-center mb-4">
                                <div class="flex gap-4">
                                    <div class="text-center">
                                        <p class="text-xs text-purple-300 mb-1">ì‹œë„ íšŸìˆ˜</p>
                                        <p class="text-2xl font-bold text-yellow-400">${moves}</p>
                                    </div>
                                    <div class="text-center">
                                        <p class="text-xs text-purple-300 mb-1">ë‚¨ì€ ìŒ</p>
                                        <p class="text-2xl font-bold text-green-400">${8 - matched.length / 2}</p>
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="startGame()" class="bg-gradient-to-r from-red-500 to-pink-600 hover:from-red-600 hover:to-pink-700 text-white font-bold py-2 px-4 rounded-full shadow-lg transition">
                                        ì¬ì‹œì‘
                                    </button>
                                    <button onclick="showAdminLogin()" class="bg-white/20 hover:bg-white/30 text-white font-bold py-2 px-3 rounded-full shadow-lg transition" title="ì–´ë“œë¯¼ ë©”ë‰´">
                                        <svg data-lucide="settings" class="w-4 h-4"></svg>
                                    </button>
                                </div>
                            </div>
                            <!-- ì§„í–‰ ë°” -->
                            <div class="w-full bg-white/20 rounded-full h-3 overflow-hidden">
                                <div class="progress-bar bg-gradient-to-r from-green-500 to-emerald-600 h-full rounded-full" style="width: ${progress}%"></div>
                            </div>
                            <p class="text-xs text-purple-200 text-center mt-2">${Math.round(progress)}% ì™„ë£Œ</p>
                        </div>

                        <!-- ì¹´ë“œ ê·¸ë¦¬ë“œ -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6 mb-8">
                            ${grid}
                        </div>

                        <!-- ë„¤ë¹„ê²Œì´ì…˜ -->
                        <div class="flex flex-wrap justify-center gap-3">
                            ${NavBtn('ğŸ“š ì¹´ë“œ ë„ê°', 'cards', '')}
                            ${NavBtn('ğŸ“ AI í•™ìŠµ', 'ai', '')}
                            ${NavBtn('ğŸ† ë­í‚¹', 'ranking', '')}
                        </div>
                    </div>
                    ${modal}
                </div>
            `;
        };

        const renderCards = () => {
            const list = ITEMS.map((item, i) => {
                const isUnlocked = unlockedCards.has(item.name);
                const isSelected = selectedCard?.name === item.name;
                const cardNum = i + 1;
                if (!isUnlocked) {
                    return `
                        <div class="glass-effect p-6 rounded-2xl shadow-lg border-2 border-gray-600 relative h-64 card-hover">
                            <div class="absolute top-2 right-2 text-xs text-gray-400 font-bold">No.${cardNum}</div>
                            <div class="absolute inset-0 flex flex-col items-center justify-center bg-black bg-opacity-60 rounded-2xl">
                                <svg data-lucide="lock" class="w-16 h-16 text-gray-400 mb-2"></svg>
                                <p class="text-gray-400 font-bold">ì ê¹€</p>
                            </div>
                            <div class="text-5xl text-center mb-3 opacity-20">${item.icon}</div>
                            <h3 class="text-lg font-bold text-gray-500">???</h3>
                        </div>
                    `;
                }
                return `
                    <div onclick="selectCard(${i})" class="glass-effect-strong p-6 rounded-2xl shadow-lg border-2 ${isSelected ? 'border-purple-400 ring-4 ring-purple-500/50 pulse-glow' : 'border-yellow-500'} hover:shadow-2xl transition cursor-pointer h-64 card-hover relative">
                        <div class="absolute top-2 right-2 text-xs text-purple-300 font-bold">No.${cardNum}</div>
                        <div class="text-5xl text-center mb-3">${item.icon}</div>
                        <h3 class="text-xl font-bold text-white mb-2">${item.name}</h3>
                        <span class="inline-block px-3 py-1 ${item.color} text-white text-xs rounded-full mb-2">${item.icon} ë¬¸í™”</span>
                        <p class="text-sm text-purple-200">${item.desc}</p>
                    </div>
                `;
            }).join('');
            const detailView = selectedCard ? `
                <div class="glass-effect-strong p-8 rounded-2xl shadow-2xl border-2 border-purple-500 max-w-lg mx-auto mt-8">
                    <div class="text-7xl text-center mb-4">${selectedCard.icon}</div>
                    <h2 class="text-3xl font-bold text-white mb-2 text-center">${selectedCard.name}</h2>
                    <span class="inline-block px-4 py-2 ${selectedCard.color} text-white text-sm rounded-full mb-4 mx-auto block w-fit">${selectedCard.icon} í•œêµ­ ë¬¸í™”</span>
                    <div class="bg-gradient-to-r from-blue-50 to-purple-50 p-4 rounded-lg mb-6">
                        <p class="text-gray-800 text-center">${selectedCard.desc}</p>
                    </div>
                    <button onclick="learnCard()" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-bold py-4 px-6 rounded-lg shadow-lg transition flex items-center justify-center gap-2">
                        <svg data-lucide="graduation-cap" class="w-6 h-6"></svg>
                        AI í•™ìŠµ ì‹œì‘
                    </button>
                </div>
            ` : '';
            root.innerHTML = `
                <div class="p-6 min-h-screen bg-gradient-to-br from-slate-900 via-yellow-900 to-slate-900">
                    <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-orange-400 mb-2 text-center">ğŸ“š ì¹´ë“œ ë„ê°</h1>
                    <p class="text-center text-purple-200 mb-8">ê²Œì„ì—ì„œ ë§ì¶˜ ì¹´ë“œë§Œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ (${unlockedCards.size}/${ITEMS.length})</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 max-w-6xl mx-auto mb-8">
                        ${list}
                    </div>
                    ${detailView}
                    <button onclick="navigate('game')" class="mt-8 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transition flex items-center mx-auto gap-2">
                        <svg data-lucide="arrow-left" class="w-5 h-5"></svg>
                        ê²Œì„ìœ¼ë¡œ
                    </button>
                </div>
            `;
        };

        const renderAI = () => {
            const answerVal = document.getElementById('answer')?.value || '';
            const unsolvedQuizzes = getUnsolvedQuizzes();
            const totalQuizzes = unlockedCards.size * 2;
            const solvedCount = solvedQuizzes.size;
            const progressPercent = totalQuizzes > 0 ? (solvedCount / totalQuizzes * 100) : 0;
            
            if (unsolvedQuizzes.length === 0 && unlockedCards.size > 0) {
                root.innerHTML = `
                    <div class="p-6 min-h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 flex items-center justify-center">
                        <div class="glass-effect-strong p-8 rounded-2xl shadow-2xl w-full max-w-xl text-center border border-green-500">
                            <div class="text-7xl mb-6">ğŸ‰</div>
                            <h2 class="text-3xl font-bold text-green-400 mb-4">ì™„ë²½í•©ë‹ˆë‹¤!</h2>
                            <div class="bg-green-500/20 rounded-lg p-4 mb-6 border border-green-500">
                                <p class="text-lg text-white mb-2">ëª¨ë“  ì¹´ë“œì— ëŒ€í•œ ë¬¸ì œë¥¼ í’€ì—ˆìŠµë‹ˆë‹¤!</p>
                                <p class="text-yellow-400 font-bold text-2xl">${totalQuizzes}ê°œ ë¬¸ì œ ì™„ë£Œ</p>
                            </div>
                            <p class="text-purple-200 mb-6">ë‹¤ì‹œ ê³µë¶€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
                            <div class="flex gap-3 justify-center">
                                <button onclick="resetQuizzes()" class="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition">
                                    ì²˜ìŒë¶€í„° ë‹¤ì‹œ
                                </button>
                                <button onclick="navigate('game')" class="bg-white/20 hover:bg-white/30 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition">
                                    ê²Œì„ìœ¼ë¡œ
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }
            if (unlockedCards.size === 0) {
                root.innerHTML = `
                    <div class="p-6 min-h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 flex items-center justify-center">
                        <div class="glass-effect-strong p-8 rounded-2xl shadow-2xl w-full max-w-xl text-center border border-red-500">
                            <div class="text-7xl mb-6">ğŸ”’</div>
                            <h2 class="text-3xl font-bold text-white mb-4">í•™ìŠµí•  ì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤</h2>
                            <p class="text-lg text-purple-200 mb-8">ê²Œì„ì—ì„œ ì¹´ë“œë¥¼ ë§ì¶° ì ê¸ˆ í•´ì œí•œ í›„<br>AI í•™ìŠµì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!</p>
                            <button onclick="navigate('game')" class="bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-bold py-4 px-8 rounded-lg shadow-lg transition">
                                ê²Œì„ ì‹œì‘í•˜ê¸°
                            </button>
                        </div>
                    </div>
                `;
                return;
            }
            const quizBlock = quiz ? `
                <div class="p-5 bg-gradient-to-r from-purple-500/20 to-pink-500/20 rounded-lg border-l-4 border-purple-400 mb-6">
                    <div class="flex items-center gap-3 mb-3">
                        <span class="text-3xl">${quiz.item.icon}</span>
                        <span class="text-sm font-semibold text-purple-300 px-3 py-1 bg-white/10 rounded-full">
                            ${quiz.type === 'fill' ? 'ğŸ“ ë¹ˆì¹¸ ì±„ìš°ê¸°' : 'âœï¸ ì •ë³´ ì“°ê¸°'}
                        </span>
                    </div>
                    <p class="text-lg text-white whitespace-pre-line">${quiz.question}</p>
                </div>
                ${quiz.type === 'fill' ? `
                    <input type="text" id="answer" value="${answerVal}" class="w-full p-4 bg-white/20 border-2 border-purple-400 rounded-lg focus:border-purple-300 text-white placeholder-purple-200 mb-4 text-lg" placeholder="ì •ë‹µ ì…ë ¥ (ì˜ˆ: í•œë³µ)" />
                ` : `
                    <textarea id="answer" class="w-full p-4 bg-white/20 border-2 border-purple-400 rounded-lg focus:border-purple-300 text-white placeholder-purple-200 mb-4 min-h-32 text-lg" placeholder="ììœ ë¡­ê²Œ ì„¤ëª…í•´ì£¼ì„¸ìš” (ìµœì†Œ 5ê¸€ì)">${answerVal}</textarea>
                `}
                <button onclick="submitAnswer()" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-bold py-4 rounded-lg shadow-lg transition ${processing ? 'opacity-50' : ''}" ${processing ? 'disabled' : ''}>
                    ì •ë‹µ í™•ì¸
                </button>
            ` : '';
            const feedbackBlock = feedback ? `
                <div class="p-5 rounded-lg font-semibold mt-6 whitespace-pre-line border-2 ${feedback.type === 'correct' ? 'bg-green-100 border-green-500 text-green-700' : 'bg-red-100 border-red-500 text-red-700'}">
                    ${feedback.msg}
                </div>
            ` : '';
            root.innerHTML = `
                <div class="p-6 min-h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900">
                    <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-cyan-400 mb-2 text-center">ğŸ“ AI í•™ìŠµ ì„¼í„°</h1>
                    <p class="text-center text-purple-200 mb-8">í•˜ì¸„í•‘ê³¼ í•¨ê»˜ K-Cultureë¥¼ ë°°ì›Œë´ìš”!</p>
                    
                    <div class="glass-effect-strong p-8 rounded-2xl shadow-2xl w-full max-w-2xl mx-auto border border-blue-500">
                        <!-- ì§„í–‰ ìƒí™© -->
                        <div class="flex justify-between items-center mb-6">
                            <div class="flex items-center gap-3">
                                <span class="text-4xl">ğŸ“</span>
                                <div>
                                    <p class="text-lg font-semibold text-white">
                                        <span class="text-blue-300">í•˜ì¸„í•‘:</span> K-Culture í€´ì¦ˆ
                                    </p>
                                    <p class="text-xs text-purple-300">í•œêµ­ ë¬¸í™”ë¥¼ ë°°ì›Œë´ìš”!</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <span class="text-sm font-semibold text-yellow-400 bg-yellow-500/20 px-3 py-1 rounded-full">
                                    ${solvedCount}/${totalQuizzes} ì™„ë£Œ
                                </span>
                            </div>
                        </div>
                        
                        <!-- ì§„í–‰ ë°” -->
                        <div class="w-full bg-white/20 rounded-full h-3 overflow-hidden mb-8">
                            <div class="progress-bar bg-gradient-to-r from-blue-500 to-cyan-600 h-full rounded-full" style="width: ${progressPercent}%"></div>
                        </div>
                        
                        ${processing && !quiz ? '<div class="text-center text-blue-400 p-8"><svg data-lucide="loader-2" class="animate-spin inline w-8 h-8 mb-2"></svg><p>í€´ì¦ˆ ìƒì„± ì¤‘...</p></div>' : ''}
                        ${!processing || quiz ? quizBlock : ''}
                        ${feedbackBlock}
                        <button onclick="makeQuiz()" class="w-full mt-6 bg-gradient-to-r from-yellow-500 to-orange-600 hover:from-yellow-600 hover:to-orange-700 text-white font-bold py-4 rounded-lg shadow-lg transition ${processing ? 'opacity-50' : ''}" ${processing ? 'disabled' : ''}>
                            ${quiz ? 'ë‹¤ìŒ ë¬¸ì œ â†’' : 'í€´ì¦ˆ ì‹œì‘í•˜ê¸°'}
                        </button>
                    </div>
                    
                    <button onclick="navigate('game')" class="mt-8 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transition flex items-center mx-auto gap-2">
                        <svg data-lucide="arrow-left" class="w-5 h-5"></svg>
                        ê²Œì„ìœ¼ë¡œ
                    </button>
                </div>
            `;
        };

        const renderRanking = (data, loading) => {
            let content = '';
            if (loading) {
                content = '<div class="p-8 text-center text-purple-300"><svg data-lucide="loader-2" class="animate-spin inline w-8 h-8 mr-2"></svg>ë¡œë”© ì¤‘...</div>';
            } else if (data.length === 0) {
                content = '<p class="text-center text-purple-300 p-8">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤!</p>';
            } else {
                const sortedData = [...data].sort((a, b) => {
                    if (a.moves === b.moves) return new Date(a.time) - new Date(b.time);
                    return a.moves - b.moves;
                });
                content = sortedData.map((r, i) => {
                    const isMe = r.uid === userId;
                    const medalEmoji = i === 0 ? 'ğŸ¥‡' : i === 1 ? 'ğŸ¥ˆ' : i === 2 ? 'ğŸ¥‰' : '';
                    const rankColors = i === 0 ? 'from-yellow-500/20 to-orange-500/20 border-yellow-500' : 
                                       i === 1 ? 'from-gray-400/20 to-gray-500/20 border-gray-400' :
                                       i === 2 ? 'from-amber-600/20 to-amber-700/20 border-amber-600' : '';
                    return `
                        <div class="flex justify-between items-center p-4 rounded-lg transition ${isMe ? 'bg-gradient-to-r from-purple-500/30 to-pink-500/30 border-2 border-purple-400 shadow-lg' : i < 3 ? `bg-gradient-to-r ${rankColors} border-2` : 'glass-effect hover:bg-white/20'} mb-2">
                            <div class="flex items-center gap-4 flex-1">
                                <span class="text-2xl font-bold ${i < 3 ? 'text-yellow-400' : 'text-purple-300'} w-12 text-center">
                                    ${medalEmoji || `${i + 1}.`}
                                </span>
                                <span class="text-3xl">${r.avatar || 'ğŸ˜Š'}</span>
                                <div class="flex-1">
                                    <span class="text-sm md:text-base font-semibold ${isMe ? 'text-yellow-300' : 'text-white'}">
                                        ${r.name || 'ìµëª…'}
                                    </span>
                                    ${isMe ? ' <span class="text-xs bg-purple-600 text-white px-2 py-1 rounded-full ml-2">ë‚˜</span>' : ''}
                                </div>
                            </div>
                            <div class="text-right">
                                <span class="text-xl md:text-2xl font-mono ${isMe ? 'text-yellow-400' : i < 3 ? 'text-yellow-300' : 'text-purple-300'} font-bold">
                                    ${r.moves}
                                </span>
                                <span class="text-xs text-purple-300 block">íšŒ</span>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            root.innerHTML = `
                <div class="p-6 min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900">
                    <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-400 mb-2 text-center">ğŸ† ëª…ì˜ˆì˜ ì „ë‹¹</h1>
                    <p class="text-center text-purple-200 mb-8">ìµœì†Œ ì‹œë„ íšŸìˆ˜ë¡œ í´ë¦¬ì–´í•œ ë­í‚¹</p>
                    
                    <div class="glass-effect-strong p-6 rounded-2xl shadow-2xl w-full max-w-2xl mx-auto border border-purple-500">
                        <div class="flex items-center justify-center gap-2 mb-6 pb-4 border-b border-purple-500/50">
                            <svg data-lucide="trophy" class="w-6 h-6 text-yellow-400"></svg>
                            <h2 class="text-2xl font-bold text-white">TOP 20</h2>
                        </div>
                        <div class="space-y-0 max-h-96 overflow-y-auto pr-2">
                            ${content}
                        </div>
                        ${playerName ? `
                            <div class="mt-6 pt-6 border-t border-purple-500/50 text-center">
                                <div class="flex items-center justify-center gap-3 glass-effect p-4 rounded-lg">
                                    <span class="text-3xl">${playerAvatar}</span>
                                    <div class="text-left">
                                        <p class="text-xs text-purple-300">í˜„ì¬ í”Œë ˆì´ì–´</p>
                                        <p class="font-bold text-white">${playerName}</p>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    
                    <button onclick="navigate('game')" class="mt-8 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transition flex items-center mx-auto gap-2">
                        <svg data-lucide="arrow-left" class="w-5 h-5"></svg>
                        ê²Œì„ìœ¼ë¡œ
                    </button>
                </div>
            `;
        };

        const render = () => {
            if (!isReady) return;
            switch (page) {
                case 'main': renderMain(); break;
                case 'selectNickname': renderSelectNickname(); break;
                case 'selectAvatar': renderSelectAvatar(); break;
                case 'profile': renderProfile(); break;
                case 'game': renderGame(); break;
                case 'cards': renderCards(); break;
                case 'ai': 
                    renderAI();
                    if (!quiz && !processing) makeQuiz();
                    break;
                case 'ranking':
                    renderRanking([], true);
                    watchRanking();
                    break;
                default: renderMain();
            }
            if (window.createIcons && window.icons) {
                window.createIcons({ icons: window.icons });
            }
        };

        // ============================================
        // ì´ˆê¸°í™”
        // ============================================
        async function init() {
            if (!config.firebase) {
                userId = crypto.randomUUID();
                isReady = true;
                render();
                return;
            }
            app = initializeApp(config.firebase);
            db = getFirestore(app);
            auth = getAuth(app);

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                } else {
                    userId = crypto.randomUUID();
                }
                playerName = localStorage.getItem(`playerName_${userId}`) || '';
                playerAvatar = localStorage.getItem(`playerAvatar_${userId}`) || 'ğŸ˜Š';
                points = parseInt(localStorage.getItem(`points_${userId}`)) || 0;
                const savedOwned = localStorage.getItem(`ownedAvatars_${userId}`);
                ownedAvatars = new Set(savedOwned ? JSON.parse(savedOwned) : [...FREE_AVATARS]);
                isReady = true;
                render();
            });
        }

        // ============================================
        // ì „ì—­ í•¨ìˆ˜ ë“±ë¡
        // ============================================
        window.clickCard = clickCard;
        window.startGame = startGame;
        window.navigate = navigate;
        window.makeQuiz = makeQuiz;
        window.submitAnswer = submitAnswer;
        window.showAdminLogin = showAdminLogin;
        window.closeAdminLogin = closeAdminLogin;
        window.closeAdminMenus = closeAdminMenus;
        window.verifyAdminPassword = verifyAdminPassword;
        window.giveAdminPoints = giveAdminPoints;
        window.adminClearGame = adminClearGame;
        window.loginWithGoogle = loginWithGoogle;
        window.loginAsGuest = loginAsGuest;
        window.setNickname = setNickname;
        window.selectAvatar = selectAvatar;
        window.buyAvatar = buyAvatar;
        window.selectCard = (index) => {
            selectedCard = ITEMS[index];
            renderCards();
        };
        window.learnCard = () => {
            if (selectedCard) {
                navigate('ai');
                setTimeout(() => makeQuiz(selectedCard), 100);
            }
        };
        window.resetQuizzes = () => {
            solvedQuizzes.clear();
            quiz = null;
            feedback = null;
            renderAI();
        };

        window.onload = init;
    </script>
</body>
</html>