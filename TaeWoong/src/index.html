<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K-Everything Memory Game</title>
    <link rel="icon" href="../favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Backend API Configuration -->
    <script>
        // ë°±ì—”ë“œ API URL
        const API_BASE_URL = 'http://localhost:5000/api';

        // ì¸ì¦ í† í° ì €ì¥/ë¡œë“œ
        let authToken = localStorage.getItem('auth_token');

        // API í˜¸ì¶œ í—¬í¼ í•¨ìˆ˜
        const apiCall = async (endpoint, options = {}) => {
            const headers = {
                'Content-Type': 'application/json',
                ...options.headers
            };

            if (authToken) {
                headers['Authorization'] = `Bearer ${authToken}`;
            }

            const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                ...options,
                headers
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || 'API ìš”ì²­ ì‹¤íŒ¨');
            }

            return response.json();
        };

        window.API_BASE_URL = API_BASE_URL;
        window.apiCall = apiCall;
    </script>

    <style>
        /* ì¹´ë“œ í”Œë¦½ ì• ë‹ˆë©”ì´ì…˜ */
        .perspective { perspective: 1000px; }
        .transform-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .flip { transform: rotateY(180deg); }
        .card-transition { transition: transform 0.6s; }

        /* íŒì—… ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes pop {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .pop-in { animation: pop 0.3s ease-out forwards; }

        /* ì ê¸ˆ íš¨ê³¼ */
        .locked { filter: grayscale(100%) brightness(0.6); pointer-events: none; }

        /* ì¤‘ì•™ ì •ë ¬ */
        .text-center { text-align: center; }

        /* í”„ë¡œí•„ ì•„ë°”íƒ€ ì„ íƒ ì• ë‹ˆë©”ì´ì…˜ */
        .profile-selected {
            transform: scale(1.1);
            box-shadow: 0 0 0 3px #6366f1;
        }

        /* í”„ë¡œí•„ ë“œë¡­ë‹¤ìš´ */
        .profile-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 0.5rem;
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            min-width: 200px;
            z-index: 50;
        }
        .profile-dropdown.show {
            display: block;
        }
        .profile-image {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s;
        }
        .profile-image:hover {
            transform: scale(1.1);
        }

        /* ì»¬ë ‰ì…˜ ìƒì„¸ ëª¨ë‹¬ */
        .collection-modal-backdrop {
            position: fixed;
            inset: 0;
            z-index: 100;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .collection-modal-card {
            position: relative;
            width: 90vw;
            max-width: 400px;
            aspect-ratio: 0.7;
            transition: transform 0.8s cubic-bezier(0.25, 1, 0.5, 1);
            transform-style: preserve-3d;
            transform: scale(0.5) rotateY(0deg);
        }
        .collection-modal-card.is-visible {
            transform: scale(1) rotateY(0deg);
        }
        .collection-modal-card.is-flipped {
            transform: scale(1.2) rotateY(180deg);
        }
        .collection-card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        .collection-card-front {
            background: white;
            cursor: pointer;
        }
        .collection-card-back {
            background-color: #1f2937; /* bg-gray-800 */
            color: white;
            transform: rotateY(180deg);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        /* ëª¨ë‹¬ ë°°ê²½ */
        .modal-backdrop {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50">

    <div id="app" class="min-h-screen">
        <!-- ë¡œë”© í™”ë©´ -->
        <div class="flex flex-col justify-center items-center h-screen">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-purple-500"></div>
            <p class="mt-4 text-xl text-gray-700">ë¡œë”© ì¤‘...</p>
        </div>
    </div>

    <script type="module">
        // ===================================
        // ì „ì—­ ìƒíƒœ
        // ===================================
        let STAGES_DATA = null;
        let currentStage = 1;
        let unlockedStages = [1];
        let completedStages = []; // ì™„ë£Œëœ ìŠ¤í…Œì´ì§€
        let playerName = '';
        let playerNameSet = false;
        let playerAvatar = 'ğŸ˜Š'; // í”Œë ˆì´ì–´ ì•„ë°”íƒ€

        // ì½”ì¸ & í”„ë¡œí•„ ì‹œìŠ¤í…œ
        let coins = 0;
        let viewedCollections = new Set(); // ë³¸ ì»¬ë ‰ì…˜ (ì½”ì¸ íšë“)
        let purchasedAvatars = new Set(['ğŸ˜Š']); // êµ¬ë§¤í•œ ì•„ë°”íƒ€ (ê¸°ë³¸ í¬í•¨)

        // í”„ë¡œí•„ ì•„ë°”íƒ€ ìƒì 
        const AVATAR_SHOP = [
            { id: 'ğŸ˜Š', name: 'ê¸°ë³¸', price: 0, category: 'free' },
            { id: 'ğŸ˜', name: 'ë©‹ì§', price: 10, category: 'basic' },
            { id: 'ğŸ¥³', name: 'íŒŒí‹°', price: 10, category: 'basic' },
            { id: 'ğŸ¤“', name: 'ë˜‘ë˜‘', price: 10, category: 'basic' },
            { id: 'ğŸ˜‡', name: 'ì²œì‚¬', price: 15, category: 'basic' },
            { id: 'ğŸ¤—', name: 'í¬ì˜¹', price: 15, category: 'basic' },
            { id: 'ğŸ¥°', name: 'ì‚¬ë‘', price: 15, category: 'basic' },
            { id: 'ğŸ‘‘', name: 'ì™•ê´€', price: 50, category: 'premium' },
            { id: 'ğŸ¦„', name: 'ìœ ë‹ˆì½˜', price: 50, category: 'premium' },
            { id: 'ğŸ‰', name: 'ë“œë˜ê³¤', price: 50, category: 'premium' },
            { id: 'ğŸ’', name: 'ë‹¤ì´ì•„', price: 100, category: 'legendary' },
            { id: 'ğŸ†', name: 'íŠ¸ë¡œí”¼', price: 100, category: 'legendary' },
            { id: 'ğŸš€', name: 'ë¡œì¼“', price: 100, category: 'legendary' }
        ];

        // ì‚¬ìš©ì ì •ë³´
        let currentUser = null;
        let userProfile = {
            uid: null,
            email: null,
            displayName: null,
            photoURL: null
        };

        // ê²Œì„ ìƒíƒœ
        let cards = [];
        let flipped = [];
        let matched = [];
        let moves = 0;
        let isWon = false;
        let canClick = true;
        let currentPage = 'welcome'; // welcome, stages, game, collection, ranking, shop, quiz
        let selectedCollectionItem = null; // ì„ íƒëœ ì»¬ë ‰ì…˜ ì•„ì´í…œ (ìƒì„¸ë³´ê¸°)

        // AI í€´ì¦ˆ ìƒíƒœ
        let quizState = {
            conversation: [], // { role: 'ai' | 'user', content: '...', options: [...] }
            loading: false,
            currentQuestion: null // { question: '...', options: [...], answer: '...', questionContext: {...} }
        };

        // ë­í‚¹ ë°ì´í„° (ë©”ëª¨ë¦¬)
        let rankingData = [
            { name: 'ê¹€ë¯¼ìˆ˜', stage: 'ì˜í™”', moves: 18 },
            { name: 'ì´ì„œì—°', stage: 'ìŒì‹', moves: 22 },
            { name: 'ë°•ì§€í›ˆ', stage: 'ì˜í™”', moves: 25 },
        ];

        const appContainer = document.getElementById('app');

        // ===================================
        // ë°ì´í„° ë¡œë“œ
        // ===================================
        async function loadData() {
            try {
                const response = await fetch('../data/stages.json');
                STAGES_DATA = await response.json();

                // í† í°ì´ ìˆìœ¼ë©´ ë°±ì—”ë“œì—ì„œ ë°ì´í„° ë¡œë“œ
                if (authToken) {
                    try {
                        const userData = await apiCall('/auth/me');
                        currentUser = userData.user;
                        if (userData.progress) {
                            unlockedStages = JSON.parse(userData.progress.unlocked_stages) || [1];
                            completedStages = JSON.parse(userData.progress.completed_stages) || [];
                            currentStage = userData.progress.current_stage || 1;
                            playerAvatar = userData.progress.player_avatar || 'ğŸ˜Š';
                            playerName = currentUser.name;
                            playerNameSet = true;
                            currentPage = 'stages';
                        }
                    } catch (error) {
                        console.error('ë°±ì—”ë“œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                        // ì‹¤íŒ¨ì‹œ ë¡œì»¬ ì €ì¥ì†Œì—ì„œ ë¡œë“œ
                        loadFromLocalStorage();
                    }
                } else {
                    // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì—ì„œ ì§„í–‰ë„ ë¶ˆëŸ¬ì˜¤ê¸°
                    loadFromLocalStorage();
                }

                const savedRanking = localStorage.getItem('ranking_data');
                if (savedRanking) {
                    rankingData = JSON.parse(savedRanking);
                }
            } catch (error) {
                console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem('game_progress');
            if (saved) {
                const progress = JSON.parse(saved);
                unlockedStages = progress.unlockedStages || [1];
                completedStages = progress.completedStages || [];
                currentStage = progress.currentStage || 1;
                playerName = progress.playerName || '';
                playerNameSet = progress.playerNameSet || false;
                coins = progress.coins || 0;
                viewedCollections = new Set(progress.viewedCollections || []);
                purchasedAvatars = new Set(progress.purchasedAvatars || ['ğŸ˜Š']);
            }
        }

        // ===================================
        // ì €ì¥ í•¨ìˆ˜
        // ===================================
        const saveProgress = () => {
            // ë¡œì»¬ ì €ì¥ì†Œì— ì €ì¥ (1íšŒìš© ë¡œê·¸ì¸)
            localStorage.setItem('game_progress', JSON.stringify({
                unlockedStages,
                completedStages,
                currentStage,
                playerName,
                playerNameSet,
                coins,
                viewedCollections: Array.from(viewedCollections),
                purchasedAvatars: Array.from(purchasedAvatars)
            }));

            // ë¡œê·¸ì¸ ìƒíƒœë©´ ë°±ì—”ë“œ DBì—ë„ ì €ì¥
            if (authToken && currentUser) {
                saveUserData();
            }
        };

        const saveRanking = () => {
            localStorage.setItem('ranking_data', JSON.stringify(rankingData));
        };

        // ===================================
        // íšŒì›ê°€ì…/ë¡œê·¸ì¸ í•¨ìˆ˜
        // ===================================
        const signup = async (email, password, name, avatar) => {
            try {
                const response = await apiCall('/auth/signup', {
                    method: 'POST',
                    body: JSON.stringify({ email, password, name, avatar })
                });

                authToken = response.token;
                localStorage.setItem('auth_token', authToken);

                currentUser = response.user;
                userProfile = {
                    uid: currentUser.id,
                    email: currentUser.email,
                    displayName: currentUser.name,
                    photoURL: null
                };

                playerName = currentUser.name;
                playerAvatar = currentUser.avatar;
                playerNameSet = true;

                await loadUserData();

                console.log('íšŒì›ê°€ì… ì„±ê³µ:', playerName);
                currentPage = 'stages';
                render();
            } catch (error) {
                alert(error.message || 'íšŒì›ê°€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                console.error('íšŒì›ê°€ì… ì‹¤íŒ¨:', error);
            }
        };

        const login = async (email, password) => {
            try {
                const response = await apiCall('/auth/login', {
                    method: 'POST',
                    body: JSON.stringify({ email, password })
                });

                authToken = response.token;
                localStorage.setItem('auth_token', authToken);

                currentUser = response.user;
                userProfile = {
                    uid: currentUser.id,
                    email: currentUser.email,
                    displayName: currentUser.name,
                    photoURL: null
                };

                playerName = currentUser.name;
                playerAvatar = currentUser.avatar;
                playerNameSet = true;

                await loadUserData();

                console.log('ë¡œê·¸ì¸ ì„±ê³µ:', playerName);
                currentPage = 'stages';
                render();
            } catch (error) {
                alert(error.message || 'ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                console.error('ë¡œê·¸ì¸ ì‹¤íŒ¨:', error);
            }
        };

        const signOutUser = async () => {
            try {
                await apiCall('/auth/logout', { method: 'POST' });
                authToken = null;
                localStorage.removeItem('auth_token');
                currentUser = null;
                userProfile = {
                    uid: null,
                    email: null,
                    displayName: null,
                    photoURL: null
                };
                render();
            } catch (error) {
                console.error('ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨:', error);
            }
        };

        const loadUserData = async () => {
            if (!authToken) return;

            try {
                const data = await apiCall('/game/progress');
                unlockedStages = data.unlockedStages || [1];
                completedStages = data.completedStages || [];
                currentStage = data.currentStage || 1;
                playerName = data.playerName || userProfile.displayName;
                playerNameSet = !!playerName;
            } catch (error) {
                console.error('ì‚¬ìš©ì ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        };

        const saveUserData = async () => {
            if (!authToken) return;

            try {
                await apiCall('/game/progress', {
                    method: 'POST',
                    body: JSON.stringify({
                        currentStage,
                        unlockedStages,
                        completedStages,
                        playerAvatar
                    })
                });
            } catch (error) {
                console.error('ì‚¬ìš©ì ë°ì´í„° ì €ì¥ ì‹¤íŒ¨:', error);
            }
        };

        // ===================================
        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
        // ===================================
        const shuffleArray = (array) => {
            const arr = [...array];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        };

        const goToPage = (page) => {
            currentPage = page;
            if (page === 'quiz') {
                startQuiz();
            }
            render();
        };

        const setPlayerName = async (name) => {
            playerName = name.trim() || 'ìµëª…';
            playerNameSet = true;

            console.log('ê²ŒìŠ¤íŠ¸ ëª¨ë“œë¡œ ì‹œì‘:', playerName);

            saveProgress();
            goToPage('stages');
        };

        // ===================================
        // ê²Œì„ ë¡œì§
        // ===================================
        const initializeGame = (stageId) => {
            currentStage = stageId;
            const stage = STAGES_DATA.stages.find(s => s.id === stageId);
            if (!stage) return;

            const items = stage.items;
            const pairs = [...items, ...items].map((item, index) => ({
                ...item,
                id: index,
                pairId: item.idx
            }));

            cards = shuffleArray(pairs);
            flipped = [];
            matched = [];
            moves = 0;
            isWon = false;
            canClick = true;

            currentPage = 'game';
            renderGame();
        };

        const handleCardClick = (cardId) => {
            if (!canClick || flipped.length === 2 || flipped.includes(cardId) || matched.includes(cardId) || isWon) {
                return;
            }

            flipped.push(cardId);
            renderGame();

            if (flipped.length === 2) {
                canClick = false;
                moves++;
                renderGame();

                const [firstId, secondId] = flipped;
                const card1 = cards.find(c => c.id === firstId);
                const card2 = cards.find(c => c.id === secondId);

                if (card1 && card2 && card1.pairId === card2.pairId) {
                    matched.push(firstId, secondId);
                    flipped = [];
                    canClick = true;

                    if (matched.length === cards.length) {
                        isWon = true;

                        // í˜„ì¬ ìŠ¤í…Œì´ì§€ ì™„ë£Œ ì²˜ë¦¬
                        if (!completedStages.includes(currentStage)) {
                            completedStages.push(currentStage);
                        }

                        // ë‹¤ìŒ ìŠ¤í…Œì´ì§€ ì ê¸ˆ í•´ì œ
                        if (currentStage < 3 && !unlockedStages.includes(currentStage + 1)) {
                            unlockedStages.push(currentStage + 1);
                        }

                        // ë­í‚¹ì— ì¶”ê°€
                        const stage = STAGES_DATA.stages.find(s => s.id === currentStage);
                        rankingData.push({
                            name: playerName,
                            stage: stage.name,
                            moves: moves
                        });
                        rankingData.sort((a, b) => a.moves - b.moves);
                        if (rankingData.length > 20) rankingData = rankingData.slice(0, 20);

                        saveProgress();
                        saveRanking();
                    }
                    renderGame();
                } else {
                    setTimeout(() => {
                        flipped = [];
                        canClick = true;
                        renderGame();
                    }, 1000);
                }
            }
        };

        // ===================================
        // AI í€´ì¦ˆ ë¡œì§
        // ===================================
        const startQuiz = async () => {
            // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
            if (!authToken) {
                quizState.conversation = [{
                    role: 'ai',
                    content: 'ì½”ì¸ ì±„êµ´ í€´ì¦ˆëŠ” ë¡œê·¸ì¸í•œ ì‚¬ìš©ìë§Œ ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'
                }];
                quizState.loading = false;
                render();
                return;
            }

            quizState.loading = true;
            quizState.conversation = [];
            render();

            try {
                const unlockedCards = STAGES_DATA.stages
                    .filter(stage => completedStages.includes(stage.id))
                    .flatMap(stage => stage.items.map(item => ({ ...item, stageName: stage.name })));

                if (unlockedCards.length === 0) {
                    quizState.conversation.push({
                        role: 'ai',
                        content: 'í€´ì¦ˆë¥¼ ë§Œë“¤ë ¤ë©´ ë¨¼ì € ìŠ¤í…Œì´ì§€ë¥¼ í•˜ë‚˜ ì´ìƒ í´ë¦¬ì–´í•´ì•¼ í•©ë‹ˆë‹¤.'
                    });
                    quizState.loading = false;
                    render();
                    return;
                }

                const { question, options, answer, questionContext } = await apiCall('/ai/quiz', {
                    method: 'POST',
                    body: JSON.stringify({ unlockedCards })
                });

                quizState.currentQuestion = { question, options, answer, questionContext };
                quizState.conversation.push({ role: 'ai', content: question, options: options });
            } catch (error) {
                quizState.conversation.push({ role: 'ai', content: `ì˜¤ë¥˜: ${error.message}` });
            } finally {
                quizState.loading = false;
                render();
            }
        };

        const sendAnswer = async () => {
            const answerInput = document.getElementById('answerInput');
            const answer = answerInput.value.trim();

            if (!answer || quizState.loading) return;

            quizState.loading = true;
            quizState.conversation.push({ role: 'user', content: answer });
            answerInput.value = '';
            render();

            try {
                const { isCorrect, reward, explanation } = await apiCall('/ai/answer', {
                    method: 'POST',
                    body: JSON.stringify({
                        answer,
                        question: quizState.currentQuestion.question,
                        options: quizState.currentQuestion.options,
                        correctAnswer: quizState.currentQuestion.answer,
                        questionContext: quizState.currentQuestion.questionContext
                    })
                });

                quizState.conversation.push({ role: 'ai', content: explanation });

                if (isCorrect) {
                    coins += reward;
                    saveProgress();
                    quizState.conversation.push({ role: 'ai', content: `ğŸ‰ ì •ë‹µì…ë‹ˆë‹¤! ${reward} ì½”ì¸ì„ íšë“í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ìƒˆë¡œìš´ ì§ˆë¬¸ì„ ë³´ë‚´ë“œë¦½ë‹ˆë‹¤.` });
                    render();
                    setTimeout(startQuiz, 3000); // 3ì´ˆ í›„ ìƒˆ í€´ì¦ˆ ì‹œì‘
                    return;
                } else {
                    quizState.conversation.push({ role: 'ai', content: 'ë‹¤ìŒ ì§ˆë¬¸ì„ ì›í•˜ì‹œë©´ \'ë‹¤ìŒ\'ì´ë¼ê³  ì…ë ¥í•´ì£¼ì„¸ìš”.' });
                }

            } catch (error) {
                quizState.conversation.push({ role: 'ai', content: `ì˜¤ë¥˜: ${error.message}` });
            } finally {
                quizState.loading = false;
                render();
            }
        };

        // ===================================
        // ë Œë”ë§ í•¨ìˆ˜
        // ===================================
        const renderHeader = () => {
            const coinDisplay = `
                <div class="fixed top-4 left-4 z-50 flex items-center gap-2 px-4 py-2 bg-yellow-100 border-2 border-yellow-400 rounded-full shadow-lg">
                    <span class="text-2xl">ğŸª™</span>
                    <span class="font-bold text-yellow-900">${coins}</span>
                </div>
            `;

            if (!currentUser) {
                return coinDisplay;
            }

            return `
                ${coinDisplay}
                <div class="fixed top-4 right-4 z-50">
                    <div class="relative">
                        <img
                            src="${userProfile.photoURL || 'https://via.placeholder.com/40'}"
                            alt="Profile"
                            class="profile-image"
                            onclick="window.toggleProfileDropdown()"
                        />
                        <div id="profileDropdown" class="profile-dropdown">
                            <div class="p-4 border-b border-gray-100">
                                <p class="font-bold text-gray-800">${userProfile.displayName || 'Unknown User'}</p>
                                <p class="text-sm text-gray-500">${userProfile.email || ''}</p>
                            </div>
                            <div class="p-2">
                                <button
                                    onclick="window.signOutUser()"
                                    class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 rounded-md transition-colors"
                                >
                                    ë¡œê·¸ì•„ì›ƒ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        window.toggleProfileDropdown = () => {
            const dropdown = document.getElementById('profileDropdown');
            if (dropdown) {
                dropdown.classList.toggle('show');
            }
        };

        // ë“œë¡­ë‹¤ìš´ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
        document.addEventListener('click', (e) => {
            const dropdown = document.getElementById('profileDropdown');
            const profileImage = document.querySelector('.profile-image');
            if (dropdown && profileImage && !profileImage.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.classList.remove('show');
            }
        });

        let welcomeMode = 'initial'; // 'initial', 'guest', 'login', 'signup'

        const renderWelcome = () => {
            const PROFILE_AVATARS = ['ğŸ˜Š', 'ğŸ˜', 'ğŸ¥³', 'ğŸ¤“', 'ğŸ˜‡', 'ğŸ¤—', 'ğŸ¥°', 'ğŸ˜', 'ğŸ™‚', 'ğŸ˜„', 'ğŸ˜ƒ', 'ğŸ˜€', 'ğŸ¤©', 'ğŸ˜', 'ğŸ¥¸', 'ğŸ˜'];

            const profileGrid = PROFILE_AVATARS.map((avatar) => `
                <button onclick="window.selectAvatar('${avatar}')" class="w-12 h-12 text-2xl rounded-full border-2 border-gray-300 hover:border-indigo-400 transition-all duration-200 ${playerAvatar === avatar ? 'profile-selected border-indigo-500' : ''}">
                    ${avatar}
                </button>
            `).join('');

            let formContent = '';

            if (welcomeMode === 'initial') {
                formContent = `
                    <div class="space-y-4">
                        <button
                            onclick="window.switchMode('guest')"
                            class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-4 px-6 rounded-lg shadow-lg transition transform hover:scale-105"
                        >
                            ê²ŒìŠ¤íŠ¸ë¡œ ì‹œì‘í•˜ê¸°
                        </button>

                        <div class="flex gap-2">
                            <button
                                onclick="window.switchMode('login')"
                                class="flex-1 bg-white border-2 border-indigo-500 hover:bg-indigo-50 text-indigo-600 font-bold py-3 px-4 rounded-lg transition"
                            >
                                ë¡œê·¸ì¸
                            </button>
                            <button
                                onclick="window.switchMode('signup')"
                                class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition"
                            >
                                íšŒì›ê°€ì…
                            </button>
                        </div>
                    </div>
                `;
            } else if (welcomeMode === 'guest') {
                formContent = `
                    <div class="mb-6">
                        <label class="block text-left text-sm font-semibold text-gray-700 mb-2">
                            í”„ë¡œí•„ ì•„ë°”íƒ€ ì„ íƒ
                        </label>
                        <div class="grid grid-cols-8 gap-2 mb-4 p-3 bg-gray-50 rounded-lg">
                            ${profileGrid}
                        </div>

                        <label class="block text-left text-sm font-semibold text-gray-700 mb-2">
                            ë‹‰ë„¤ì„ ì…ë ¥
                        </label>
                        <input
                            type="text"
                            id="playerNameInput"
                            class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition"
                            placeholder="ì˜ˆ: í™ê¸¸ë™"
                            maxlength="10"
                        />
                    </div>

                    <button
                        onclick="window.startGameAsGuest()"
                        class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-4 px-6 rounded-lg shadow-lg transition transform hover:scale-105 mb-3"
                    >
                        ê²Œì„ ì‹œì‘ (ë°ì´í„° ì €ì¥ ì•ˆë¨)
                    </button>

                    <button
                        onclick="window.switchMode('initial')"
                        class="w-full bg-white border-2 border-gray-300 hover:border-indigo-500 text-gray-700 font-bold py-3 px-4 rounded-lg transition"
                    >
                        ë’¤ë¡œ ê°€ê¸°
                    </button>
                `;
            } else if (welcomeMode === 'login') {
                formContent = `
                    <div class="mb-6 space-y-4">
                        <div>
                            <label class="block text-left text-sm font-semibold text-gray-700 mb-2">
                                ì´ë©”ì¼
                            </label>
                            <input
                                type="email"
                                id="emailInput"
                                class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition"
                                placeholder="example@email.com"
                            />
                        </div>

                        <div>
                            <label class="block text-left text-sm font-semibold text-gray-700 mb-2">
                                ë¹„ë°€ë²ˆí˜¸
                            </label>
                            <input
                                type="password"
                                id="passwordInput"
                                class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition"
                                placeholder="ë¹„ë°€ë²ˆí˜¸"
                            />
                        </div>
                    </div>

                    <button
                        onclick="window.submitLogin()"
                        class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-4 px-6 rounded-lg shadow-lg transition transform hover:scale-105 mb-3"
                    >
                        ë¡œê·¸ì¸
                    </button>

                    <button
                        onclick="window.switchMode('initial')"
                        class="w-full bg-white border-2 border-gray-300 hover:border-indigo-500 text-gray-700 font-bold py-3 px-4 rounded-lg transition"
                    >
                        ë’¤ë¡œ ê°€ê¸°
                    </button>
                `;
            } else if (welcomeMode === 'signup') {
                formContent = `
                    <div class="mb-6 space-y-4">
                        <div>
                            <label class="block text-left text-sm font-semibold text-gray-700 mb-2">
                                í”„ë¡œí•„ ì•„ë°”íƒ€ ì„ íƒ
                            </label>
                            <div class="grid grid-cols-8 gap-2 p-3 bg-gray-50 rounded-lg">
                                ${profileGrid}
                            </div>
                        </div>

                        <div>
                            <label class="block text-left text-sm font-semibold text-gray-700 mb-2">
                                ì´ë©”ì¼
                            </label>
                            <input
                                type="email"
                                id="emailInput"
                                class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition"
                                placeholder="example@email.com"
                            />
                        </div>

                        <div>
                            <label class="block text-left text-sm font-semibold text-gray-700 mb-2">
                                ë¹„ë°€ë²ˆí˜¸
                            </label>
                            <input
                                type="password"
                                id="passwordInput"
                                class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition"
                                placeholder="ë¹„ë°€ë²ˆí˜¸ (ìµœì†Œ 6ì)"
                            />
                        </div>

                        <div>
                            <label class="block text-left text-sm font-semibold text-gray-700 mb-2">
                                ë‹‰ë„¤ì„
                            </label>
                            <input
                                type="text"
                                id="nameInput"
                                class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition"
                                placeholder="ë‹‰ë„¤ì„"
                                maxlength="10"
                            />
                        </div>
                    </div>

                    <button
                        onclick="window.submitSignup()"
                        class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-4 px-6 rounded-lg shadow-lg transition transform hover:scale-105 mb-3"
                    >
                        íšŒì›ê°€ì…
                    </button>

                    <button
                        onclick="window.switchMode('initial')"
                        class="w-full bg-white border-2 border-gray-300 hover:border-indigo-500 text-gray-700 font-bold py-3 px-4 rounded-lg transition"
                    >
                        ë’¤ë¡œ ê°€ê¸°
                    </button>
                `;
            }

            appContainer.innerHTML = `
                <div class="min-h-screen flex flex-col items-center justify-center bg-gradient-to-br from-pink-100 via-purple-100 to-indigo-100 p-4">
                    <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md">
                        <div class="mb-6 text-center">
                            <div class="text-6xl mb-4">ğŸ®</div>
                            <h1 class="text-4xl font-extrabold text-indigo-600 mb-2">
                                K-Everything<br>Memory Game
                            </h1>
                            <p class="text-gray-600">í•œêµ­ ë¬¸í™”ì¬, ìŒì‹, ì˜í™”ë¥¼ ë°°ìš°ëŠ” ì¹´ë“œ ê²Œì„</p>
                        </div>

                        ${formContent}

                        <div class="mt-6 pt-6 border-t border-gray-200 text-center">
                            <p class="text-sm text-gray-600 mb-3">ğŸ“š ê²Œì„ ë°©ë²•</p>
                            <div class="text-xs text-gray-500 space-y-1">
                                <p>â€¢ ê°™ì€ ì¹´ë“œë¥¼ ì°¾ì•„ ë§ì¶”ì„¸ìš”</p>
                                <p>â€¢ ìŠ¤í…Œì´ì§€ë¥¼ í´ë¦¬ì–´í•˜ë©´ ë‹¤ìŒ ë‹¨ê³„ ì ê¸ˆ í•´ì œ</p>
                                <p>â€¢ íšŒì›ê°€ì…í•˜ë©´ ë°ì´í„°ê°€ ì €ì¥ë©ë‹ˆë‹¤</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Enter í‚¤ ì´ë²¤íŠ¸
            setTimeout(() => {
                if (welcomeMode === 'guest') {
                    const input = document.getElementById('playerNameInput');
                    if (input) {
                        input.focus();
                        input.addEventListener('keypress', (e) => {
                            if (e.key === 'Enter') window.startGameAsGuest();
                        });
                    }
                } else if (welcomeMode === 'login') {
                    const emailInput = document.getElementById('emailInput');
                    const passwordInput = document.getElementById('passwordInput');

                    if (emailInput) {
                        emailInput.focus();
                        emailInput.addEventListener('keypress', (e) => {
                            if (e.key === 'Enter') {
                                if (passwordInput) passwordInput.focus();
                            }
                        });
                    }

                    if (passwordInput) {
                        passwordInput.addEventListener('keypress', (e) => {
                            if (e.key === 'Enter') window.submitLogin();
                        });
                    }
                } else if (welcomeMode === 'signup') {
                    const emailInput = document.getElementById('emailInput');
                    const passwordInput = document.getElementById('passwordInput');
                    const nameInput = document.getElementById('nameInput');

                    if (emailInput) {
                        emailInput.focus();
                        emailInput.addEventListener('keypress', (e) => {
                            if (e.key === 'Enter' && passwordInput) passwordInput.focus();
                        });
                    }

                    if (passwordInput) {
                        passwordInput.addEventListener('keypress', (e) => {
                            if (e.key === 'Enter' && nameInput) nameInput.focus();
                        });
                    }

                    if (nameInput) {
                        nameInput.addEventListener('keypress', (e) => {
                            if (e.key === 'Enter') window.submitSignup();
                        });
                    }
                }
            }, 100);
        };

        const renderStages = () => {
            const stagesHtml = STAGES_DATA.stages.map(stage => {
                const isUnlocked = unlockedStages.includes(stage.id);
                const isCompleted = completedStages.includes(stage.id);

                return `
                    <div class="relative ${isUnlocked ? '' : 'locked'} bg-white rounded-2xl shadow-xl p-8 hover:shadow-2xl transition-all duration-300">
                        ${!isUnlocked ? '<div class="absolute top-4 right-4 text-xs px-3 py-1 bg-gray-400 rounded-full text-white font-bold">LOCK</div>' : ''}
                        ${isCompleted ? '<div class="absolute top-4 right-4 text-xs px-3 py-1 bg-green-500 rounded-full text-white font-bold">CLEAR</div>' : ''}

                        <div class="text-center mb-6">
                            <h2 class="text-3xl font-bold text-gray-800 mb-2">Stage ${stage.id}</h2>
                            <p class="text-xl text-gray-600">${stage.name}</p>
                        </div>

                        <div class="grid grid-cols-4 gap-2 mb-6">
                            ${stage.items.slice(0, 8).map(item => `
                                <div class="aspect-square bg-gray-100 rounded-lg overflow-hidden">
                                    <img src="../assets/img/${item.img}" alt="${item.title}" class="w-full h-full object-cover">
                                </div>
                            `).join('')}
                        </div>

                        <button
                            onclick="window.initializeGame(${stage.id})"
                            class="w-full py-3 px-6 rounded-lg font-bold text-white transition-all duration-300 ${
                                isUnlocked
                                    ? 'bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600'
                                    : 'bg-gray-400 cursor-not-allowed'
                            }"
                            ${!isUnlocked ? 'disabled' : ''}
                        >
                            ${isUnlocked ? 'ê²Œì„ ì‹œì‘' : 'ì ê¸ˆ'}
                        </button>
                    </div>
                `;
            }).join('');

            // ë¡œê·¸ì¸ ì•ˆë‚´ (ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ê²½ìš°)
            const loginAlert = !currentUser ? `
                <div class="max-w-3xl mx-auto mb-8">
                    <div class="bg-gradient-to-r from-green-50 to-blue-50 border-2 border-green-200 rounded-xl p-6 shadow-lg">
                        <div class="flex items-start gap-4">
                            <div class="text-4xl">âœ…</div>
                            <div class="flex-1">
                                <h3 class="text-lg font-bold text-green-900 mb-2">ê²ŒìŠ¤íŠ¸ ëª¨ë“œë¡œ í”Œë ˆì´ ì¤‘</h3>
                                <p class="text-sm text-green-700 mb-2">
                                    í˜„ì¬ ë¸Œë¼ìš°ì €ì— ê²Œì„ ê¸°ë¡ì´ ì„ì‹œ ì €ì¥ë©ë‹ˆë‹¤.<br>
                                    íšŒì›ê°€ì… ë˜ëŠ” ë¡œê·¸ì¸í•˜ë©´ ë°ì´í„°ë¥¼ ì˜êµ¬ì ìœ¼ë¡œ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            ` : '';

            appContainer.innerHTML = `
                ${renderHeader()}
                <div class="min-h-screen p-8">
                    <div class="max-w-7xl mx-auto">
                        <div class="text-center mb-12">
                            <h1 class="text-5xl font-bold text-gray-800 mb-4">K-Everything Memory Game</h1>
                            <div class="flex items-center justify-center gap-2 mb-2">
                                <span class="text-2xl">${playerAvatar}</span>
                                <p class="text-xl text-gray-600">${playerName}</p>
                            </div>
                            <p class="text-lg text-gray-500">í•œêµ­ ë¬¸í™”ì¬ë¶€í„° ìŒì‹, ì˜í™”ê¹Œì§€ ë‹¨ê³„ë³„ë¡œ ë„ì „í•´ë³´ì„¸ìš”</p>
                        </div>

                        ${loginAlert}

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-8">
                            ${stagesHtml}
                        </div>

                        <div class="flex justify-center gap-4 flex-wrap">
                            <button
                                onclick="window.goToPage('collection')"
                                class="py-3 px-8 rounded-lg font-bold text-white bg-gradient-to-r from-blue-500 to-indigo-500 hover:from-blue-600 hover:to-indigo-600 transition-all duration-300"
                            >
                                ë‚´ ì»¬ë ‰ì…˜ ë³´ê¸°
                            </button>
                            <button
                                onclick="window.goToPage('quiz')"
                                class="py-3 px-8 rounded-lg font-bold text-white bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-600 hover:to-blue-600 transition-all duration-300"
                            >
                                ğŸª™ ì½”ì¸ ì±„êµ´í•˜ê¸° (AI í€´ì¦ˆ)
                            </button>
                            <button
                                onclick="window.goToPage('shop')"
                                class="py-3 px-8 rounded-lg font-bold text-white bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 transition-all duration-300"
                            >
                                ğŸ›’ í”„ë¡œí•„ ìƒì 
                            </button>
                            <button
                                onclick="window.goToPage('ranking')"
                                class="py-3 px-8 rounded-lg font-bold text-white bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-600 hover:to-orange-600 transition-all duration-300"
                            >
                                ë­í‚¹ ë³´ê¸°
                            </button>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderCard = (card) => {
            const isFlipped = flipped.includes(card.id) || matched.includes(card.id);

            return `
                <div
                    class="perspective cursor-pointer"
                    onclick="window.handleCardClick(${card.id})"
                >
                    <div class="relative w-full aspect-square card-transition transform-3d ${isFlipped ? 'flip' : ''}">
                        <!-- ì¹´ë“œ ë’·ë©´ -->
                        <div class="absolute w-full h-full backface-hidden bg-gradient-to-br from-purple-500 to-pink-500 rounded-xl shadow-lg flex items-center justify-center">
                            <div class="text-6xl text-white font-bold">?</div>
                        </div>

                        <!-- ì¹´ë“œ ì•ë©´ -->
                        <div class="absolute w-full h-full backface-hidden flip bg-white rounded-xl shadow-lg overflow-hidden">
                            <img src="../assets/img/${card.img}" alt="${card.title}" class="w-full h-full object-cover">
                        </div>
                    </div>
                </div>
            `;
        };

        const renderGame = () => {
            const stage = STAGES_DATA.stages.find(s => s.id === currentStage);
            const totalPairs = cards.length / 2;
            const matchedPairs = matched.length / 2;

            const cardGrid = cards.map(renderCard).join('');

            let winModal = '';
            if (isWon) {
                const nextStage = currentStage + 1;
                const hasNext = nextStage <= 3;

                winModal = `
                    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div class="bg-white p-8 rounded-2xl shadow-2xl text-center pop-in max-w-md">
                            <h2 class="text-3xl font-bold text-green-600 mb-4">ì™„ë£Œ!</h2>
                            <p class="text-xl text-gray-700 mb-2">ì‹œë„ íšŸìˆ˜: ${moves}íšŒ</p>
                            <p class="text-lg text-gray-600 mb-6">${stage.name} ë‹¨ê³„ë¥¼ í´ë¦¬ì–´í–ˆìŠµë‹ˆë‹¤</p>

                            ${hasNext ? `
                                <button
                                    onclick="window.initializeGame(${nextStage})"
                                    class="w-full mb-3 py-3 px-6 rounded-lg font-bold text-white bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 transition-all duration-300"
                                >
                                    ë‹¤ìŒ ë‹¨ê³„ë¡œ
                                </button>
                            ` : `
                                <p class="text-lg font-bold text-purple-600 mb-4">ëª¨ë“  ë‹¨ê³„ë¥¼ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤!</p>
                            `}

                            <button
                                onclick="window.goToPage('stages')"
                                class="w-full py-3 px-6 rounded-lg font-bold text-gray-700 bg-gray-200 hover:bg-gray-300 transition-all duration-300"
                            >
                                ìŠ¤í…Œì´ì§€ ì„ íƒ
                            </button>
                        </div>
                    </div>
                `;
            }

            appContainer.innerHTML = `
                ${renderHeader()}
                <div class="min-h-screen p-4">
                    <div class="max-w-4xl mx-auto">
                        <!-- í—¤ë” -->
                        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
                            <div class="flex justify-between items-center mb-4">
                                <button
                                    onclick="window.goToPage('stages')"
                                    class="py-2 px-4 rounded-lg font-bold text-gray-700 bg-gray-200 hover:bg-gray-300 transition-all duration-300"
                                >
                                    ëŒì•„ê°€ê¸°
                                </button>

                                <div class="text-center">
                                    <h2 class="text-2xl font-bold text-gray-800">Stage ${currentStage}: ${stage.name}</h2>
                                </div>

                                <button
                                    onclick="window.initializeGame(${currentStage})"
                                    class="py-2 px-4 rounded-lg font-bold text-white bg-gradient-to-r from-red-500 to-pink-500 hover:from-red-600 hover:to-pink-600 transition-all duration-300"
                                >
                                    ë‹¤ì‹œí•˜ê¸°
                                </button>
                            </div>

                            <div class="flex justify-center gap-8 text-center">
                                <div>
                                    <p class="text-sm text-gray-600">ì‹œë„ íšŸìˆ˜</p>
                                    <p class="text-2xl font-bold text-purple-600">${moves}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600">ì§„í–‰ë„</p>
                                    <p class="text-2xl font-bold text-pink-600">${matchedPairs} / ${totalPairs}</p>
                                </div>
                            </div>
                        </div>

                        <!-- ì¹´ë“œ ê·¸ë¦¬ë“œ -->
                        <div class="grid grid-cols-4 gap-4">
                            ${cardGrid}
                        </div>
                    </div>
                </div>

                ${winModal}
            `;
        };

        const renderCollection = () => {
            const allItems = STAGES_DATA.stages.flatMap(stage =>
                stage.items.map(item => ({
                    ...item,
                    stageName: stage.name,
                    stageId: stage.id,
                    isUnlocked: completedStages.includes(stage.id)
                }))
            );

            const itemsHtml = allItems.map(item => `
                <div
                    class="${item.isUnlocked ? 'cursor-pointer' : 'locked'} bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition-all duration-300 transform hover:scale-105"
                    ${item.isUnlocked ? `onclick="window.showCollectionDetail(${item.stageId}, ${item.idx})"` : ''}
                >
                    <div class="aspect-square overflow-hidden">
                        <img src="../assets/img/${item.img}" alt="${item.title}" class="w-full h-full object-cover">
                    </div>
                    <div class="p-4 text-center">
                        <h3 class="font-bold text-lg text-gray-800 mb-1">${item.title}</h3>
                        <p class="text-sm text-gray-600 mb-2">${item.stageName}</p>
                        <p class="text-xs font-bold ${item.isUnlocked ? 'text-indigo-500' : 'text-gray-500'}">
                            ${item.isUnlocked ? 'ìƒì„¸ë³´ê¸°' : 'ìŠ¤í…Œì´ì§€ í´ë¦¬ì–´ í•„ìš”'}
                        </p>
                    </div>
                </div>
            `).join('');

            let detailModal = '';
            if (selectedCollectionItem) {
                detailModal = `
                    <div class="collection-modal-backdrop" onclick="window.hideCollectionDetail()">
                        <div id="collectionModalCard" class="collection-modal-card" onclick="event.stopPropagation()">
                            <!-- ì•ë©´ -->
                            <div class="collection-card-face collection-card-front" onclick="document.getElementById('collectionModalCard').classList.toggle('is-flipped')">
                                <img src="../assets/img/${selectedCollectionItem.img}" alt="${selectedCollectionItem.title}" class="w-full h-full object-cover">
                            </div>
                            <!-- ë’·ë©´ -->
                            <div class="collection-card-face collection-card-back" onclick="document.getElementById('collectionModalCard').classList.toggle('is-flipped')">
                                <button onclick="window.hideCollectionDetail()" class="absolute top-4 right-4 text-3xl font-bold text-white/80 hover:text-white transition-colors">&times;</button>
                                <h3 class="text-3xl font-bold mb-3">${selectedCollectionItem.title}</h3>
                                <p class="text-lg text-purple-300 mb-4">${selectedCollectionItem.stageName}</p>
                                <p class="text-base text-gray-300">${selectedCollectionItem.desc}</p>
                            </div>
                        </div>
                    </div>
                `;
            }

            appContainer.innerHTML = `
                ${renderHeader()}
                <div class="min-h-screen p-8">
                    <div class="max-w-7xl mx-auto">
                        <div class="text-center mb-8">
                            <h1 class="text-4xl font-bold text-gray-800 mb-4">ë‚´ ì»¬ë ‰ì…˜</h1>
                            <p class="text-lg text-gray-600">ìŠ¤í…Œì´ì§€ë¥¼ í´ë¦¬ì–´í•˜ì—¬ ì ê¸ˆ í•´ì œëœ ì¹´ë“œë¥¼ ëˆŒëŸ¬ ìƒì„¸ ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>
                        </div>

                        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-6 mb-8">
                            ${itemsHtml}
                        </div>

                        <div class="text-center">
                            <button
                                onclick="window.goToPage('stages')"
                                class="py-3 px-8 rounded-lg font-bold text-white bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 transition-all duration-300"
                            >
                                ìŠ¤í…Œì´ì§€ ì„ íƒ
                            </button>
                        </div>
                    </div>
                </div>
                ${detailModal}
            `;

            if (selectedCollectionItem) {
                // ì• ë‹ˆë©”ì´ì…˜ íŠ¸ë¦¬ê±°
                setTimeout(() => {
                    const card = document.getElementById('collectionModalCard');
                    if (card) {
                        card.classList.add('is-visible');
                        setTimeout(() => card.classList.add('is-flipped'), 100); // í™•ëŒ€ í›„ ë’¤ì§‘ê¸°
                    }
                }, 50);
            }
        };

        const renderRanking = () => {
            const rankingHtml = rankingData.map((rank, index) => `
                <div class="flex justify-between items-center p-4 ${index < 3 ? 'bg-yellow-50' : 'bg-gray-50'} rounded-lg">
                    <div class="flex items-center gap-4">
                        <span class="text-2xl font-bold ${index === 0 ? 'text-yellow-500' : index === 1 ? 'text-gray-400' : index === 2 ? 'text-orange-600' : 'text-gray-700'}">${index + 1}</span>
                        <div>
                            <p class="font-bold text-gray-800">${rank.name}</p>
                            <p class="text-sm text-gray-600">${rank.stage}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-lg font-bold text-purple-600">${rank.moves}íšŒ</p>
                    </div>
                </div>
            `).join('');

            appContainer.innerHTML = `
                ${renderHeader()}
                <div class="min-h-screen p-8">
                    <div class="max-w-3xl mx-auto">
                        <div class="text-center mb-8">
                            <h1 class="text-4xl font-bold text-gray-800 mb-4">ë­í‚¹</h1>
                            <p class="text-lg text-gray-600">ì‹œë„ íšŸìˆ˜ê°€ ì ì„ìˆ˜ë¡ ë†’ì€ ìˆœìœ„!</p>
                        </div>

                        <div class="bg-white rounded-2xl shadow-xl p-8 mb-8">
                            <div class="space-y-3">
                                ${rankingHtml.length > 0 ? rankingHtml : '<p class="text-center text-gray-500">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</p>'}
                            </div>
                        </div>

                        <div class="text-center">
                            <button
                                onclick="window.goToPage('stages')"
                                class="py-3 px-8 rounded-lg font-bold text-white bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 transition-all duration-300"
                            >
                                ìŠ¤í…Œì´ì§€ ì„ íƒ
                            </button>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderShop = () => {
            const shopItemsHtml = AVATAR_SHOP.map(avatar => {
                const isOwned = purchasedAvatars.has(avatar.id);
                const canAfford = coins >= avatar.price;

                let buttonHtml = '';
                if (isOwned) {
                    buttonHtml = `
                        <button class="w-full py-2 px-4 text-sm rounded-lg font-bold text-green-700 bg-green-100 cursor-default">
                            ë³´ìœ  ì¤‘
                        </button>
                    `;
                } else if (canAfford) {
                    buttonHtml = `
                        <button
                            onclick="window.purchaseAvatar('${avatar.id}')"
                            class="w-full py-2 px-4 text-sm rounded-lg font-bold text-white bg-indigo-500 hover:bg-indigo-600 transition-colors"
                        >
                            êµ¬ë§¤í•˜ê¸°
                        </button>
                    `;
                } else {
                    buttonHtml = `
                        <button class="w-full py-2 px-4 text-sm rounded-lg font-bold text-gray-500 bg-gray-200 cursor-not-allowed" disabled>
                            ì½”ì¸ ë¶€ì¡±
                        </button>
                    `;
                }

                return `
                    <div class="bg-white rounded-2xl shadow-lg p-4 text-center flex flex-col justify-between">
                        <div>
                            <div class="text-6xl mb-2">${avatar.id}</div>
                            <p class="font-bold text-gray-800">${avatar.name}</p>
                            <div class="flex items-center justify-center gap-1 my-2">
                                <span class="text-lg">ğŸª™</span>
                                <span class="font-bold text-yellow-900">${avatar.price}</span>
                            </div>
                        </div>
                        <div class="mt-4">
                            ${buttonHtml}
                        </div>
                    </div>
                `;
            }).join('');

            appContainer.innerHTML = `
                ${renderHeader()}
                <div class="min-h-screen p-8">
                    <div class="max-w-7xl mx-auto">
                        <div class="text-center mb-8">
                            <h1 class="text-4xl font-bold text-gray-800 mb-4">ğŸ›’ í”„ë¡œí•„ ìƒì </h1>
                            <p class="text-lg text-gray-600">ì½”ì¸ì„ ëª¨ì•„ ìƒˆë¡œìš´ í”„ë¡œí•„ ì•„ë°”íƒ€ë¥¼ êµ¬ë§¤í•˜ì„¸ìš”!</p>
                        </div>

                        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-6 mb-8">
                            ${shopItemsHtml}
                        </div>

                        <div class="text-center">
                            <button
                                onclick="window.goToPage('stages')"
                                class="py-3 px-8 rounded-lg font-bold text-white bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 transition-all duration-300"
                            >
                                ìŠ¤í…Œì´ì§€ ì„ íƒ
                            </button>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderQuizPage = () => {
            const conversationHtml = quizState.conversation.map(msg => {
                let optionsHtml = '';
                if (msg.options && msg.options.length > 0) {
                    optionsHtml = `
                        <div class="flex flex-wrap gap-2 mt-2">
                            ${msg.options.map(option => `
                                <button
                                    onclick="document.getElementById('answerInput').value = '${option}';"
                                    class="px-4 py-2 bg-indigo-200 text-indigo-800 rounded-full text-sm font-medium hover:bg-indigo-300 transition-colors"
                                >
                                    ${option}
                                </button>
                            `).join('')}
                        </div>
                    `;
                }

                if (msg.role === 'ai') {
                    return `
                        <div class="flex justify-start mb-4">
                            <div class="bg-indigo-100 text-indigo-800 p-3 rounded-lg max-w-xs">
                                ${msg.content}
                                ${optionsHtml}
                            </div>
                        </div>
                    `;
                } else {
                    return `
                        <div class="flex justify-end mb-4">
                            <div class="bg-green-100 text-green-800 p-3 rounded-lg max-w-xs">
                                ${msg.content}
                            </div>
                        </div>
                    `;
                }
            }).join('');

            appContainer.innerHTML = `
                ${renderHeader()}
                <div class="min-h-screen p-8">
                    <div class="max-w-3xl mx-auto">
                        <div class="text-center mb-8">
                            <h1 class="text-4xl font-bold text-gray-800 mb-4">ğŸ¤– AI ì½”ì¸ ì±„êµ´ í€´ì¦ˆ</h1>
                            <p class="text-lg text-gray-600">AIê°€ ë‚´ëŠ” ë¬¸ì œë¥¼ ë§íˆê³  ì½”ì¸ì„ íšë“í•˜ì„¸ìš”!</p>
                        </div>

                        <div class="bg-white rounded-2xl shadow-xl p-8 mb-8">
                            <div id="chat-container" class="h-96 overflow-y-auto mb-4 p-4 bg-gray-50 rounded-lg">
                                ${conversationHtml}
                                ${quizState.loading ? '<p class="text-gray-500">AIê°€ ìƒê° ì¤‘...</p>' : ''}
                            </div>
                            <div class="flex gap-2">
                                <input
                                    type="text"
                                    id="answerInput"
                                    class="flex-1 p-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition"
                                    placeholder="ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”..."
                                    ${quizState.loading ? 'disabled' : ''}
                                />
                                <button
                                    id="sendAnswerBtn"
                                    class="py-3 px-6 rounded-lg font-bold text-white bg-indigo-500 hover:bg-indigo-600 transition-colors disabled:bg-gray-400"
                                    ${quizState.loading ? 'disabled' : ''}
                                >
                                    ì „ì†¡
                                </button>
                            </div>
                        </div>

                        <div class="text-center">
                            <button
                                onclick="window.goToPage('stages')"
                                class="py-3 px-8 rounded-lg font-bold text-white bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 transition-all duration-300"
                            >
                                ìŠ¤í…Œì´ì§€ ì„ íƒ
                            </button>
                        </div>
                    </div>
                </div>
            `;

            const chatContainer = document.getElementById('chat-container');
            if (chatContainer) {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }

            const sendBtn = document.getElementById('sendAnswerBtn');
            const answerInput = document.getElementById('answerInput');
            if (sendBtn && answerInput) {
                sendBtn.addEventListener('click', sendAnswer);
                answerInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') sendAnswer();
                });
            }
        };

        // ===================================
        // ë§ˆìŠ¤í„° ë Œë” í•¨ìˆ˜
        // ===================================
        const render = () => {
            const scrollY = window.scrollY;
            switch (currentPage) {
                case 'welcome':
                    renderWelcome();
                    break;
                case 'stages':
                    renderStages();
                    break;
                case 'game':
                    renderGame();
                    break;
                case 'shop':
                    renderShop();
                    break;
                case 'collection':
                    renderCollection();
                    break;
                case 'ranking':
                    renderRanking();
                    break;
                case 'quiz':
                    renderQuizPage();
                    break;
                default:
                    appContainer.innerHTML = '<h1 class="text-center text-red-500 mt-10">í˜ì´ì§€ ì˜¤ë¥˜</h1>';
            }
            window.scrollTo(0, scrollY);
        };

        // ===================================
        // ì´ˆê¸°í™”
        // ===================================
        async function init() {
            await loadData();
            // í•­ìƒ Welcome í˜ì´ì§€ë¶€í„° ì‹œì‘
            currentPage = 'welcome';
            render();
        }

        // ì „ì—­ í•¨ìˆ˜ë¡œ ë‚´ë³´ë‚´ê¸°
        window.initializeGame = initializeGame;
        window.handleCardClick = handleCardClick;
        window.goToPage = goToPage;
        window.signOutUser = signOutUser;
        window.selectAvatar = (avatar) => {
            playerAvatar = avatar;
            render();
        };

        window.purchaseAvatar = (avatarId) => {
            const avatar = AVATAR_SHOP.find(a => a.id === avatarId);
            if (!avatar) return;

            if (coins >= avatar.price && !purchasedAvatars.has(avatar.id)) {
                coins -= avatar.price;
                purchasedAvatars.add(avatar.id);
                saveProgress();
                render(); // Re-render the shop to update the UI
            } else {
                alert('ì½”ì¸ì´ ë¶€ì¡±í•˜ê±°ë‚˜ ì´ë¯¸ ë³´ìœ í•œ ì•„ë°”íƒ€ì…ë‹ˆë‹¤.');
            }
        };

        window.showCollectionDetail = (stageId, itemId) => {
            const stage = STAGES_DATA.stages.find(s => s.id === stageId);
            if (!stage || !completedStages.includes(stageId)) return;

            const item = stage.items.find(i => i.idx === itemId);
            if (item) {
                selectedCollectionItem = { ...item, stageName: stage.name };
                render();
            }
        };

        window.hideCollectionDetail = () => {
            const card = document.getElementById('collectionModalCard');
            if (card) {
                card.classList.remove('is-visible');
                card.classList.remove('is-flipped');
                setTimeout(() => {
                    selectedCollectionItem = null;
                    render();
                }, 400); // transition ì‹œê°„ê³¼ ë§ì¶¤
            } else {
                selectedCollectionItem = null;
                render();
            }
        };

        // Welcome ëª¨ë“œ ì „í™˜
        window.switchMode = (mode) => {
            welcomeMode = mode;
            render();
        };

        // ê²ŒìŠ¤íŠ¸ë¡œ ì‹œì‘
        window.startGameAsGuest = () => {
            const input = document.getElementById('playerNameInput');
            const name = input?.value.trim() || 'ìµëª…';
            setPlayerName(name);
        };

        // íšŒì›ê°€ì…
        window.submitSignup = () => {
            const email = document.getElementById('emailInput')?.value.trim();
            const password = document.getElementById('passwordInput')?.value;
            const name = document.getElementById('nameInput')?.value.trim();

            if (!email || !password || !name) {
                alert('ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (password.length < 6) {
                alert('ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }

            signup(email, password, name, playerAvatar);
        };

        // ë¡œê·¸ì¸
        window.submitLogin = () => {
            const email = document.getElementById('emailInput')?.value.trim();
            const password = document.getElementById('passwordInput')?.value;

            if (!email || !password) {
                alert('ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            login(email, password);
        };

        // ì‹œì‘
        init();
    </script>
</body>
</html>
