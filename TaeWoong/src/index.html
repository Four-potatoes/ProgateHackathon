<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K-Everything Memory Game</title>
    <link rel="icon" href="../favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Backend API Configuration -->
    <script>
        // ë°±ì—”ë“œ API URL
        const API_BASE_URL = 'http://localhost:5000/api';

        // ì¸ì¦ í† í° ì €ì¥/ë¡œë“œ
        let authToken = localStorage.getItem('auth_token');

        // API í˜¸ì¶œ í—¬í¼ í•¨ìˆ˜
        const apiCall = async (endpoint, options = {}) => {
            const headers = {
                'Content-Type': 'application/json',
                ...options.headers
            };

            if (authToken) {
                headers['Authorization'] = `Bearer ${authToken}`;
            }

            const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                ...options,
                headers
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || 'API ìš”ì²­ ì‹¤íŒ¨');
            }

            return response.json();
        };

        window.API_BASE_URL = API_BASE_URL;
        window.apiCall = apiCall;
    </script>

    <style>
        /* ì¹´ë“œ í”Œë¦½ ì• ë‹ˆë©”ì´ì…˜ */
        .perspective { perspective: 1000px; }
        .transform-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .flip { transform: rotateY(180deg); }
        .card-transition { transition: transform 0.6s; }

        /* íŒì—… ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes pop {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .pop-in { animation: pop 0.3s ease-out forwards; }

        /* ì ê¸ˆ íš¨ê³¼ */
        .locked { filter: grayscale(100%) brightness(0.6); pointer-events: none; }

        /* ì¤‘ì•™ ì •ë ¬ */
        .text-center { text-align: center; }

        /* í”„ë¡œí•„ ì•„ë°”íƒ€ ì„ íƒ ì• ë‹ˆë©”ì´ì…˜ */
        .profile-selected {
            transform: scale(1.1);
            box-shadow: 0 0 0 3px #6366f1;
        }

        /* í”„ë¡œí•„ ë“œë¡­ë‹¤ìš´ */
        .profile-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 0.5rem;
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            min-width: 200px;
            z-index: 50;
        }
        .profile-dropdown.show {
            display: block;
        }
        .profile-image {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s;
        }
        .profile-image:hover {
            transform: scale(1.1);
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50">

    <div id="app" class="min-h-screen">
        <!-- ë¡œë”© í™”ë©´ -->
        <div class="flex flex-col justify-center items-center h-screen">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-purple-500"></div>
            <p class="mt-4 text-xl text-gray-700">ë¡œë”© ì¤‘...</p>
        </div>
    </div>

    <script type="module">
        // ===================================
        // ì „ì—­ ìƒíƒœ
        // ===================================
        let STAGES_DATA = null;
        let currentStage = 1;
        let unlockedStages = [1];
        let completedStages = []; // ì™„ë£Œëœ ìŠ¤í…Œì´ì§€
        let playerName = '';
        let playerNameSet = false;
        let playerAvatar = 'ğŸ˜Š'; // í”Œë ˆì´ì–´ ì•„ë°”íƒ€

        // Google ì‚¬ìš©ì ì •ë³´
        let currentUser = null;
        let userProfile = {
            uid: null,
            email: null,
            displayName: null,
            photoURL: null
        };

        // ê²Œì„ ìƒíƒœ
        let cards = [];
        let flipped = [];
        let matched = [];
        let moves = 0;
        let isWon = false;
        let canClick = true;
        let currentPage = 'welcome'; // welcome, stages, game, collection, ranking

        // ë­í‚¹ ë°ì´í„° (ë©”ëª¨ë¦¬)
        let rankingData = [
            { name: 'ê¹€ë¯¼ìˆ˜', stage: 'ì˜í™”', moves: 18 },
            { name: 'ì´ì„œì—°', stage: 'ìŒì‹', moves: 22 },
            { name: 'ë°•ì§€í›ˆ', stage: 'ì˜í™”', moves: 25 },
        ];

        const appContainer = document.getElementById('app');

        // ===================================
        // ë°ì´í„° ë¡œë“œ
        // ===================================
        async function loadData() {
            try {
                // URLì—ì„œ í† í° í™•ì¸ (Google OAuth ì½œë°±)
                const urlParams = new URLSearchParams(window.location.search);
                const tokenFromUrl = urlParams.get('token');

                if (tokenFromUrl) {
                    authToken = tokenFromUrl;
                    localStorage.setItem('auth_token', authToken);
                    // URLì—ì„œ í† í° ì œê±°
                    window.history.replaceState({}, document.title, '/game');

                    // ë°±ì—”ë“œì—ì„œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                    try {
                        const userData = await apiCall('/auth/me');
                        currentUser = userData.user;
                        userProfile = {
                            uid: currentUser.id,
                            email: currentUser.email,
                            displayName: currentUser.name,
                            photoURL: currentUser.profilePicture
                        };
                        playerName = currentUser.name;
                        playerNameSet = true;

                        // ê²Œì„ ì§„í–‰ë„ ë¡œë“œ
                        if (userData.progress) {
                            unlockedStages = JSON.parse(userData.progress.unlocked_stages) || [1];
                            completedStages = JSON.parse(userData.progress.completed_stages) || [];
                            currentStage = userData.progress.current_stage || 1;
                            playerAvatar = userData.progress.player_avatar || 'ğŸ˜Š';
                        }

                        console.log('Google ë¡œê·¸ì¸ ì„±ê³µ:', playerName);
                        currentPage = 'stages'; // ë¡œê·¸ì¸ í›„ ìŠ¤í…Œì´ì§€ ì„ íƒ í™”ë©´ìœ¼ë¡œ
                    } catch (error) {
                        console.error('ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
                    }
                }

                const response = await fetch('../data/stages.json');
                STAGES_DATA = await response.json();

                // í† í°ì´ ìˆìœ¼ë©´ ë°±ì—”ë“œì—ì„œ ë°ì´í„° ë¡œë“œ
                if (authToken && !tokenFromUrl) {
                    try {
                        const userData = await apiCall('/auth/me');
                        currentUser = userData.user;
                        if (userData.progress) {
                            unlockedStages = JSON.parse(userData.progress.unlocked_stages) || [1];
                            completedStages = JSON.parse(userData.progress.completed_stages) || [];
                            currentStage = userData.progress.current_stage || 1;
                            playerAvatar = userData.progress.player_avatar || 'ğŸ˜Š';
                            playerName = currentUser.name;
                            playerNameSet = true;
                            currentPage = 'stages';
                        }
                    } catch (error) {
                        console.error('ë°±ì—”ë“œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                        // ì‹¤íŒ¨ì‹œ ë¡œì»¬ ì €ì¥ì†Œì—ì„œ ë¡œë“œ
                        loadFromLocalStorage();
                    }
                } else {
                    // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì—ì„œ ì§„í–‰ë„ ë¶ˆëŸ¬ì˜¤ê¸°
                    loadFromLocalStorage();
                }

                const savedRanking = localStorage.getItem('ranking_data');
                if (savedRanking) {
                    rankingData = JSON.parse(savedRanking);
                }
            } catch (error) {
                console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem('game_progress');
            if (saved) {
                const progress = JSON.parse(saved);
                unlockedStages = progress.unlockedStages || [1];
                completedStages = progress.completedStages || [];
                currentStage = progress.currentStage || 1;
                playerName = progress.playerName || '';
                playerNameSet = progress.playerNameSet || false;
            }
        }

        // ===================================
        // ì €ì¥ í•¨ìˆ˜
        // ===================================
        const saveProgress = () => {
            // ë¡œì»¬ ì €ì¥ì†Œì— ì €ì¥ (1íšŒìš© ë¡œê·¸ì¸)
            localStorage.setItem('game_progress', JSON.stringify({
                unlockedStages,
                completedStages,
                currentStage,
                playerName,
                playerNameSet
            }));

            // Google ë¡œê·¸ì¸ ìƒíƒœë©´ ë°±ì—”ë“œ DBì—ë„ ì €ì¥
            if (authToken && currentUser) {
                saveUserData();
            }
        };

        const saveRanking = () => {
            localStorage.setItem('ranking_data', JSON.stringify(rankingData));
        };

        // ===================================
        // íšŒì›ê°€ì…/ë¡œê·¸ì¸ í•¨ìˆ˜
        // ===================================
        const signup = async (email, password, name, avatar) => {
            try {
                const response = await apiCall('/auth/signup', {
                    method: 'POST',
                    body: JSON.stringify({ email, password, name, avatar })
                });

                authToken = response.token;
                localStorage.setItem('auth_token', authToken);

                currentUser = response.user;
                userProfile = {
                    uid: currentUser.id,
                    email: currentUser.email,
                    displayName: currentUser.name,
                    photoURL: null
                };

                playerName = currentUser.name;
                playerAvatar = currentUser.avatar;
                playerNameSet = true;

                await loadUserData();

                console.log('íšŒì›ê°€ì… ì„±ê³µ:', playerName);
                currentPage = 'stages';
                render();
            } catch (error) {
                alert(error.message || 'íšŒì›ê°€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                console.error('íšŒì›ê°€ì… ì‹¤íŒ¨:', error);
            }
        };

        const login = async (email, password) => {
            try {
                const response = await apiCall('/auth/login', {
                    method: 'POST',
                    body: JSON.stringify({ email, password })
                });

                authToken = response.token;
                localStorage.setItem('auth_token', authToken);

                currentUser = response.user;
                userProfile = {
                    uid: currentUser.id,
                    email: currentUser.email,
                    displayName: currentUser.name,
                    photoURL: null
                };

                playerName = currentUser.name;
                playerAvatar = currentUser.avatar;
                playerNameSet = true;

                await loadUserData();

                console.log('ë¡œê·¸ì¸ ì„±ê³µ:', playerName);
                currentPage = 'stages';
                render();
            } catch (error) {
                alert(error.message || 'ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                console.error('ë¡œê·¸ì¸ ì‹¤íŒ¨:', error);
            }
        };

        const signOutUser = async () => {
            try {
                await apiCall('/auth/logout', { method: 'POST' });
                authToken = null;
                localStorage.removeItem('auth_token');
                currentUser = null;
                userProfile = {
                    uid: null,
                    email: null,
                    displayName: null,
                    photoURL: null
                };
                render();
            } catch (error) {
                console.error('ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨:', error);
            }
        };

        const loadUserData = async () => {
            if (!authToken) return;

            try {
                const data = await apiCall('/game/progress');
                unlockedStages = data.unlockedStages || [1];
                completedStages = data.completedStages || [];
                currentStage = data.currentStage || 1;
                playerName = data.playerName || userProfile.displayName;
                playerNameSet = !!playerName;
            } catch (error) {
                console.error('ì‚¬ìš©ì ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        };

        const saveUserData = async () => {
            if (!authToken) return;

            try {
                await apiCall('/game/progress', {
                    method: 'POST',
                    body: JSON.stringify({
                        currentStage,
                        unlockedStages,
                        completedStages,
                        playerAvatar
                    })
                });
            } catch (error) {
                console.error('ì‚¬ìš©ì ë°ì´í„° ì €ì¥ ì‹¤íŒ¨:', error);
            }
        };

        // ===================================
        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
        // ===================================
        const shuffleArray = (array) => {
            const arr = [...array];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        };

        const goToPage = (page) => {
            currentPage = page;
            render();
        };

        const setPlayerName = async (name) => {
            playerName = name.trim() || 'ìµëª…';
            playerNameSet = true;

            // ê°„ë‹¨ ë¡œê·¸ì¸ì€ ë¡œì»¬ ì €ì¥ì†Œë§Œ ì‚¬ìš© (1íšŒìš©)
            console.log('1íšŒìš© ë¡œê·¸ì¸:', playerName, '(Google ë¡œê·¸ì¸í•˜ë©´ ì˜êµ¬ ì €ì¥ë©ë‹ˆë‹¤)');

            saveProgress();
            goToPage('stages');
        };

        // ===================================
        // ê²Œì„ ë¡œì§
        // ===================================
        const initializeGame = (stageId) => {
            currentStage = stageId;
            const stage = STAGES_DATA.stages.find(s => s.id === stageId);
            if (!stage) return;

            const items = stage.items;
            const pairs = [...items, ...items].map((item, index) => ({
                ...item,
                id: index,
                pairId: item.idx
            }));

            cards = shuffleArray(pairs);
            flipped = [];
            matched = [];
            moves = 0;
            isWon = false;
            canClick = true;

            currentPage = 'game';
            renderGame();
        };

        const handleCardClick = (cardId) => {
            if (!canClick || flipped.length === 2 || flipped.includes(cardId) || matched.includes(cardId) || isWon) {
                return;
            }

            flipped.push(cardId);
            renderGame();

            if (flipped.length === 2) {
                canClick = false;
                moves++;
                renderGame();

                const [firstId, secondId] = flipped;
                const card1 = cards.find(c => c.id === firstId);
                const card2 = cards.find(c => c.id === secondId);

                if (card1 && card2 && card1.pairId === card2.pairId) {
                    matched.push(firstId, secondId);
                    flipped = [];
                    canClick = true;

                    if (matched.length === cards.length) {
                        isWon = true;

                        // í˜„ì¬ ìŠ¤í…Œì´ì§€ ì™„ë£Œ ì²˜ë¦¬
                        if (!completedStages.includes(currentStage)) {
                            completedStages.push(currentStage);
                        }

                        // ë‹¤ìŒ ìŠ¤í…Œì´ì§€ ì ê¸ˆ í•´ì œ
                        if (currentStage < 3 && !unlockedStages.includes(currentStage + 1)) {
                            unlockedStages.push(currentStage + 1);
                        }

                        // ë­í‚¹ì— ì¶”ê°€
                        const stage = STAGES_DATA.stages.find(s => s.id === currentStage);
                        rankingData.push({
                            name: playerName,
                            stage: stage.name,
                            moves: moves
                        });
                        rankingData.sort((a, b) => a.moves - b.moves);
                        if (rankingData.length > 20) rankingData = rankingData.slice(0, 20);

                        saveProgress();
                        saveRanking();
                    }
                    renderGame();
                } else {
                    setTimeout(() => {
                        flipped = [];
                        canClick = true;
                        renderGame();
                    }, 1000);
                }
            }
        };

        // ===================================
        // ë Œë”ë§ í•¨ìˆ˜
        // ===================================
        const renderHeader = () => {
            if (!currentUser) {
                return `
                    <div class="fixed top-4 right-4 z-50">
                        <button
                            onclick="window.signInWithGoogle()"
                            class="flex items-center gap-2 px-4 py-2 bg-white rounded-full shadow-lg hover:shadow-xl transition-all duration-300"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="24px" height="24px">
                                <path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/>
                                <path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/>
                                <path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"/>
                                <path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"/>
                            </svg>
                            <span class="font-bold text-gray-700">Google ë¡œê·¸ì¸</span>
                        </button>
                    </div>
                `;
            }

            return `
                <div class="fixed top-4 right-4 z-50">
                    <div class="relative">
                        <img
                            src="${userProfile.photoURL || 'https://via.placeholder.com/40'}"
                            alt="Profile"
                            class="profile-image"
                            onclick="window.toggleProfileDropdown()"
                        />
                        <div id="profileDropdown" class="profile-dropdown">
                            <div class="p-4 border-b border-gray-100">
                                <p class="font-bold text-gray-800">${userProfile.displayName || 'Unknown User'}</p>
                                <p class="text-sm text-gray-500">${userProfile.email || ''}</p>
                            </div>
                            <div class="p-2">
                                <button
                                    onclick="window.signOutUser()"
                                    class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 rounded-md transition-colors"
                                >
                                    ë¡œê·¸ì•„ì›ƒ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        window.toggleProfileDropdown = () => {
            const dropdown = document.getElementById('profileDropdown');
            if (dropdown) {
                dropdown.classList.toggle('show');
            }
        };

        // ë“œë¡­ë‹¤ìš´ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
        document.addEventListener('click', (e) => {
            const dropdown = document.getElementById('profileDropdown');
            const profileImage = document.querySelector('.profile-image');
            if (dropdown && profileImage && !profileImage.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.classList.remove('show');
            }
        });

        let welcomeMode = 'initial'; // 'initial', 'guest', 'login', 'signup'

        const renderWelcome = () => {
            const PROFILE_AVATARS = ['ğŸ˜Š', 'ğŸ˜', 'ğŸ¥³', 'ğŸ¤“', 'ğŸ˜‡', 'ğŸ¤—', 'ğŸ¥°', 'ğŸ˜', 'ğŸ™‚', 'ğŸ˜„', 'ğŸ˜ƒ', 'ğŸ˜€', 'ğŸ¤©', 'ğŸ˜', 'ğŸ¥¸', 'ğŸ˜'];

            const profileGrid = PROFILE_AVATARS.map((avatar) => `
                <button onclick="window.selectAvatar('${avatar}')" class="w-12 h-12 text-2xl rounded-full border-2 border-gray-300 hover:border-indigo-400 transition-all duration-200 ${playerAvatar === avatar ? 'profile-selected border-indigo-500' : ''}">
                    ${avatar}
                </button>
            `).join('');

            let formContent = '';

            if (welcomeMode === 'initial') {
                formContent = `
                    <div class="space-y-4">
                        <button
                            onclick="window.switchMode('guest')"
                            class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-4 px-6 rounded-lg shadow-lg transition transform hover:scale-105"
                        >
                            ê²ŒìŠ¤íŠ¸ë¡œ ì‹œì‘í•˜ê¸°
                        </button>

                        <div class="flex gap-2">
                            <button
                                onclick="window.switchMode('login')"
                                class="flex-1 bg-white border-2 border-indigo-500 hover:bg-indigo-50 text-indigo-600 font-bold py-3 px-4 rounded-lg transition"
                            >
                                ë¡œê·¸ì¸
                            </button>
                            <button
                                onclick="window.switchMode('signup')"
                                class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition"
                            >
                                íšŒì›ê°€ì…
                            </button>
                        </div>
                    </div>
                `;
            } else if (welcomeMode === 'guest') {
                formContent = `
                    <div class="mb-6">
                        <label class="block text-left text-sm font-semibold text-gray-700 mb-2">
                            í”„ë¡œí•„ ì•„ë°”íƒ€ ì„ íƒ
                        </label>
                        <div class="grid grid-cols-8 gap-2 mb-4 p-3 bg-gray-50 rounded-lg">
                            ${profileGrid}
                        </div>

                        <label class="block text-left text-sm font-semibold text-gray-700 mb-2">
                            ë‹‰ë„¤ì„ ì…ë ¥
                        </label>
                        <input
                            type="text"
                            id="playerNameInput"
                            class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition"
                            placeholder="ì˜ˆ: í™ê¸¸ë™"
                            maxlength="10"
                        />
                    </div>

                    <button
                        onclick="window.startGameAsGuest()"
                        class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-4 px-6 rounded-lg shadow-lg transition transform hover:scale-105 mb-3"
                    >
                        ê²Œì„ ì‹œì‘ (ë°ì´í„° ì €ì¥ ì•ˆë¨)
                    </button>

                    <button
                        onclick="window.switchMode('initial')"
                        class="w-full bg-white border-2 border-gray-300 hover:border-indigo-500 text-gray-700 font-bold py-3 px-4 rounded-lg transition"
                    >
                        ë’¤ë¡œ ê°€ê¸°
                    </button>
                `;
            } else if (welcomeMode === 'login') {
                formContent = `
                    <div class="mb-6 space-y-4">
                        <div>
                            <label class="block text-left text-sm font-semibold text-gray-700 mb-2">
                                ì´ë©”ì¼
                            </label>
                            <input
                                type="email"
                                id="emailInput"
                                class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition"
                                placeholder="example@email.com"
                            />
                        </div>

                        <div>
                            <label class="block text-left text-sm font-semibold text-gray-700 mb-2">
                                ë¹„ë°€ë²ˆí˜¸
                            </label>
                            <input
                                type="password"
                                id="passwordInput"
                                class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition"
                                placeholder="ë¹„ë°€ë²ˆí˜¸"
                            />
                        </div>
                    </div>

                    <button
                        onclick="window.submitLogin()"
                        class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-4 px-6 rounded-lg shadow-lg transition transform hover:scale-105 mb-3"
                    >
                        ë¡œê·¸ì¸
                    </button>

                    <button
                        onclick="window.switchMode('initial')"
                        class="w-full bg-white border-2 border-gray-300 hover:border-indigo-500 text-gray-700 font-bold py-3 px-4 rounded-lg transition"
                    >
                        ë’¤ë¡œ ê°€ê¸°
                    </button>
                `;
            } else if (welcomeMode === 'signup') {
                formContent = `
                    <div class="mb-6 space-y-4">
                        <div>
                            <label class="block text-left text-sm font-semibold text-gray-700 mb-2">
                                í”„ë¡œí•„ ì•„ë°”íƒ€ ì„ íƒ
                            </label>
                            <div class="grid grid-cols-8 gap-2 p-3 bg-gray-50 rounded-lg">
                                ${profileGrid}
                            </div>
                        </div>

                        <div>
                            <label class="block text-left text-sm font-semibold text-gray-700 mb-2">
                                ì´ë©”ì¼
                            </label>
                            <input
                                type="email"
                                id="emailInput"
                                class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition"
                                placeholder="example@email.com"
                            />
                        </div>

                        <div>
                            <label class="block text-left text-sm font-semibold text-gray-700 mb-2">
                                ë¹„ë°€ë²ˆí˜¸
                            </label>
                            <input
                                type="password"
                                id="passwordInput"
                                class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition"
                                placeholder="ë¹„ë°€ë²ˆí˜¸ (ìµœì†Œ 6ì)"
                            />
                        </div>

                        <div>
                            <label class="block text-left text-sm font-semibold text-gray-700 mb-2">
                                ë‹‰ë„¤ì„
                            </label>
                            <input
                                type="text"
                                id="nameInput"
                                class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition"
                                placeholder="ë‹‰ë„¤ì„"
                                maxlength="10"
                            />
                        </div>
                    </div>

                    <button
                        onclick="window.submitSignup()"
                        class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-4 px-6 rounded-lg shadow-lg transition transform hover:scale-105 mb-3"
                    >
                        íšŒì›ê°€ì…
                    </button>

                    <button
                        onclick="window.switchMode('initial')"
                        class="w-full bg-white border-2 border-gray-300 hover:border-indigo-500 text-gray-700 font-bold py-3 px-4 rounded-lg transition"
                    >
                        ë’¤ë¡œ ê°€ê¸°
                    </button>
                `;
            }

            appContainer.innerHTML = `
                <div class="min-h-screen flex flex-col items-center justify-center bg-gradient-to-br from-pink-100 via-purple-100 to-indigo-100 p-4">
                    <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md">
                        <div class="mb-6 text-center">
                            <div class="text-6xl mb-4">ğŸ®</div>
                            <h1 class="text-4xl font-extrabold text-indigo-600 mb-2">
                                K-Everything<br>Memory Game
                            </h1>
                            <p class="text-gray-600">í•œêµ­ ë¬¸í™”ì¬, ìŒì‹, ì˜í™”ë¥¼ ë°°ìš°ëŠ” ì¹´ë“œ ê²Œì„</p>
                        </div>

                        ${formContent}

                        <div class="mt-6 pt-6 border-t border-gray-200 text-center">
                            <p class="text-sm text-gray-600 mb-3">ğŸ“š ê²Œì„ ë°©ë²•</p>
                            <div class="text-xs text-gray-500 space-y-1">
                                <p>â€¢ ê°™ì€ ì¹´ë“œë¥¼ ì°¾ì•„ ë§ì¶”ì„¸ìš”</p>
                                <p>â€¢ ìŠ¤í…Œì´ì§€ë¥¼ í´ë¦¬ì–´í•˜ë©´ ë‹¤ìŒ ë‹¨ê³„ ì ê¸ˆ í•´ì œ</p>
                                <p>â€¢ íšŒì›ê°€ì…í•˜ë©´ ë°ì´í„°ê°€ ì €ì¥ë©ë‹ˆë‹¤</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Enter í‚¤ ì´ë²¤íŠ¸
            setTimeout(() => {
                if (welcomeMode === 'guest') {
                    const input = document.getElementById('playerNameInput');
                    if (input) {
                        input.focus();
                        input.addEventListener('keypress', (e) => {
                            if (e.key === 'Enter') window.startGameAsGuest();
                        });
                    }
                } else if (welcomeMode === 'login') {
                    const emailInput = document.getElementById('emailInput');
                    const passwordInput = document.getElementById('passwordInput');

                    if (emailInput) {
                        emailInput.focus();
                        emailInput.addEventListener('keypress', (e) => {
                            if (e.key === 'Enter') {
                                if (passwordInput) passwordInput.focus();
                            }
                        });
                    }

                    if (passwordInput) {
                        passwordInput.addEventListener('keypress', (e) => {
                            if (e.key === 'Enter') window.submitLogin();
                        });
                    }
                } else if (welcomeMode === 'signup') {
                    const emailInput = document.getElementById('emailInput');
                    const passwordInput = document.getElementById('passwordInput');
                    const nameInput = document.getElementById('nameInput');

                    if (emailInput) {
                        emailInput.focus();
                        emailInput.addEventListener('keypress', (e) => {
                            if (e.key === 'Enter' && passwordInput) passwordInput.focus();
                        });
                    }

                    if (passwordInput) {
                        passwordInput.addEventListener('keypress', (e) => {
                            if (e.key === 'Enter' && nameInput) nameInput.focus();
                        });
                    }

                    if (nameInput) {
                        nameInput.addEventListener('keypress', (e) => {
                            if (e.key === 'Enter') window.submitSignup();
                        });
                    }
                }
            }, 100);
        };

        const renderStages = () => {
            const stagesHtml = STAGES_DATA.stages.map(stage => {
                const isUnlocked = unlockedStages.includes(stage.id);
                const isCompleted = completedStages.includes(stage.id);

                return `
                    <div class="relative ${isUnlocked ? '' : 'locked'} bg-white rounded-2xl shadow-xl p-8 hover:shadow-2xl transition-all duration-300">
                        ${!isUnlocked ? '<div class="absolute top-4 right-4 text-xs px-3 py-1 bg-gray-400 rounded-full text-white font-bold">LOCK</div>' : ''}
                        ${isCompleted ? '<div class="absolute top-4 right-4 text-xs px-3 py-1 bg-green-500 rounded-full text-white font-bold">CLEAR</div>' : ''}

                        <div class="text-center mb-6">
                            <h2 class="text-3xl font-bold text-gray-800 mb-2">Stage ${stage.id}</h2>
                            <p class="text-xl text-gray-600">${stage.name}</p>
                        </div>

                        <div class="grid grid-cols-4 gap-2 mb-6">
                            ${stage.items.slice(0, 8).map(item => `
                                <div class="aspect-square bg-gray-100 rounded-lg overflow-hidden">
                                    <img src="../assets/img/${item.img}" alt="${item.title}" class="w-full h-full object-cover">
                                </div>
                            `).join('')}
                        </div>

                        <button
                            onclick="window.initializeGame(${stage.id})"
                            class="w-full py-3 px-6 rounded-lg font-bold text-white transition-all duration-300 ${
                                isUnlocked
                                    ? 'bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600'
                                    : 'bg-gray-400 cursor-not-allowed'
                            }"
                            ${!isUnlocked ? 'disabled' : ''}
                        >
                            ${isUnlocked ? 'ê²Œì„ ì‹œì‘' : 'ì ê¸ˆ'}
                        </button>
                    </div>
                `;
            }).join('');

            // Google ë¡œê·¸ì¸ ì•ˆë‚´ (ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ê²½ìš°)
            const googleLoginAlert = !currentUser ? `
                <div class="max-w-3xl mx-auto mb-8">
                    <div class="bg-gradient-to-r from-green-50 to-blue-50 border-2 border-green-200 rounded-xl p-6 shadow-lg">
                        <div class="flex items-start gap-4">
                            <div class="text-4xl">âœ…</div>
                            <div class="flex-1">
                                <h3 class="text-lg font-bold text-green-900 mb-2">ë¡œì»¬ ì €ì¥ì†Œ ëª¨ë“œë¡œ í”Œë ˆì´ ì¤‘</h3>
                                <p class="text-sm text-green-700 mb-2">
                                    í˜„ì¬ ë¸Œë¼ìš°ì €ì— ê²Œì„ ê¸°ë¡ì´ ì €ì¥ë©ë‹ˆë‹¤.<br>
                                    ì´ëŒ€ë¡œ í”Œë ˆì´í•´ë„ ì™„ë²½í•˜ê²Œ ì‘ë™í•©ë‹ˆë‹¤!
                                </p>
                                <p class="text-xs text-gray-600 italic">
                                    ğŸ’¡ íŒ: Google ë¡œê·¸ì¸ì€ ê°œë°œìê°€ Firebaseë¥¼ ì„¤ì •í•˜ë©´ ì‚¬ìš©í•  ìˆ˜ ìˆì–´ìš”.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            ` : '';

            appContainer.innerHTML = `
                ${renderHeader()}
                <div class="min-h-screen p-8">
                    <div class="max-w-7xl mx-auto">
                        <div class="text-center mb-12">
                            <h1 class="text-5xl font-bold text-gray-800 mb-4">K-Everything Memory Game</h1>
                            <div class="flex items-center justify-center gap-2 mb-2">
                                <span class="text-2xl">${playerAvatar}</span>
                                <p class="text-xl text-gray-600">${playerName}</p>
                            </div>
                            <p class="text-lg text-gray-500">í•œêµ­ ë¬¸í™”ì¬ë¶€í„° ìŒì‹, ì˜í™”ê¹Œì§€ ë‹¨ê³„ë³„ë¡œ ë„ì „í•´ë³´ì„¸ìš”</p>
                        </div>

                        ${googleLoginAlert}

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-8">
                            ${stagesHtml}
                        </div>

                        <div class="flex justify-center gap-4">
                            <button
                                onclick="window.goToPage('collection')"
                                class="py-3 px-8 rounded-lg font-bold text-white bg-gradient-to-r from-blue-500 to-indigo-500 hover:from-blue-600 hover:to-indigo-600 transition-all duration-300"
                            >
                                ë‚´ ì»¬ë ‰ì…˜ ë³´ê¸°
                            </button>
                            <button
                                onclick="window.goToPage('ranking')"
                                class="py-3 px-8 rounded-lg font-bold text-white bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-600 hover:to-orange-600 transition-all duration-300"
                            >
                                ë­í‚¹ ë³´ê¸°
                            </button>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderCard = (card) => {
            const isFlipped = flipped.includes(card.id) || matched.includes(card.id);

            return `
                <div
                    class="perspective cursor-pointer"
                    onclick="window.handleCardClick(${card.id})"
                >
                    <div class="relative w-full aspect-square card-transition transform-3d ${isFlipped ? 'flip' : ''}">
                        <!-- ì¹´ë“œ ë’·ë©´ -->
                        <div class="absolute w-full h-full backface-hidden bg-gradient-to-br from-purple-500 to-pink-500 rounded-xl shadow-lg flex items-center justify-center">
                            <div class="text-6xl text-white font-bold">?</div>
                        </div>

                        <!-- ì¹´ë“œ ì•ë©´ -->
                        <div class="absolute w-full h-full backface-hidden flip bg-white rounded-xl shadow-lg overflow-hidden">
                            <img src="../assets/img/${card.img}" alt="${card.title}" class="w-full h-full object-cover">
                        </div>
                    </div>
                </div>
            `;
        };

        const renderGame = () => {
            const stage = STAGES_DATA.stages.find(s => s.id === currentStage);
            const totalPairs = cards.length / 2;
            const matchedPairs = matched.length / 2;

            const cardGrid = cards.map(renderCard).join('');

            let winModal = '';
            if (isWon) {
                const nextStage = currentStage + 1;
                const hasNext = nextStage <= 3;

                winModal = `
                    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div class="bg-white p-8 rounded-2xl shadow-2xl text-center pop-in max-w-md">
                            <h2 class="text-3xl font-bold text-green-600 mb-4">ì™„ë£Œ!</h2>
                            <p class="text-xl text-gray-700 mb-2">ì‹œë„ íšŸìˆ˜: ${moves}íšŒ</p>
                            <p class="text-lg text-gray-600 mb-6">${stage.name} ë‹¨ê³„ë¥¼ í´ë¦¬ì–´í–ˆìŠµë‹ˆë‹¤</p>

                            ${hasNext ? `
                                <button
                                    onclick="window.initializeGame(${nextStage})"
                                    class="w-full mb-3 py-3 px-6 rounded-lg font-bold text-white bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 transition-all duration-300"
                                >
                                    ë‹¤ìŒ ë‹¨ê³„ë¡œ
                                </button>
                            ` : `
                                <p class="text-lg font-bold text-purple-600 mb-4">ëª¨ë“  ë‹¨ê³„ë¥¼ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤!</p>
                            `}

                            <button
                                onclick="window.goToPage('stages')"
                                class="w-full py-3 px-6 rounded-lg font-bold text-gray-700 bg-gray-200 hover:bg-gray-300 transition-all duration-300"
                            >
                                ìŠ¤í…Œì´ì§€ ì„ íƒ
                            </button>
                        </div>
                    </div>
                `;
            }

            appContainer.innerHTML = `
                ${renderHeader()}
                <div class="min-h-screen p-4">
                    <div class="max-w-4xl mx-auto">
                        <!-- í—¤ë” -->
                        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
                            <div class="flex justify-between items-center mb-4">
                                <button
                                    onclick="window.goToPage('stages')"
                                    class="py-2 px-4 rounded-lg font-bold text-gray-700 bg-gray-200 hover:bg-gray-300 transition-all duration-300"
                                >
                                    ëŒì•„ê°€ê¸°
                                </button>

                                <div class="text-center">
                                    <h2 class="text-2xl font-bold text-gray-800">Stage ${currentStage}: ${stage.name}</h2>
                                </div>

                                <button
                                    onclick="window.initializeGame(${currentStage})"
                                    class="py-2 px-4 rounded-lg font-bold text-white bg-gradient-to-r from-red-500 to-pink-500 hover:from-red-600 hover:to-pink-600 transition-all duration-300"
                                >
                                    ë‹¤ì‹œí•˜ê¸°
                                </button>
                            </div>

                            <div class="flex justify-center gap-8 text-center">
                                <div>
                                    <p class="text-sm text-gray-600">ì‹œë„ íšŸìˆ˜</p>
                                    <p class="text-2xl font-bold text-purple-600">${moves}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600">ì§„í–‰ë„</p>
                                    <p class="text-2xl font-bold text-pink-600">${matchedPairs} / ${totalPairs}</p>
                                </div>
                            </div>
                        </div>

                        <!-- ì¹´ë“œ ê·¸ë¦¬ë“œ -->
                        <div class="grid grid-cols-4 gap-4">
                            ${cardGrid}
                        </div>
                    </div>
                </div>

                ${winModal}
            `;
        };

        const renderCollection = () => {
            const allItems = STAGES_DATA.stages.flatMap(stage =>
                stage.items.map(item => ({
                    ...item,
                    stageName: stage.name,
                    stageId: stage.id,
                    isUnlocked: completedStages.includes(stage.id) // ì™„ë£Œí•´ì•¼ë§Œ í•´ì œ
                }))
            );

            const itemsHtml = allItems.map(item => `
                <div class="${item.isUnlocked ? '' : 'locked'} bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition-all duration-300">
                    <div class="aspect-square overflow-hidden">
                        <img src="../assets/img/${item.img}" alt="${item.title}" class="w-full h-full object-cover">
                    </div>
                    <div class="p-4 text-center">
                        <h3 class="font-bold text-lg text-gray-800 mb-1">${item.title}</h3>
                        <p class="text-sm text-gray-600 mb-2">${item.stageName}</p>
                        <p class="text-xs text-gray-500">${item.isUnlocked ? item.desc : 'ìŠ¤í…Œì´ì§€ë¥¼ í´ë¦¬ì–´í•˜ì„¸ìš”'}</p>
                    </div>
                </div>
            `).join('');

            appContainer.innerHTML = `
                ${renderHeader()}
                <div class="min-h-screen p-8">
                    <div class="max-w-7xl mx-auto">
                        <div class="text-center mb-8">
                            <h1 class="text-4xl font-bold text-gray-800 mb-4">ë‚´ ì»¬ë ‰ì…˜</h1>
                            <p class="text-lg text-gray-600">ìŠ¤í…Œì´ì§€ë¥¼ í´ë¦¬ì–´í•˜ë©´ í•´ë‹¹ í•­ëª©ì´ ì ê¸ˆ í•´ì œë©ë‹ˆë‹¤</p>
                        </div>

                        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 mb-8">
                            ${itemsHtml}
                        </div>

                        <div class="text-center">
                            <button
                                onclick="window.goToPage('stages')"
                                class="py-3 px-8 rounded-lg font-bold text-white bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 transition-all duration-300"
                            >
                                ìŠ¤í…Œì´ì§€ ì„ íƒ
                            </button>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderRanking = () => {
            const rankingHtml = rankingData.map((rank, index) => `
                <div class="flex justify-between items-center p-4 ${index < 3 ? 'bg-yellow-50' : 'bg-gray-50'} rounded-lg">
                    <div class="flex items-center gap-4">
                        <span class="text-2xl font-bold ${index === 0 ? 'text-yellow-500' : index === 1 ? 'text-gray-400' : index === 2 ? 'text-orange-600' : 'text-gray-700'}">${index + 1}</span>
                        <div>
                            <p class="font-bold text-gray-800">${rank.name}</p>
                            <p class="text-sm text-gray-600">${rank.stage}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-lg font-bold text-purple-600">${rank.moves}íšŒ</p>
                    </div>
                </div>
            `).join('');

            appContainer.innerHTML = `
                ${renderHeader()}
                <div class="min-h-screen p-8">
                    <div class="max-w-3xl mx-auto">
                        <div class="text-center mb-8">
                            <h1 class="text-4xl font-bold text-gray-800 mb-4">ë­í‚¹</h1>
                            <p class="text-lg text-gray-600">ì‹œë„ íšŸìˆ˜ê°€ ì ì„ìˆ˜ë¡ ë†’ì€ ìˆœìœ„!</p>
                        </div>

                        <div class="bg-white rounded-2xl shadow-xl p-8 mb-8">
                            <div class="space-y-3">
                                ${rankingHtml.length > 0 ? rankingHtml : '<p class="text-center text-gray-500">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</p>'}
                            </div>
                        </div>

                        <div class="text-center">
                            <button
                                onclick="window.goToPage('stages')"
                                class="py-3 px-8 rounded-lg font-bold text-white bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 transition-all duration-300"
                            >
                                ìŠ¤í…Œì´ì§€ ì„ íƒ
                            </button>
                        </div>
                    </div>
                </div>
            `;
        };

        // ===================================
        // ë§ˆìŠ¤í„° ë Œë” í•¨ìˆ˜
        // ===================================
        const render = () => {
            switch (currentPage) {
                case 'welcome':
                    renderWelcome();
                    break;
                case 'stages':
                    renderStages();
                    break;
                case 'game':
                    renderGame();
                    break;
                case 'collection':
                    renderCollection();
                    break;
                case 'ranking':
                    renderRanking();
                    break;
                default:
                    appContainer.innerHTML = '<h1 class="text-center text-red-500 mt-10">í˜ì´ì§€ ì˜¤ë¥˜</h1>';
            }
        };

        // ===================================
        // ì´ˆê¸°í™”
        // ===================================
        async function init() {
            await loadData();

            // Firebase ì¸ì¦ ìƒíƒœ ê°ì§€ (Firebaseê°€ ì´ˆê¸°í™”ëœ ê²½ìš°ì—ë§Œ)
            if (window.firebaseInitialized && window.firebaseAuth) {
                window.onAuthStateChanged(window.firebaseAuth, async (user) => {
                    if (user) {
                        currentUser = user;
                        userProfile = {
                            uid: user.uid,
                            email: user.email,
                            displayName: user.displayName,
                            photoURL: user.photoURL
                        };

                        // Firestoreì—ì„œ ì‚¬ìš©ì ë°ì´í„° ë¡œë“œ
                        await loadUserData();
                    } else {
                        currentUser = null;
                        userProfile = {
                            uid: null,
                            email: null,
                            displayName: null,
                            photoURL: null
                        };
                    }

                    render();
                });
            }

            // í•­ìƒ Welcome í˜ì´ì§€ë¶€í„° ì‹œì‘ (ê°„ë‹¨ ë¡œê·¸ì¸)
            currentPage = 'welcome';
            render();
        }

        // ì „ì—­ í•¨ìˆ˜ë¡œ ë‚´ë³´ë‚´ê¸°
        window.initializeGame = initializeGame;
        window.handleCardClick = handleCardClick;
        window.goToPage = goToPage;
        window.signOutUser = signOutUser;
        window.selectAvatar = (avatar) => {
            playerAvatar = avatar;
            render();
        };

        // Welcome ëª¨ë“œ ì „í™˜
        window.switchMode = (mode) => {
            welcomeMode = mode;
            render();
        };

        // ê²ŒìŠ¤íŠ¸ë¡œ ì‹œì‘
        window.startGameAsGuest = () => {
            const input = document.getElementById('playerNameInput');
            const name = input?.value.trim() || 'ìµëª…';
            setPlayerName(name);
        };

        // íšŒì›ê°€ì…
        window.submitSignup = () => {
            const email = document.getElementById('emailInput')?.value.trim();
            const password = document.getElementById('passwordInput')?.value;
            const name = document.getElementById('nameInput')?.value.trim();

            if (!email || !password || !name) {
                alert('ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (password.length < 6) {
                alert('ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }

            signup(email, password, name, playerAvatar);
        };

        // ë¡œê·¸ì¸
        window.submitLogin = () => {
            const email = document.getElementById('emailInput')?.value.trim();
            const password = document.getElementById('passwordInput')?.value;

            if (!email || !password) {
                alert('ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            login(email, password);
        };

        // ì‹œì‘
        init();
    </script>
</body>
</html>
