<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K-Everything Memory Game</title>
    <link rel="icon" href="../favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration - 여기에 실제 Firebase 프로젝트 설정을 넣어주세요
        const firebaseConfig = {
            apiKey: "AIzaSyDEMOKEY123456789",
            authDomain: "your-project.firebaseapp.com",
            projectId: "your-project-id",
            storageBucket: "your-project.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef123456"
        };

        window.firebaseApp = initializeApp(firebaseConfig);
        window.firebaseAuth = getAuth(window.firebaseApp);
        window.firebaseDb = getFirestore(window.firebaseApp);
        window.GoogleAuthProvider = GoogleAuthProvider;
        window.signInWithPopup = signInWithPopup;
        window.signOut = signOut;
        window.onAuthStateChanged = onAuthStateChanged;
        window.firestoreDoc = doc;
        window.firestoreSetDoc = setDoc;
        window.firestoreGetDoc = getDoc;
        window.firestoreUpdateDoc = updateDoc;
    </script>

    <style>
        /* 카드 플립 애니메이션 */
        .perspective { perspective: 1000px; }
        .transform-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .flip { transform: rotateY(180deg); }
        .card-transition { transition: transform 0.6s; }

        /* 팝업 애니메이션 */
        @keyframes pop {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .pop-in { animation: pop 0.3s ease-out forwards; }

        /* 잠금 효과 */
        .locked { filter: grayscale(100%) brightness(0.6); pointer-events: none; }

        /* 중앙 정렬 */
        .text-center { text-align: center; }

        /* 프로필 드롭다운 */
        .profile-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 0.5rem;
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            min-width: 200px;
            z-index: 50;
        }
        .profile-dropdown.show {
            display: block;
        }
        .profile-image {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s;
        }
        .profile-image:hover {
            transform: scale(1.1);
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50">

    <div id="app" class="min-h-screen">
        <!-- 로딩 화면 -->
        <div class="flex flex-col justify-center items-center h-screen">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-purple-500"></div>
            <p class="mt-4 text-xl text-gray-700">로딩 중...</p>
        </div>
    </div>

    <script type="module">
        // ===================================
        // 전역 상태
        // ===================================
        let STAGES_DATA = null;
        let currentStage = 1;
        let unlockedStages = [1];
        let completedStages = []; // 완료된 스테이지
        let playerName = '';
        let playerNameSet = false;

        // Google 사용자 정보
        let currentUser = null;
        let userProfile = {
            uid: null,
            email: null,
            displayName: null,
            photoURL: null
        };

        // 게임 상태
        let cards = [];
        let flipped = [];
        let matched = [];
        let moves = 0;
        let isWon = false;
        let canClick = true;
        let currentPage = 'welcome'; // welcome, stages, game, collection, ranking

        // 랭킹 데이터 (메모리)
        let rankingData = [
            { name: '김민수', stage: '영화', moves: 18 },
            { name: '이서연', stage: '음식', moves: 22 },
            { name: '박지훈', stage: '영화', moves: 25 },
        ];

        const appContainer = document.getElementById('app');

        // ===================================
        // 데이터 로드
        // ===================================
        async function loadData() {
            try {
                const response = await fetch('../data/stages.json');
                STAGES_DATA = await response.json();

                // 로컬스토리지에서 진행도 불러오기
                const saved = localStorage.getItem('game_progress');
                if (saved) {
                    const progress = JSON.parse(saved);
                    unlockedStages = progress.unlockedStages || [1];
                    completedStages = progress.completedStages || [];
                    currentStage = progress.currentStage || 1;
                    playerName = progress.playerName || '';
                    playerNameSet = progress.playerNameSet || false;
                }

                const savedRanking = localStorage.getItem('ranking_data');
                if (savedRanking) {
                    rankingData = JSON.parse(savedRanking);
                }
            } catch (error) {
                console.error('데이터 로드 실패:', error);
            }
        }

        // ===================================
        // 저장 함수
        // ===================================
        const saveProgress = () => {
            localStorage.setItem('game_progress', JSON.stringify({
                unlockedStages,
                completedStages,
                currentStage,
                playerName,
                playerNameSet
            }));

            // Google 로그인 상태면 Firestore에도 저장
            if (currentUser) {
                saveUserData();
            }
        };

        const saveRanking = () => {
            localStorage.setItem('ranking_data', JSON.stringify(rankingData));
        };

        // ===================================
        // Google 인증 함수
        // ===================================
        const signInWithGoogle = async () => {
            try {
                const provider = new window.GoogleAuthProvider();
                const result = await window.signInWithPopup(window.firebaseAuth, provider);
                currentUser = result.user;
                userProfile = {
                    uid: currentUser.uid,
                    email: currentUser.email,
                    displayName: currentUser.displayName,
                    photoURL: currentUser.photoURL
                };

                // Firestore에서 사용자 데이터 로드
                await loadUserData();

                // 이름이 없으면 Google 이름 사용
                if (!playerName && userProfile.displayName) {
                    playerName = userProfile.displayName;
                    playerNameSet = true;
                    saveProgress();
                }

                render();
            } catch (error) {
                console.error('Google 로그인 실패:', error);
                alert('로그인에 실패했습니다. 다시 시도해주세요.');
            }
        };

        const signOutUser = async () => {
            try {
                await window.signOut(window.firebaseAuth);
                currentUser = null;
                userProfile = {
                    uid: null,
                    email: null,
                    displayName: null,
                    photoURL: null
                };
                render();
            } catch (error) {
                console.error('로그아웃 실패:', error);
            }
        };

        const loadUserData = async () => {
            if (!currentUser) return;

            try {
                const userDoc = window.firestoreDoc(window.firebaseDb, 'users', currentUser.uid);
                const docSnap = await window.firestoreGetDoc(userDoc);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    unlockedStages = data.unlockedStages || [1];
                    completedStages = data.completedStages || [];
                    currentStage = data.currentStage || 1;
                    playerName = data.playerName || userProfile.displayName;
                    playerNameSet = data.playerNameSet || false;
                } else {
                    // 새 사용자 - 초기 데이터 저장
                    await saveUserData();
                }
            } catch (error) {
                console.error('사용자 데이터 로드 실패:', error);
            }
        };

        const saveUserData = async () => {
            if (!currentUser) return;

            try {
                const userDoc = window.firestoreDoc(window.firebaseDb, 'users', currentUser.uid);
                await window.firestoreSetDoc(userDoc, {
                    uid: currentUser.uid,
                    email: currentUser.email,
                    displayName: currentUser.displayName,
                    photoURL: currentUser.photoURL,
                    unlockedStages,
                    completedStages,
                    currentStage,
                    playerName,
                    playerNameSet,
                    lastUpdated: new Date().toISOString()
                }, { merge: true });
            } catch (error) {
                console.error('사용자 데이터 저장 실패:', error);
            }
        };

        // ===================================
        // 유틸리티 함수
        // ===================================
        const shuffleArray = (array) => {
            const arr = [...array];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        };

        const goToPage = (page) => {
            currentPage = page;
            render();
        };

        const setPlayerName = (name) => {
            playerName = name.trim() || '익명';
            playerNameSet = true;
            saveProgress();
            goToPage('stages');
        };

        // ===================================
        // 게임 로직
        // ===================================
        const initializeGame = (stageId) => {
            currentStage = stageId;
            const stage = STAGES_DATA.stages.find(s => s.id === stageId);
            if (!stage) return;

            const items = stage.items;
            const pairs = [...items, ...items].map((item, index) => ({
                ...item,
                id: index,
                pairId: item.idx
            }));

            cards = shuffleArray(pairs);
            flipped = [];
            matched = [];
            moves = 0;
            isWon = false;
            canClick = true;

            currentPage = 'game';
            renderGame();
        };

        const handleCardClick = (cardId) => {
            if (!canClick || flipped.length === 2 || flipped.includes(cardId) || matched.includes(cardId) || isWon) {
                return;
            }

            flipped.push(cardId);
            renderGame();

            if (flipped.length === 2) {
                canClick = false;
                moves++;
                renderGame();

                const [firstId, secondId] = flipped;
                const card1 = cards.find(c => c.id === firstId);
                const card2 = cards.find(c => c.id === secondId);

                if (card1 && card2 && card1.pairId === card2.pairId) {
                    matched.push(firstId, secondId);
                    flipped = [];
                    canClick = true;

                    if (matched.length === cards.length) {
                        isWon = true;

                        // 현재 스테이지 완료 처리
                        if (!completedStages.includes(currentStage)) {
                            completedStages.push(currentStage);
                        }

                        // 다음 스테이지 잠금 해제
                        if (currentStage < 3 && !unlockedStages.includes(currentStage + 1)) {
                            unlockedStages.push(currentStage + 1);
                        }

                        // 랭킹에 추가
                        const stage = STAGES_DATA.stages.find(s => s.id === currentStage);
                        rankingData.push({
                            name: playerName,
                            stage: stage.name,
                            moves: moves
                        });
                        rankingData.sort((a, b) => a.moves - b.moves);
                        if (rankingData.length > 20) rankingData = rankingData.slice(0, 20);

                        saveProgress();
                        saveRanking();
                    }
                    renderGame();
                } else {
                    setTimeout(() => {
                        flipped = [];
                        canClick = true;
                        renderGame();
                    }, 1000);
                }
            }
        };

        // ===================================
        // 렌더링 함수
        // ===================================
        const renderHeader = () => {
            if (!currentUser) {
                return `
                    <div class="fixed top-4 right-4 z-50">
                        <button
                            onclick="window.signInWithGoogle()"
                            class="flex items-center gap-2 px-4 py-2 bg-white rounded-full shadow-lg hover:shadow-xl transition-all duration-300"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="24px" height="24px">
                                <path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/>
                                <path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/>
                                <path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"/>
                                <path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"/>
                            </svg>
                            <span class="font-bold text-gray-700">Google 로그인</span>
                        </button>
                    </div>
                `;
            }

            return `
                <div class="fixed top-4 right-4 z-50">
                    <div class="relative">
                        <img
                            src="${userProfile.photoURL || 'https://via.placeholder.com/40'}"
                            alt="Profile"
                            class="profile-image"
                            onclick="window.toggleProfileDropdown()"
                        />
                        <div id="profileDropdown" class="profile-dropdown">
                            <div class="p-4 border-b border-gray-100">
                                <p class="font-bold text-gray-800">${userProfile.displayName || 'Unknown User'}</p>
                                <p class="text-sm text-gray-500">${userProfile.email || ''}</p>
                            </div>
                            <div class="p-2">
                                <button
                                    onclick="window.signOutUser()"
                                    class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 rounded-md transition-colors"
                                >
                                    로그아웃
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        window.toggleProfileDropdown = () => {
            const dropdown = document.getElementById('profileDropdown');
            if (dropdown) {
                dropdown.classList.toggle('show');
            }
        };

        // 드롭다운 외부 클릭시 닫기
        document.addEventListener('click', (e) => {
            const dropdown = document.getElementById('profileDropdown');
            const profileImage = document.querySelector('.profile-image');
            if (dropdown && profileImage && !profileImage.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.classList.remove('show');
            }
        });

        const renderWelcome = () => {
            appContainer.innerHTML = `
                ${renderHeader()}
                <div class="min-h-screen flex items-center justify-center p-8">
                    <div class="bg-white rounded-3xl shadow-2xl p-12 max-w-md w-full text-center">
                        <h1 class="text-4xl font-bold text-gray-800 mb-6">K-Everything<br/>Memory Game</h1>
                        <p class="text-gray-600 mb-8">한국 문화재, 음식, 영화를 배우는<br/>재미있는 카드 게임</p>

                        <div class="mb-6">
                            <label class="block text-left text-sm font-bold text-gray-700 mb-2">플레이어 이름</label>
                            <input
                                type="text"
                                id="playerNameInput"
                                placeholder="이름을 입력하세요"
                                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none text-center text-lg"
                                maxlength="10"
                            />
                        </div>

                        <button
                            onclick="window.startGameWithName()"
                            class="w-full py-4 px-6 rounded-lg font-bold text-white bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 transition-all duration-300 text-lg"
                        >
                            게임 시작
                        </button>
                    </div>
                </div>
            `;

            // Enter 키로도 시작 가능
            setTimeout(() => {
                const input = document.getElementById('playerNameInput');
                if (input) {
                    input.focus();
                    input.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            window.startGameWithName();
                        }
                    });
                }
            }, 100);
        };

        const renderStages = () => {
            const stagesHtml = STAGES_DATA.stages.map(stage => {
                const isUnlocked = unlockedStages.includes(stage.id);
                const isCompleted = completedStages.includes(stage.id);

                return `
                    <div class="relative ${isUnlocked ? '' : 'locked'} bg-white rounded-2xl shadow-xl p-8 hover:shadow-2xl transition-all duration-300">
                        ${!isUnlocked ? '<div class="absolute top-4 right-4 text-xs px-3 py-1 bg-gray-400 rounded-full text-white font-bold">LOCK</div>' : ''}
                        ${isCompleted ? '<div class="absolute top-4 right-4 text-xs px-3 py-1 bg-green-500 rounded-full text-white font-bold">CLEAR</div>' : ''}

                        <div class="text-center mb-6">
                            <h2 class="text-3xl font-bold text-gray-800 mb-2">Stage ${stage.id}</h2>
                            <p class="text-xl text-gray-600">${stage.name}</p>
                        </div>

                        <div class="grid grid-cols-4 gap-2 mb-6">
                            ${stage.items.slice(0, 8).map(item => `
                                <div class="aspect-square bg-gray-100 rounded-lg overflow-hidden">
                                    <img src="../assets/img/${item.img}" alt="${item.title}" class="w-full h-full object-cover">
                                </div>
                            `).join('')}
                        </div>

                        <button
                            onclick="window.initializeGame(${stage.id})"
                            class="w-full py-3 px-6 rounded-lg font-bold text-white transition-all duration-300 ${
                                isUnlocked
                                    ? 'bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600'
                                    : 'bg-gray-400 cursor-not-allowed'
                            }"
                            ${!isUnlocked ? 'disabled' : ''}
                        >
                            ${isUnlocked ? '게임 시작' : '잠금'}
                        </button>
                    </div>
                `;
            }).join('');

            appContainer.innerHTML = `
                ${renderHeader()}
                <div class="min-h-screen p-8">
                    <div class="max-w-7xl mx-auto">
                        <div class="text-center mb-12">
                            <h1 class="text-5xl font-bold text-gray-800 mb-4">K-Everything Memory Game</h1>
                            <p class="text-xl text-gray-600 mb-2">플레이어: ${playerName}</p>
                            <p class="text-lg text-gray-500">한국 문화재부터 음식, 영화까지 단계별로 도전해보세요</p>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-8">
                            ${stagesHtml}
                        </div>

                        <div class="flex justify-center gap-4">
                            <button
                                onclick="window.goToPage('collection')"
                                class="py-3 px-8 rounded-lg font-bold text-white bg-gradient-to-r from-blue-500 to-indigo-500 hover:from-blue-600 hover:to-indigo-600 transition-all duration-300"
                            >
                                내 컬렉션 보기
                            </button>
                            <button
                                onclick="window.goToPage('ranking')"
                                class="py-3 px-8 rounded-lg font-bold text-white bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-600 hover:to-orange-600 transition-all duration-300"
                            >
                                랭킹 보기
                            </button>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderCard = (card) => {
            const isFlipped = flipped.includes(card.id) || matched.includes(card.id);

            return `
                <div
                    class="perspective cursor-pointer"
                    onclick="window.handleCardClick(${card.id})"
                >
                    <div class="relative w-full aspect-square card-transition transform-3d ${isFlipped ? 'flip' : ''}">
                        <!-- 카드 뒷면 -->
                        <div class="absolute w-full h-full backface-hidden bg-gradient-to-br from-purple-500 to-pink-500 rounded-xl shadow-lg flex items-center justify-center">
                            <div class="text-6xl text-white font-bold">?</div>
                        </div>

                        <!-- 카드 앞면 -->
                        <div class="absolute w-full h-full backface-hidden flip bg-white rounded-xl shadow-lg overflow-hidden">
                            <img src="../assets/img/${card.img}" alt="${card.title}" class="w-full h-full object-cover">
                        </div>
                    </div>
                </div>
            `;
        };

        const renderGame = () => {
            const stage = STAGES_DATA.stages.find(s => s.id === currentStage);
            const totalPairs = cards.length / 2;
            const matchedPairs = matched.length / 2;

            const cardGrid = cards.map(renderCard).join('');

            let winModal = '';
            if (isWon) {
                const nextStage = currentStage + 1;
                const hasNext = nextStage <= 3;

                winModal = `
                    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div class="bg-white p-8 rounded-2xl shadow-2xl text-center pop-in max-w-md">
                            <h2 class="text-3xl font-bold text-green-600 mb-4">완료!</h2>
                            <p class="text-xl text-gray-700 mb-2">시도 횟수: ${moves}회</p>
                            <p class="text-lg text-gray-600 mb-6">${stage.name} 단계를 클리어했습니다</p>

                            ${hasNext ? `
                                <button
                                    onclick="window.initializeGame(${nextStage})"
                                    class="w-full mb-3 py-3 px-6 rounded-lg font-bold text-white bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 transition-all duration-300"
                                >
                                    다음 단계로
                                </button>
                            ` : `
                                <p class="text-lg font-bold text-purple-600 mb-4">모든 단계를 완료했습니다!</p>
                            `}

                            <button
                                onclick="window.goToPage('stages')"
                                class="w-full py-3 px-6 rounded-lg font-bold text-gray-700 bg-gray-200 hover:bg-gray-300 transition-all duration-300"
                            >
                                스테이지 선택
                            </button>
                        </div>
                    </div>
                `;
            }

            appContainer.innerHTML = `
                ${renderHeader()}
                <div class="min-h-screen p-4">
                    <div class="max-w-4xl mx-auto">
                        <!-- 헤더 -->
                        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
                            <div class="flex justify-between items-center mb-4">
                                <button
                                    onclick="window.goToPage('stages')"
                                    class="py-2 px-4 rounded-lg font-bold text-gray-700 bg-gray-200 hover:bg-gray-300 transition-all duration-300"
                                >
                                    돌아가기
                                </button>

                                <div class="text-center">
                                    <h2 class="text-2xl font-bold text-gray-800">Stage ${currentStage}: ${stage.name}</h2>
                                </div>

                                <button
                                    onclick="window.initializeGame(${currentStage})"
                                    class="py-2 px-4 rounded-lg font-bold text-white bg-gradient-to-r from-red-500 to-pink-500 hover:from-red-600 hover:to-pink-600 transition-all duration-300"
                                >
                                    다시하기
                                </button>
                            </div>

                            <div class="flex justify-center gap-8 text-center">
                                <div>
                                    <p class="text-sm text-gray-600">시도 횟수</p>
                                    <p class="text-2xl font-bold text-purple-600">${moves}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600">진행도</p>
                                    <p class="text-2xl font-bold text-pink-600">${matchedPairs} / ${totalPairs}</p>
                                </div>
                            </div>
                        </div>

                        <!-- 카드 그리드 -->
                        <div class="grid grid-cols-4 gap-4">
                            ${cardGrid}
                        </div>
                    </div>
                </div>

                ${winModal}
            `;
        };

        const renderCollection = () => {
            const allItems = STAGES_DATA.stages.flatMap(stage =>
                stage.items.map(item => ({
                    ...item,
                    stageName: stage.name,
                    stageId: stage.id,
                    isUnlocked: completedStages.includes(stage.id) // 완료해야만 해제
                }))
            );

            const itemsHtml = allItems.map(item => `
                <div class="${item.isUnlocked ? '' : 'locked'} bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition-all duration-300">
                    <div class="aspect-square overflow-hidden">
                        <img src="../assets/img/${item.img}" alt="${item.title}" class="w-full h-full object-cover">
                    </div>
                    <div class="p-4 text-center">
                        <h3 class="font-bold text-lg text-gray-800 mb-1">${item.title}</h3>
                        <p class="text-sm text-gray-600 mb-2">${item.stageName}</p>
                        <p class="text-xs text-gray-500">${item.isUnlocked ? item.desc : '스테이지를 클리어하세요'}</p>
                    </div>
                </div>
            `).join('');

            appContainer.innerHTML = `
                ${renderHeader()}
                <div class="min-h-screen p-8">
                    <div class="max-w-7xl mx-auto">
                        <div class="text-center mb-8">
                            <h1 class="text-4xl font-bold text-gray-800 mb-4">내 컬렉션</h1>
                            <p class="text-lg text-gray-600">스테이지를 클리어하면 해당 항목이 잠금 해제됩니다</p>
                        </div>

                        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 mb-8">
                            ${itemsHtml}
                        </div>

                        <div class="text-center">
                            <button
                                onclick="window.goToPage('stages')"
                                class="py-3 px-8 rounded-lg font-bold text-white bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 transition-all duration-300"
                            >
                                스테이지 선택
                            </button>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderRanking = () => {
            const rankingHtml = rankingData.map((rank, index) => `
                <div class="flex justify-between items-center p-4 ${index < 3 ? 'bg-yellow-50' : 'bg-gray-50'} rounded-lg">
                    <div class="flex items-center gap-4">
                        <span class="text-2xl font-bold ${index === 0 ? 'text-yellow-500' : index === 1 ? 'text-gray-400' : index === 2 ? 'text-orange-600' : 'text-gray-700'}">${index + 1}</span>
                        <div>
                            <p class="font-bold text-gray-800">${rank.name}</p>
                            <p class="text-sm text-gray-600">${rank.stage}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-lg font-bold text-purple-600">${rank.moves}회</p>
                    </div>
                </div>
            `).join('');

            appContainer.innerHTML = `
                ${renderHeader()}
                <div class="min-h-screen p-8">
                    <div class="max-w-3xl mx-auto">
                        <div class="text-center mb-8">
                            <h1 class="text-4xl font-bold text-gray-800 mb-4">랭킹</h1>
                            <p class="text-lg text-gray-600">시도 횟수가 적을수록 높은 순위!</p>
                        </div>

                        <div class="bg-white rounded-2xl shadow-xl p-8 mb-8">
                            <div class="space-y-3">
                                ${rankingHtml.length > 0 ? rankingHtml : '<p class="text-center text-gray-500">아직 기록이 없습니다</p>'}
                            </div>
                        </div>

                        <div class="text-center">
                            <button
                                onclick="window.goToPage('stages')"
                                class="py-3 px-8 rounded-lg font-bold text-white bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 transition-all duration-300"
                            >
                                스테이지 선택
                            </button>
                        </div>
                    </div>
                </div>
            `;
        };

        // ===================================
        // 마스터 렌더 함수
        // ===================================
        const render = () => {
            switch (currentPage) {
                case 'welcome':
                    renderWelcome();
                    break;
                case 'stages':
                    renderStages();
                    break;
                case 'game':
                    renderGame();
                    break;
                case 'collection':
                    renderCollection();
                    break;
                case 'ranking':
                    renderRanking();
                    break;
                default:
                    appContainer.innerHTML = '<h1 class="text-center text-red-500 mt-10">페이지 오류</h1>';
            }
        };

        // ===================================
        // 초기화
        // ===================================
        async function init() {
            await loadData();

            // Firebase 인증 상태 감지
            window.onAuthStateChanged(window.firebaseAuth, async (user) => {
                if (user) {
                    currentUser = user;
                    userProfile = {
                        uid: user.uid,
                        email: user.email,
                        displayName: user.displayName,
                        photoURL: user.photoURL
                    };

                    // Firestore에서 사용자 데이터 로드
                    await loadUserData();
                } else {
                    currentUser = null;
                    userProfile = {
                        uid: null,
                        email: null,
                        displayName: null,
                        photoURL: null
                    };
                }

                render();
            });

            // 이름이 설정되어 있으면 스테이지로, 아니면 환영 페이지로
            if (playerNameSet && playerName) {
                currentPage = 'stages';
            } else {
                currentPage = 'welcome';
            }

            render();
        }

        // 전역 함수로 내보내기
        window.initializeGame = initializeGame;
        window.handleCardClick = handleCardClick;
        window.goToPage = goToPage;
        window.signInWithGoogle = signInWithGoogle;
        window.signOutUser = signOutUser;
        window.startGameWithName = () => {
            const input = document.getElementById('playerNameInput');
            const name = input?.value.trim() || '익명';
            setPlayerName(name);
        };

        // 시작
        init();
    </script>
</body>
</html>
