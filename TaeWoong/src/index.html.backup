<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K-Movie Memory Master</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom CSS for Card Flip Effect */
        .perspective {
            perspective: 1000px;
        }
        .transform-style-preserve-3d {
            transform-style: preserve-3d;
        }
        .backface-hidden {
            backface-visibility: hidden;
        }
        .rotate-y-180 {
            transform: rotateY(180deg);
        }
        .card-inner {
            transition: transform 0.5s;
        }
        @keyframes pop-in {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-pop-in {
            animation: pop-in 0.3s ease-out forwards;
        }
        .card-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
    </style>
    <!-- Lucide Icons -->
    <script type="module">
        import { createIcons, icons } from 'https://cdn.jsdelivr.net/npm/lucide@latest/dist/esm/lucide.js';
        window.addEventListener('load', () => {
            createIcons({ icons });
        });
        window.icons = icons;
        window.createIcons = createIcons;
    </script>
</head>
<body class="min-h-screen font-sans bg-gradient-to-br from-purple-50 via-pink-50 to-blue-50" id="body-container">

    <div id="app" class="min-h-screen">
        <!-- Loading State -->
        <div class="flex flex-col justify-center items-center h-screen">
            <svg data-lucide="loader-2" class="animate-spin text-indigo-500 w-12 h-12"></svg>
            <p class="ml-4 mt-4 text-xl text-gray-700">K-Movie ë°ì´í„° ë¡œë”© ì¤‘...</p>
        </div>
    </div>

    <!-- Application Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, orderBy, limit, onSnapshot, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'kmovie-memory-game';

        let app, db, auth;
        let currentUserId = null;
        let isAuthReady = false;

        // --- Korean Movie Data ---
        let K_MOVIE_ITEMS = [];
        let CARD_PAIRS;
        let totalPairs;

        // --- Game State ---
        let cards = [];
        let flipped = [];
        let matched = [];
        let moves = 0;
        let isWon = false;
        let canClick = true;
        let currentPage = 'game';

        const appContainer = document.getElementById('app');

        // --- Load Movie Data ---
        async function loadMovieData() {
            try {
                const response = await fetch('../data/korean-movies.json');
                const data = await response.json();
                K_MOVIE_ITEMS = data.movies.map(movie => ({
                    name: movie.title,
                    icon: movie.icon,
                    desc: movie.desc,
                    img: movie.img,
                    genre: movie.genre,
                    director: movie.director,
                    actor: movie.actor
                }));
            } catch (error) {
                console.error('Failed to load movie data:', error);
                // Fallback data
                K_MOVIE_ITEMS = [
                    { name: 'ê¸°ìƒì¶©', icon: 'ğŸ¬', desc: 'ê³„ê¸‰ ê°„ì˜ ëŒ€ë¦½ê³¼ ì‚¬íšŒì  ê²©ì°¨ë¥¼ ë‹¤ë£¬ ì‘í’ˆ.', img: 'ê¸°ìƒì¶©.jpg' },
                    { name: 'ì˜¬ë“œë³´ì´', icon: 'ğŸ”¨', desc: '15ë…„ê°„ì˜ ê°ê¸ˆê³¼ ë³µìˆ˜ë¥¼ ê·¸ë¦° ìŠ¤ë¦´ëŸ¬.', img: 'ì˜¬ë“œë³´ì´.jpg' },
                    { name: 'ë¶€ì‚°í–‰', icon: 'ğŸ§Ÿ', desc: 'ì¢€ë¹„ ë°”ì´ëŸ¬ìŠ¤ë¡œë¶€í„° ì‚´ì•„ë‚¨ê¸° ìœ„í•œ ì‚¬íˆ¬.', img: 'ë¶€ì‚°í–‰.jpg' },
                    { name: 'ëª…ëŸ‰', icon: 'âš”ï¸', desc: 'ì´ìˆœì‹  ì¥êµ°ì˜ ëª…ëŸ‰ëŒ€ì²©ì„ ë‹¤ë£¬ ì—­ì‚¬ê·¹.', img: 'ëª…ëŸ‰.jpg' },
                ];
            }
        }

        // --- Utility Functions ---
        const shuffleArray = (array) => {
            let currentIndex = array.length, randomIndex;
            while (currentIndex !== 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
            }
            return array;
        };

        const goToPage = (pageName) => {
            currentPage = pageName;
            render();
            if (window.createIcons && window.icons) {
                window.createIcons({ icons: window.icons });
            }
        };

        // --- Game Logic ---
        const initializeCardData = () => {
            CARD_PAIRS = [...K_MOVIE_ITEMS, ...K_MOVIE_ITEMS].map((item, index) => ({
                ...item,
                id: index,
            }));
            totalPairs = CARD_PAIRS.length / 2;
        }

        const initializeGame = () => {
            initializeCardData();
            cards = shuffleArray([...CARD_PAIRS]);
            flipped = [];
            matched = [];
            moves = 0;
            isWon = false;
            canClick = true;
            renderGame();
        };

        const checkWinCondition = () => {
            if (matched.length > 0 && matched.length === cards.length) {
                isWon = true;
                submitScore(moves);
                renderGame();
            }
        };

        const submitScore = async (finalMoves) => {
            if (!db || !currentUserId) {
                console.error("Database or User ID not ready.");
                return;
            }

            const rankingCollectionPath = `artifacts/${appId}/public/data/kmovie_ranking`;
            try {
                await addDoc(collection(db, rankingCollectionPath), {
                    playerUid: currentUserId,
                    moves: finalMoves,
                    timestamp: serverTimestamp(),
                });
                console.log("Score submitted successfully:", finalMoves);
            } catch (error) {
                console.error("Error submitting score:", error);
            }
        };

        const handleCardClick = (cardId) => {
            if (!canClick || flipped.length === 2 || flipped.includes(cardId) || matched.includes(cardId) || isWon) {
                return;
            }

            flipped.push(cardId);
            renderGame();

            if (flipped.length === 2) {
                canClick = false;
                moves++;
                renderGame();

                const [firstId, secondId] = flipped;
                const item1 = cards.find(c => c.id === firstId);
                const item2 = cards.find(c => c.id === secondId);

                if (item1 && item2 && item1.name === item2.name) {
                    matched.push(firstId, secondId);
                    flipped = [];
                    canClick = true;
                    checkWinCondition();
                    renderGame();
                } else {
                    setTimeout(() => {
                        flipped = [];
                        canClick = true;
                        renderGame();
                    }, 1000);
                }
            }
        };

        // --- Render Functions ---
        const renderNavButton = (icon, label, page) => \`
            <button
                onclick="window.goToPage('\${page}')"
                class="flex items-center space-x-2 bg-gradient-to-r from-purple-500 to-indigo-600 text-white font-semibold py-2 px-4 rounded-full shadow-lg hover:shadow-xl hover:scale-105 transition duration-300 text-sm"
            >
                <svg data-lucide="\${icon}" class="w-5 h-5"></svg>
                <span>\${label}</span>
            </button>
        \`;

        const renderCard = (card) => {
            const isFlipped = flipped.includes(card.id) || matched.includes(card.id);
            const isMatched = matched.includes(card.id);
            const cursorClass = isMatched ? 'cursor-default' : 'cursor-pointer';

            return \`
                <div
                    id="card-\${card.id}"
                    class="aspect-square perspective \${cursorClass}"
                    onclick="window.handleCardClick(\${card.id})"
                >
                    <div class="relative w-full h-full card-inner transform-style-preserve-3d
                        \${isFlipped ? 'rotate-y-180' : ''}"
                    >
                        <!-- Card Back -->
                        <div class="absolute backface-hidden w-full h-full bg-gradient-to-br from-indigo-500 to-purple-600 rounded-lg shadow-xl border-4 border-indigo-700 flex items-center justify-center">
                            <svg data-lucide="film" class="w-12 h-12 text-yellow-300 animate-pulse"></svg>
                        </div>

                        <!-- Card Front -->
                        <div class="absolute backface-hidden w-full h-full bg-white rounded-lg shadow-xl border-4 border-green-400 flex flex-col items-center justify-center p-2 rotate-y-180">
                            <img src="../data/img/\${card.img}" alt="\${card.name}" class="card-image rounded-lg mb-1" />
                            <span class="text-xs md:text-sm font-bold text-gray-800 text-center">\${card.name}</span>
                        </div>
                    </div>
                </div>
            \`;
        };

        const renderGame = () => {
            const cardGrid = cards.map(renderCard).join('');

            let winModal = '';
            if (isWon) {
                winModal = \`
                    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div class="bg-white p-8 rounded-2xl shadow-2xl text-center animate-pop-in max-w-md">
                            <h2 class="text-3xl font-extrabold text-green-600 mb-4">ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤! ğŸ‰</h2>
                            <p class="text-lg text-gray-700 mb-6">ë‹¹ì‹ ì€ <strong>\${moves}ë²ˆ</strong> ë§Œì— ëª¨ë“  K-Movie ì¹´ë“œë¥¼ ë§ì·„ìŠµë‹ˆë‹¤!</p>
                            <button
                                onclick="window.goToPage('leaderboard')"
                                class="bg-gradient-to-r from-indigo-500 to-purple-600 hover:shadow-xl text-white font-bold py-3 px-6 rounded-full shadow-lg transition duration-300 text-lg"
                            >
                                <svg data-lucide="trophy" class="inline w-5 h-5 mr-2"></svg> ë­í‚¹ í™•ì¸
                            </button>
                        </div>
                    </div>
                \`;
            }

            appContainer.innerHTML = \`
                <div class="p-4 flex flex-col items-center min-h-screen">
                    <h1 class="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-pink-600 my-6 tracking-tight">
                        <svg data-lucide="film" class="inline w-8 h-8 mr-2 text-indigo-600"></svg>
                        K-Movie Memory Master
                    </h1>

                    <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-2xl mb-6">
                        <div class="flex justify-between items-center mb-4 border-b pb-3">
                            <div class="flex flex-col items-start">
                                <span class="text-xl font-bold text-gray-700">ì‹œë„ íšŸìˆ˜: <span class="text-indigo-500">\${moves}</span></span>
                                <span class="text-sm text-gray-500 mt-1">ë‚¨ì€ ìŒ: \${totalPairs - (matched.length / 2)} / \${totalPairs}</span>
                            </div>
                            <button
                                onclick="window.initializeGame()"
                                class="bg-gradient-to-r from-red-500 to-pink-600 hover:shadow-xl text-white font-bold py-2 px-4 rounded-full shadow-lg transition duration-300 flex items-center"
                            >
                                <svg data-lucide="rotate-ccw" class="w-4 h-4 mr-1"></svg> ì¬ì‹œì‘
                            </button>
                        </div>

                        <div class="grid grid-cols-4 gap-3 md:gap-4">
                            \${cardGrid}
                        </div>
                    </div>

                    \${winModal}

                    <!-- Navigation Buttons -->
                    <div class="mt-6 flex flex-wrap justify-center gap-3">
                        \${renderNavButton('library', 'ì˜í™” ë„ê°', 'collection')}
                        \${renderNavButton('graduation-cap', 'AI í•™ìŠµ', 'ai-learning')}
                        \${renderNavButton('trophy', 'ë­í‚¹', 'leaderboard')}
                    </div>
                </div>
            \`;
            if (window.createIcons && window.icons) {
                window.createIcons({ icons: window.icons });
            }
        };

        const renderCollection = () => {
            const cardList = K_MOVIE_ITEMS.map((item, index) => \`
                <div key=\${index} class="bg-white p-4 rounded-xl shadow-lg border-2 border-yellow-400 hover:shadow-2xl transition duration-300">
                    <img src="../data/img/\${item.img}" alt="\${item.name}" class="w-full h-40 object-cover rounded-lg mb-2" />
                    <h3 class="text-lg font-bold text-gray-800 mb-1">\${item.icon} \${item.name}</h3>
                    <p class="text-xs text-gray-500 mb-2">ì¥ë¥´: \${item.genre} | ê°ë…: \${item.director}</p>
                    <p class="text-sm text-gray-600">\${item.desc}</p>
                </div>
            \`).join('');

            appContainer.innerHTML = \`
                <div class="p-6 min-h-screen">
                    <h1 class="text-3xl font-bold text-yellow-700 mb-6 border-b pb-3">ğŸ“š K-Movie ì˜í™” ë„ê°</h1>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                        \${cardList}
                    </div>
                    <button
                        onclick="window.goToPage('game')"
                        class="mt-8 bg-gradient-to-r from-indigo-500 to-purple-600 hover:shadow-xl text-white font-bold py-3 px-6 rounded-full shadow-lg transition duration-300 flex items-center mx-auto"
                    >
                        <svg data-lucide="home" class="w-5 h-5 mr-2"></svg> ê²Œì„ìœ¼ë¡œ ëŒì•„ê°€ê¸°
                    </button>
                </div>
            \`;
            if (window.createIcons && window.icons) {
                window.createIcons({ icons: window.icons });
            }
        };

        // --- AI Learning ---
        let currentQuiz = null;
        let aiFeedback = null;
        let isProcessing = false;

        const generateQuiz = () => {
            isProcessing = true;
            aiFeedback = null;
            renderAILearning();

            setTimeout(() => {
                const item = K_MOVIE_ITEMS[Math.floor(Math.random() * K_MOVIE_ITEMS.length)];
                currentQuiz = {
                    question: \`ë‹¤ìŒ ì„¤ëª…ì´ ë‚˜íƒ€ë‚´ëŠ” í•œêµ­ ì˜í™”ëŠ” ë¬´ì—‡ì¼ê¹Œìš”? "\${item.desc}"\`,
                    correctAnswer: item.name,
                    item: item,
                };
                isProcessing = false;
                if (document.getElementById('ai-answer')) {
                    document.getElementById('ai-answer').value = '';
                }
                renderAILearning();
            }, 1500);
        };

        const handleSubmit = () => {
            const userAnswer = document.getElementById('ai-answer').value.trim();
            if (!currentQuiz || isProcessing || userAnswer === '') return;

            isProcessing = true;
            renderAILearning();

            const isCorrect = userAnswer.toLowerCase() === currentQuiz.correctAnswer.toLowerCase();

            setTimeout(() => {
                if (isCorrect) {
                    aiFeedback = {
                        type: 'correct',
                        message: \`âœ… ì •ë‹µ! \${currentQuiz.item.icon} "\${currentQuiz.item.name}"ì— ëŒ€í•´ ì™„ë²½í•˜ê²Œ ì´í•´í•˜ì…¨êµ°ìš”!\\nê°ë…: \${currentQuiz.item.director}\\nì¶œì—°: \${currentQuiz.item.actor}\`
                    };
                } else {
                    aiFeedback = {
                        type: 'incorrect',
                        message: \`âŒ ì•„ì‰½ì§€ë§Œ í‹€ë ¸ì–´ìš”. ì •ë‹µì€ "\${currentQuiz.item.name}"ì…ë‹ˆë‹¤.\\n\${currentQuiz.item.desc}\`
                    };
                }
                isProcessing = false;
                renderAILearning();
            }, 1000);
        };

        const renderAILearning = () => {
            const currentAnswerValue = document.getElementById('ai-answer')?.value || '';

            const quizContent = currentQuiz ? \`
                <div class="p-4 bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg border-l-4 border-indigo-400">
                    <p class="text-md text-gray-700 font-semibold">\${currentQuiz.question}</p>
                </div>
                <input
                    type="text"
                    id="ai-answer"
                    value="\${currentAnswerValue}"
                    oninput="this.setAttribute('value', this.value)"
                    class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500"
                    placeholder="ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ê¸°ìƒì¶©)"
                />
                <button
                    onclick="window.handleSubmit()"
                    class="w-full bg-gradient-to-r from-green-500 to-emerald-600 hover:shadow-xl text-white font-bold py-3 rounded-lg shadow-md transition duration-300 flex items-center justify-center \${isProcessing ? 'opacity-50 cursor-not-allowed' : ''}"
                    \${isProcessing ? 'disabled' : ''}
                >
                    <svg data-lucide="check" class="w-5 h-5 mr-2"></svg> ì •ë‹µ í™•ì¸
                </button>
            \` : '';

            const feedbackContent = aiFeedback ? \`
                <div class="p-4 rounded-lg font-semibold whitespace-pre-line \${aiFeedback.type === 'correct' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                    \${aiFeedback.message}
                </div>
            \` : '';

            appContainer.innerHTML = \`
                <div class="p-6 min-h-screen">
                    <h1 class="text-3xl font-bold text-blue-700 mb-6 border-b pb-3 flex items-center">
                        <svg data-lucide="graduation-cap" class="w-6 h-6 mr-2"></svg> AI ê¸°ë°˜ í•™ìŠµ ì„¼í„°
                    </h1>

                    <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-xl mx-auto space-y-4">
                        <p class="text-lg font-semibold text-gray-800">
                            <span class="text-indigo-500 font-extrabold">ğŸ“ K-Movie Quiz:</span> ì˜í™”ì— ëŒ€í•œ í€´ì¦ˆë¥¼ í’€ì–´ë³¼ê¹Œìš”?
                        </p>

                        \${isProcessing && !currentQuiz ?
                            \`<div class="text-center text-indigo-500"><svg data-lucide="loader-2" class="animate-spin inline mr-2 w-6 h-6"></svg> í€´ì¦ˆ ìƒì„± ì¤‘...</div>\`
                            : ''
                        }

                        \${!isProcessing || currentQuiz ? quizContent : ''}

                        \${feedbackContent}

                        <button
                            onclick="window.generateQuiz()"
                            class="w-full mt-4 bg-gradient-to-r from-yellow-500 to-orange-600 hover:shadow-xl text-white font-bold py-3 rounded-lg shadow-md transition duration-300 \${isProcessing ? 'opacity-50 cursor-not-allowed' : ''}"
                            \${isProcessing ? 'disabled' : ''}
                        >
                            <svg data-lucide="refresh-cw" class="inline w-5 h-5 mr-2"></svg> ë‹¤ìŒ ë¬¸ì œ í’€ê¸°
                        </button>
                    </div>

                    <button
                        onclick="window.goToPage('game')"
                        class="mt-8 bg-gradient-to-r from-indigo-500 to-purple-600 hover:shadow-xl text-white font-bold py-3 px-6 rounded-full shadow-lg transition duration-300 flex items-center mx-auto"
                    >
                        <svg data-lucide="home" class="w-5 h-5 mr-2"></svg> ê²Œì„ìœ¼ë¡œ ëŒì•„ê°€ê¸°
                    </button>
                </div>
            \`;
            if (window.createIcons && window.icons) {
                window.createIcons({ icons: window.icons });
            }
        };

        // --- Leaderboard ---
        const renderLeaderboard = (rankings, isLoading) => {
            let rankingContent = '';
            if (isLoading) {
                rankingContent = \`<div class="p-4 flex justify-center items-center"><svg data-lucide="loader-2" class="animate-spin text-blue-500 w-6 h-6"></svg></div>\`;
            } else if (rankings.length === 0) {
                rankingContent = \`<p class="text-center text-gray-500">ì•„ì§ ë­í‚¹ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ìŠ¹ë¦¬ìê°€ ë˜ì–´ë³´ì„¸ìš”!</p>\`;
            } else {
                rankingContent = rankings.map((rank, index) => \`
                    <div
                        class="flex justify-between items-center p-3 rounded-lg \${
                            rank.playerUid === currentUserId ? 'bg-yellow-100 font-extrabold shadow-md' : 'bg-gray-50'
                        }"
                    >
                        <span class="text-xl font-bold \${index === 0 ? 'text-yellow-600' : 'text-gray-700'}">\${index + 1}.</span>
                        <span class="flex-1 ml-4 truncate text-sm">
                            \${rank.playerUid === currentUserId ? 'ğŸ† ë‚˜ (You)' : \`ID: \${rank.playerUid.substring(0, 8)}...\`}
                        </span>
                        <span class="text-lg font-mono text-indigo-600">\${rank.moves} Moves</span>
                    </div>
                \`).join('');
            }

            appContainer.innerHTML = \`
                <div class="p-6 min-h-screen">
                    <h1 class="text-3xl font-bold text-purple-700 mb-6 border-b pb-3 flex items-center justify-center">
                        <svg data-lucide="trophy" class="w-6 h-6 mr-2"></svg> ëª…ì˜ˆì˜ ì „ë‹¹
                    </h1>

                    <div class="p-4 bg-white rounded-xl shadow-2xl w-full max-w-lg mx-auto">
                        <h2 class="text-2xl font-bold mb-4 text-center text-indigo-700 border-b pb-2">ğŸ† Top 10 (ìµœì†Œ ì‹œë„)</h2>
                        <div class="space-y-2">
                            \${rankingContent}
                        </div>
                        <div class="mt-4 text-xs text-gray-400 truncate">
                            ë‹¹ì‹ ì˜ ìœ ì € ID: \${currentUserId || 'ë¡œë”© ì¤‘...'}
                        </div>
                    </div>

                    <button
                        onclick="window.goToPage('game')"
                        class="mt-8 bg-gradient-to-r from-indigo-500 to-purple-600 hover:shadow-xl text-white font-bold py-3 px-6 rounded-full shadow-lg transition duration-300 flex items-center mx-auto"
                    >
                        <svg data-lucide="home" class="w-5 h-5 mr-2"></svg> ê²Œì„ìœ¼ë¡œ ëŒì•„ê°€ê¸°
                    </button>
                </div>
            \`;
            if (window.createIcons && window.icons) {
                window.createIcons({ icons: window.icons });
            }
        };

        const setupLeaderboardListener = () => {
            if (!db) return;
            const rankingCollectionPath = `artifacts/${appId}/public/data/kmovie_ranking`;

            const q = query(
                collection(db, rankingCollectionPath),
                orderBy("moves", "asc"),
                orderBy("timestamp", "asc"),
                limit(10)
            );

            onSnapshot(q, (snapshot) => {
                const newRankings = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                if (currentPage === 'leaderboard') {
                    renderLeaderboard(newRankings, false);
                }
            }, (error) => {
                console.error("Error fetching rankings: ", error);
                if (currentPage === 'leaderboard') {
                    renderLeaderboard([], false);
                }
            });
        };

        // --- Master Render ---
        const render = () => {
            if (!isAuthReady) {
                return;
            }

            switch (currentPage) {
                case 'game':
                    renderGame();
                    break;
                case 'collection':
                    renderCollection();
                    break;
                case 'ai-learning':
                    renderAILearning();
                    if (!currentQuiz && !isProcessing) {
                        generateQuiz();
                    }
                    break;
                case 'leaderboard':
                    renderLeaderboard([], true);
                    setupLeaderboardListener();
                    break;
                default:
                    appContainer.innerHTML = '<h1 class="text-red-500 text-center mt-10">í˜ì´ì§€ ì˜¤ë¥˜</h1>';
            }
        };

        // --- Firebase Initialization ---
        async function initFirebase() {
            await loadMovieData();

            if (!firebaseConfig) {
                console.warn("Firebase config missing. Running in non-persistent mode.");
                currentUserId = crypto.randomUUID();
                isAuthReady = true;
                initializeGame();
                render();
                return;
            }

            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUserId = user.uid;
                } else {
                    currentUserId = crypto.randomUUID();
                }
                isAuthReady = true;
                initializeGame();
                render();
                if (window.createIcons && window.icons) {
                    window.createIcons({ icons: window.icons });
                }
            });

            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase Sign-In Error:", error);
            }
        }

        // Export to global scope
        window.handleCardClick = handleCardClick;
        window.initializeGame = initializeGame;
        window.goToPage = goToPage;
        window.generateQuiz = generateQuiz;
        window.handleSubmit = handleSubmit;

        // Initialize
        window.onload = initFirebase;

    </script>
</body>
</html>
